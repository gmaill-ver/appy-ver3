<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å­¦ç¿’ãƒˆãƒ©ãƒƒã‚«ãƒ¼ - è¡Œæ”¿æ›¸å£«è©¦é¨“å¯¾ç­–</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        :root {
            --primary: #6b46c1;
            --primary-light: #9061f9;
            --secondary: #ec4899;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #1f2937;
            --gray: #6b7280;
            --light: #f3f4f6;
            --lighter: #f9fafb;
            --white: #ffffff;
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', 'Noto Sans CJK JP', sans-serif;
            background: var(--lighter);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .app-header {
            background: linear-gradient(135deg, rgba(107, 70, 193, 0.95) 0%, rgba(236, 72, 153, 0.95) 100%);
            backdrop-filter: blur(10px);
            padding: 20px;
            text-align: center;
            color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .app-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 5px;
        }
        
        .app-logo-icon {
            font-size: 24px;
        }
        
        .app-title {
            font-size: 22px;
            font-weight: 700;
        }
        
        .app-subtitle {
            font-size: 14px;
            opacity: 0.9;
        }
        
        /* ãƒ¡ã‚¤ãƒ³ã‚¿ãƒ–ï¼ˆ3ã¤ï¼‰ */
        .main-tabs {
            display: flex;
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .main-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            border: none;
            background: white;
            color: var(--gray);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .main-tab.active {
            color: var(--primary);
        }
        
        .main-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary);
        }
        
        /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ */
        .content-area {
            flex: 1;
            padding: 15px;
            padding-bottom: 80px;
            overflow-y: auto;
        }
        
        /* ã‚«ãƒ¼ãƒ‰ */
        .card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: var(--shadow);
        }
        
        .card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--light);
        }
        
        .card-icon {
            font-size: 20px;
        }
        
        .card-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--dark);
        }
        
        /* ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ */
        .accordion {
            margin-bottom: 10px;
        }
        
        .accordion-header {
            background: white;
            border: 1px solid var(--light);
            border-radius: 10px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .accordion-header:hover {
            background: var(--light);
        }
        
        .accordion-header.active {
            border-radius: 10px 10px 0 0;
            background: linear-gradient(135deg, var(--primary-light), var(--secondary));
            color: white;
        }
        
        .accordion-content {
            display: none;
            background: white;
            border: 1px solid var(--light);
            border-top: none;
            border-radius: 0 0 10px 10px;
            padding: 15px;
        }
        
        .accordion-content.active {
            display: block;
        }
        
        .accordion-arrow {
            transition: transform 0.3s;
        }
        
        .accordion-header.active .accordion-arrow {
            transform: rotate(180deg);
        }
        
        /* å®Ÿç¸¾ãƒãƒƒã‚¸ */
        .achievement-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }
        
        .achievement-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            background: white;
            border-radius: 15px;
            box-shadow: var(--shadow);
            transition: all 0.3s;
        }
        
        .achievement-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }
        
        .achievement-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }
        
        .achievement-label {
            font-size: 14px;
            color: var(--gray);
            text-align: center;
            margin-bottom: 5px;
        }
        
        .achievement-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--dark);
        }
        
        .achievement-badge-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .badge-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px;
            background: var(--light);
            border-radius: 12px;
            opacity: 0.5;
            transition: all 0.3s;
        }
        
        .badge-card.unlocked {
            opacity: 1;
            background: white;
            box-shadow: var(--shadow);
        }
        
        .badge-icon {
            font-size: 36px;
            margin-bottom: 8px;
            filter: grayscale(100%);
        }
        
        .badge-card.unlocked .badge-icon {
            filter: grayscale(0);
        }
        
        .badge-label {
            font-size: 12px;
            color: var(--gray);
            text-align: center;
        }
        
        /* å•é¡Œé›†é¸æŠ */
        .select-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--light);
            border-radius: 10px;
            font-size: 15px;
            background: white;
        }
        
        /* ç§‘ç›®é¸æŠãƒœã‚¿ãƒ³ */
        .subject-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 15px 0;
        }
        
        .subject-btn {
            padding: 15px;
            border: 1px solid var(--light);
            border-radius: 10px;
            background: white;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .subject-btn:hover {
            background: var(--light);
        }
        
        .subject-btn.selected {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-color: var(--primary);
        }
        
        /* ãƒ‘ãƒ³ããšãƒªã‚¹ãƒˆæ”¹å–„ */
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 10px;
            background: var(--light);
            border-radius: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            font-size: 13px;
        }
        
        .breadcrumb-item {
            color: var(--gray);
            cursor: pointer;
            white-space: nowrap;
        }
        
        .breadcrumb-item:hover {
            color: var(--primary);
        }
        
        .breadcrumb-item.active {
            color: var(--primary);
            font-weight: 600;
        }
        
        .breadcrumb-separator {
            color: var(--gray);
        }
        
        /* å•é¡Œç•ªå·ã‚°ãƒªãƒƒãƒ‰ï¼ˆãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ï¼‰ */
        .heatmap-container {
            background: white;
            border-radius: 10px;
            padding: 15px;
        }
        
        .heatmap-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .heatmap-btn {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--light);
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .heatmap-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .heatmap-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(25px, 1fr));
            gap: 2px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .heatmap-section-label {
            grid-column: 1 / -1;
            font-size: 10px;
            color: var(--gray);
            padding: 5px 0;
            border-top: 1px solid var(--light);
            margin-top: 5px;
        }
        
        .heatmap-cell {
            aspect-ratio: 1;
            background: var(--light);
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .heatmap-cell.correct {
            background: var(--success);
            color: white;
        }
        
        .heatmap-cell.wrong {
            background: var(--danger);
            color: white;
        }
        
        .heatmap-cell.bookmarked {
            background: var(--warning);
            color: white;
        }
        
        /* é€±é–“/æœˆé–“ã‚°ãƒ©ãƒ• */
        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 15px;
        }
        
        .chart-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .chart-btn {
            padding: 8px 15px;
            border: 1px solid var(--light);
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .chart-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .chart-bars {
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            height: 150px;
            padding: 10px 0;
        }
        
        .chart-bar {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        
        .bar {
            width: 100%;
            max-width: 30px;
            background: linear-gradient(to top, var(--primary), var(--primary-light));
            border-radius: 3px 3px 0 0;
            transition: all 0.3s;
            position: relative;
        }
        
        .bar.today {
            background: linear-gradient(to top, var(--secondary), var(--warning));
        }
        
        .bar-value {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            font-weight: 600;
        }
        
        .bar-label {
            font-size: 11px;
            color: var(--gray);
        }
        
        /* çµ±è¨ˆã‚°ãƒªãƒƒãƒ‰ï¼ˆ2åˆ—ï¼‰ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 15px 0;
        }
        
        .stat-card {
            padding: 15px;
            background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 3px;
        }
        
        .stat-label {
            font-size: 12px;
            color: var(--gray);
        }
        
        /* é€²æ—ãƒãƒ¼ */
        .progress-bar-container {
            height: 12px;
            background: var(--light);
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success), #34d399);
            border-radius: 10px;
            transition: width 0.5s ease;
        }
        
        /* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ */
        .action-buttons {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }
        
        .action-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-weight: 700;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            font-size: 13px;
            transition: all 0.3s;
        }
        
        .action-btn.correct {
            background: var(--success);
        }
        
        .action-btn.wrong {
            background: var(--danger);
        }
        
        .action-btn.bookmark {
            background: var(--warning);
        }
        
        .action-btn.bookmark.active {
            background: linear-gradient(135deg, var(--warning), var(--secondary));
            box-shadow: 0 0 10px rgba(245, 158, 11, 0.5);
        }
        
        /* å•é¡Œã‚°ãƒªãƒƒãƒ‰ */
        .question-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(35px, 1fr));
            gap: 5px;
            padding: 10px;
            background: var(--light);
            border-radius: 10px;
            max-height: 250px;
            overflow-y: auto;
        }
        
        .question-cell {
            aspect-ratio: 1;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .question-cell.correct {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }
        
        .question-cell.wrong {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
        }
        
        .question-cell.bookmarked::after {
            content: 'â˜…';
            position: absolute;
            top: -3px;
            right: -3px;
            font-size: 10px;
            color: var(--warning);
        }
        
        /* ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 15px 0;
        }
        
        .page-btn {
            padding: 8px 12px;
            border: 1px solid var(--light);
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .page-btn:hover {
            background: var(--light);
        }
        
        .page-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* ãƒ•ã‚©ãƒ¼ãƒ  */
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 5px;
        }
        
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--light);
            border-radius: 8px;
            font-size: 14px;
        }
        
        /* ãƒ•ãƒƒã‚¿ãƒ¼ã‚¿ãƒ– */
        .footer-tabs {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            display: flex;
            padding: 5px 0;
            z-index: 100;
        }
        
        .footer-tab {
            flex: 1;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            border: none;
            background: none;
            color: var(--gray);
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .footer-tab.active {
            color: var(--primary);
        }
        
        .footer-tab-icon {
            font-size: 20px;
        }
        
        .footer-tab-label {
            font-size: 11px;
        }
        
        /* ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* ä¿å­˜ãƒœã‚¿ãƒ³ */
        .save-button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .save-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(107, 70, 193, 0.3);
        }
        
        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
        }
        
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 25px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-close {
            width: 30px;
            height: 30px;
            border: none;
            background: var(--light);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="app-header">
        <div class="app-logo">
            <span class="app-logo-icon">ğŸ“š</span>
            <span class="app-title">å­¦ç¿’ãƒˆãƒ©ãƒƒã‚«ãƒ¼</span>
        </div>
        <div class="app-subtitle">è¡Œæ”¿æ›¸å£«è©¦é¨“å¯¾ç­– v1.0</div>
    </header>
    
    <!-- ãƒ¡ã‚¤ãƒ³ã‚¿ãƒ–ï¼ˆ3ã¤ï¼‰ -->
    <div class="main-tabs">
        <button class="main-tab active" onclick="switchMainTab('record', event)">è¨˜éŒ²å…¥åŠ›</button>
        <button class="main-tab" onclick="switchMainTab('analysis', event)">åˆ†æ</button>
        <button class="main-tab" onclick="switchMainTab('progress', event)">é€²æ—</button>
    </div>
    
    <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ -->
    <div class="content-area">
        <!-- è¨˜éŒ²å…¥åŠ›ã‚¿ãƒ– -->
        <div id="record-tab" class="tab-content active">
            <!-- å•é¡Œé›†é¸æŠ -->
            <div class="card">
                <div class="card-header">
                    <span class="card-icon">ğŸ“–</span>
                    <span class="card-title">å•é¡Œé›†é¸æŠ</span>
                </div>
                <select class="select-input" id="bookSelect" onchange="loadBookStructure()">
                    <option value="">é¸æŠã—ã¦ãã ã•ã„...</option>
                </select>
                
                <!-- ãƒ‘ãƒ³ããšãƒªã‚¹ãƒˆ -->
                <div class="breadcrumb" id="breadcrumb" style="display: none;"></div>
            </div>
            
            <!-- ç§‘ç›®é¸æŠ -->
            <div class="card" id="hierarchySection" style="display: none;">
                <div class="card-header">
                    <span class="card-icon">ğŸ“‚</span>
                    <span class="card-title" id="hierarchyTitle">ç§‘ç›®é¸æŠ</span>
                </div>
                <div class="subject-buttons" id="hierarchyList"></div>
            </div>
            
            <!-- å•é¡Œå…¥åŠ› -->
            <div class="card" id="questionSection" style="display: none;">
                <div class="card-header">
                    <span class="card-icon">âœï¸</span>
                    <span class="card-title">å•é¡Œåˆ¥æ­£èª¤å…¥åŠ›</span>
                </div>
                
                <div class="action-buttons">
                    <button class="action-btn correct" onclick="markCorrect()">
                        <span>â­•</span>
                        <span>æ­£è§£</span>
                    </button>
                    <button class="action-btn wrong" onclick="markWrong()">
                        <span>âŒ</span>
                        <span>ä¸æ­£è§£</span>
                    </button>
                    <button class="action-btn bookmark" id="bookmarkBtn" onclick="toggleBookmarkMode()">
                        <span>â­</span>
                        <span>ãƒãƒ¼ã‚¯</span>
                    </button>
                </div>
                
                <div class="question-grid" id="questionGrid"></div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalCount">0</div>
                        <div class="stat-label">è§£ç­”æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="correctCount">0</div>
                        <div class="stat-label">æ­£è§£æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="wrongCount">0</div>
                        <div class="stat-label">ä¸æ­£è§£æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="correctRate">0%</div>
                        <div class="stat-label">æ­£ç­”ç‡</div>
                    </div>
                </div>
                
                <button class="save-button" onclick="saveRecord()">å­¦ç¿’è¨˜éŒ²ã‚’ä¿å­˜</button>
            </div>
        </div>
        
        <!-- åˆ†æã‚¿ãƒ– -->
        <div id="analysis-tab" class="tab-content">
            <!-- å­¦ç¿’ã‚°ãƒ©ãƒ• -->
            <div class="accordion">
                <div class="accordion-header" onclick="toggleAccordion(this)">
                    <span>ğŸ“Š å­¦ç¿’ã‚°ãƒ©ãƒ•</span>
                    <span class="accordion-arrow">â–¼</span>
                </div>
                <div class="accordion-content">
                    <div class="chart-controls">
                        <button class="chart-btn active" onclick="switchChartView('week', this)">é€±é–“</button>
                        <button class="chart-btn" onclick="switchChartView('month', this)">æœˆé–“</button>
                    </div>
                    <div class="chart-bars" id="chartBars"></div>
                </div>
            </div>
            
            <!-- ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ— -->
            <div class="accordion">
                <div class="accordion-header" onclick="toggleAccordion(this)">
                    <span>ğŸ—ºï¸ å•é¡Œãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—</span>
                    <span class="accordion-arrow">â–¼</span>
                </div>
                <div class="accordion-content">
                    <div class="heatmap-controls">
                        <button class="heatmap-btn active" onclick="switchHeatmap('wrong', this)">ä¸æ­£è§£</button>
                        <button class="heatmap-btn" onclick="switchHeatmap('bookmark', this)">ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯</button>
                    </div>
                    <div class="heatmap-grid" id="heatmapGrid"></div>
                </div>
            </div>
            
            <!-- å¾©ç¿’ -->
            <div class="accordion">
                <div class="accordion-header" onclick="toggleAccordion(this)">
                    <span>ğŸ”„ å¾©ç¿’</span>
                    <span class="accordion-arrow">â–¼</span>
                </div>
                <div class="accordion-content">
                    <div id="reviewContent"></div>
                </div>
            </div>
            
            <!-- å¼±ç‚¹åˆ†æ -->
            <div class="accordion">
                <div class="accordion-header" onclick="toggleAccordion(this)">
                    <span>ğŸ¯ å¼±ç‚¹åˆ†æ</span>
                    <span class="accordion-arrow">â–¼</span>
                </div>
                <div class="accordion-content">
                    <div id="weaknessAnalysis"></div>
                </div>
            </div>
        </div>
        
        <!-- é€²æ—ã‚¿ãƒ– -->
        <div id="progress-tab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <span class="card-icon">ğŸ“Š</span>
                    <span class="card-title">å…¨ä½“é€²æ—çŠ¶æ³</span>
                </div>
                <div id="overallProgress"></div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <span class="card-icon">ğŸ“š</span>
                    <span class="card-title">ç§‘ç›®åˆ¥é€²æ—</span>
                </div>
                <div id="subjectProgress"></div>
            </div>
        </div>
    </div>
    
    <!-- ãƒ•ãƒƒã‚¿ãƒ¼ã‚¿ãƒ– -->
    <div class="footer-tabs">
        <button class="footer-tab active" onclick="switchFooterTab('register', event)">
            <span class="footer-tab-icon">ğŸ“</span>
            <span class="footer-tab-label">ç™»éŒ²</span>
        </button>
        <button class="footer-tab" onclick="switchFooterTab('history', event)">
            <span class="footer-tab-icon">ğŸ“…</span>
            <span class="footer-tab-label">å±¥æ­´</span>
        </button>
        <button class="footer-tab" onclick="switchFooterTab('results', event)">
            <span class="footer-tab-icon">ğŸ†</span>
            <span class="footer-tab-label">å®Ÿç¸¾</span>
        </button>
        <button class="footer-tab" onclick="switchFooterTab('settings', event)">
            <span class="footer-tab-icon">âš™ï¸</span>
            <span class="footer-tab-label">è¨­å®š</span>
        </button>
    </div>
    
    <!-- ãƒ•ãƒƒã‚¿ãƒ¼ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºï¼‰ -->
    <div id="footerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">ã‚¿ã‚¤ãƒˆãƒ«</h3>
                <button class="modal-close" onclick="closeFooterModal()">Ã—</button>
            </div>
            <div id="modalBody"></div>
        </div>
    </div>
    
    <!-- éšå±¤æ§‹é€ ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="structureModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>éšå±¤æ§‹é€ ã‚’ç·¨é›†</h3>
                <button class="modal-close" onclick="closeModal('structureModal')">Ã—</button>
            </div>
            
            <div class="form-group">
                <label class="form-label">éšå±¤ãƒ¬ãƒ™ãƒ«</label>
                <select class="form-control" id="hierarchyLevel" onchange="updateHierarchyForm()">
                    <option value="subject">ç§‘ç›®</option>
                    <option value="chapter">ç« </option>
                    <option value="section">ç¯€</option>
                    <option value="subsection">é …</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">åç§°</label>
                <input type="text" class="form-control" id="hierarchyName" placeholder="ä¾‹: æ°‘æ³•">
            </div>
            
            <div class="form-group" id="parentSelectGroup" style="display: none;">
                <label class="form-label">è¦ªéšå±¤</label>
                <select class="form-control" id="parentHierarchy">
                    <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                </select>
            </div>
            
            <div class="form-group" id="questionCountGroup" style="display: none;">
                <label class="form-label">å•é¡Œæ•°</label>
                <input type="number" class="form-control" id="questionCount" min="1" placeholder="ä¾‹: 50">
            </div>
            
            <button class="save-button" onclick="saveHierarchy()">ä¿å­˜</button>
        </div>
    </div>
    
    <script>
        // ãƒ‡ãƒ¼ã‚¿æ§‹é€ 
        let books = {};
        let currentBook = null;
        let currentPath = [];
        let questionStates = {};
        let allRecords = [];
        let bookmarkMode = false;
        let currentChartView = 'week';
        let currentHeatmapView = 'wrong';
        let currentReviewPage = { wrong: 1, bookmark: 1 };
        const ITEMS_PER_PAGE = 10;
        
        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadBooksFromStorage();
            initializeSampleData();
            updateBookSelect();
            loadAllRecords();
            loadQuestionStates();
            updateChartBars();
            updateHeatmap();
        });
        
        // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿
        function initializeSampleData() {
            if (Object.keys(books).length === 0) {
                const sampleBook = {
                    id: 'sample-2024',
                    name: 'åˆæ ¼é©å‘½ è‚¢åˆ¥éå»å•é›† 2024å¹´ç‰ˆ',
                    examType: 'gyousei',
                    structure: {
                        'æ°‘æ³•': {
                            type: 'subject',
                            children: {
                                'ç·å‰‡': {
                                    type: 'chapter',
                                    children: {
                                        'åŸºæœ¬åŸå‰‡': {
                                            type: 'section',
                                            questions: generateQuestionNumbers(1, 20)
                                        }
                                    }
                                }
                            }
                        },
                        'è¡Œæ”¿æ³•': {
                            type: 'subject',
                            children: {
                                'ç·è«–': {
                                    type: 'chapter',
                                    children: {
                                        'è¡Œæ”¿ä¸»ä½“': {
                                            type: 'section',
                                            questions: generateQuestionNumbers(21, 35)
                                        }
                                    }
                                }
                            }
                        }
                    },
                    createdAt: new Date().toISOString()
                };
                
                books[sampleBook.id] = sampleBook;
                saveBooksToStorage();
            }
        }
        
        // å•é¡Œç•ªå·ç”Ÿæˆ
        function generateQuestionNumbers(start, end) {
            const questions = [];
            for (let i = start; i <= end; i++) {
                questions.push(i);
            }
            return questions;
        }
        
        // LocalStorageæ“ä½œ
        function loadBooksFromStorage() {
            const stored = localStorage.getItem('studyTrackerBooks');
            if (stored) {
                books = JSON.parse(stored);
            }
        }
        
        function saveBooksToStorage() {
            localStorage.setItem('studyTrackerBooks', JSON.stringify(books));
        }
        
        function loadAllRecords() {
            const history = localStorage.getItem('studyHistory');
            if (history) {
                allRecords = JSON.parse(history);
            }
        }
        
        function loadQuestionStates() {
            const saved = localStorage.getItem('currentQuestionStates');
            if (saved) {
                const data = JSON.parse(saved);
                if (data.bookId === currentBook?.id && 
                    JSON.stringify(data.path) === JSON.stringify(currentPath.map(p => p.name))) {
                    questionStates = data.states;
                    applyQuestionStates();
                }
            }
        }
        
        function saveQuestionStates() {
            if (currentBook && Object.keys(questionStates).length > 0) {
                const data = {
                    bookId: currentBook.id,
                    path: currentPath.map(p => p.name),
                    states: questionStates
                };
                localStorage.setItem('currentQuestionStates', JSON.stringify(data));
            }
        }
        
        function applyQuestionStates() {
            Object.entries(questionStates).forEach(([num, state]) => {
                const cell = document.querySelector(`[data-number="${num}"]`);
                if (cell) {
                    if (state.state === 'correct') {
                        cell.classList.add('correct');
                    } else if (state.state === 'wrong') {
                        cell.classList.add('wrong');
                    }
                    if (state.bookmarked) {
                        cell.classList.add('bookmarked');
                    }
                }
            });
            updateStats();
        }
        
        // ãƒ¡ã‚¤ãƒ³ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function switchMainTab(tabName, event) {
            document.querySelectorAll('.main-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName + '-tab').classList.add('active');
            
            if (tabName === 'analysis') {
                updateChartBars();
                updateHeatmap();
                updateReviewContent();
                updateWeaknessAnalysis();
            } else if (tabName === 'progress') {
                updateProgressContent();
            }
        }
        
        // ãƒ•ãƒƒã‚¿ãƒ¼ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function switchFooterTab(tabName, event) {
            const modal = document.getElementById('footerModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            
            const titles = {
                'register': 'ğŸ“ å•é¡Œé›†ç™»éŒ²',
                'history': 'ğŸ“… å­¦ç¿’å±¥æ­´',
                'results': 'ğŸ† å®Ÿç¸¾ãƒ»ãƒãƒƒã‚¸',
                'settings': 'âš™ï¸ è¨­å®š'
            };
            
            modalTitle.textContent = titles[tabName];
            
            switch(tabName) {
                case 'register':
                    modalBody.innerHTML = getRegisterContent();
                    break;
                case 'history':
                    modalBody.innerHTML = getHistoryContent();
                    break;
                case 'results':
                    modalBody.innerHTML = getResultsContent();
                    break;
                case 'settings':
                    modalBody.innerHTML = getSettingsContent();
                    break;
            }
            
            modal.classList.add('active');
        }
        
        function closeFooterModal() {
            document.getElementById('footerModal').classList.remove('active');
        }
        
        // å„ãƒ•ãƒƒã‚¿ãƒ¼ã‚³ãƒ³ãƒ†ãƒ³ãƒ„
        function getRegisterContent() {
            let html = `
                <div class="card">
                    <input type="text" class="select-input" placeholder="å•é¡Œé›†å" id="newBookName">
                    <select class="select-input" style="margin-top: 10px;" id="newExamType">
                        <option value="">è©¦é¨“ç¨®åˆ¥ã‚’é¸æŠ</option>
                        <option value="gyousei">è¡Œæ”¿æ›¸å£«</option>
                        <option value="takken">å®…å»ºå£«</option>
                    </select>
                    <button class="save-button" style="margin-top: 15px;" onclick="createNewBook()">ç™»éŒ²</button>
                </div>
                <div class="card">
                    <h4>ç™»éŒ²æ¸ˆã¿å•é¡Œé›†</h4>
            `;
            
            Object.values(books).forEach(book => {
                html += `
                    <div style="padding: 10px; border-bottom: 1px solid var(--light);">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: 600;">${book.name}</div>
                                <div style="font-size: 12px; color: var(--gray);">${Object.keys(book.structure).length}ç§‘ç›®</div>
                            </div>
                            <button onclick="editBook('${book.id}')" style="padding: 5px 10px; background: var(--primary); color: white; border: none; border-radius: 5px; cursor: pointer;">ç·¨é›†</button>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            return html;
        }
        
        function getHistoryContent() {
            let html = '<div class="card">';
            
            allRecords.slice(-20).reverse().forEach(record => {
                const date = new Date(record.timestamp);
                html += `
                    <div style="padding: 10px; border-bottom: 1px solid var(--light);">
                        <div style="font-weight: 600;">${record.path.join(' â€º ')}</div>
                        <div style="font-size: 12px; color: var(--gray);">
                            ${date.toLocaleDateString('ja-JP')} ${date.toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'})}
                            | æ­£ç­”ç‡: ${record.stats.rate}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            return html;
        }
        
        function getResultsContent() {
            const stats = calculateOverallProgress();
            const streakDays = localStorage.getItem('streakDays') || '0';
            
            // ãƒãƒƒã‚¸åˆ¤å®š
            const badges = [
                { icon: 'ğŸ¯', label: 'åˆå­¦ç¿’', unlocked: allRecords.length > 0 },
                { icon: 'ğŸ“š', label: '100å•é”æˆ', unlocked: stats.totalAnswered >= 100 },
                { icon: 'ğŸ”¥', label: '7æ—¥é€£ç¶š', unlocked: parseInt(streakDays) >= 7 },
                { icon: 'â­', label: 'æ­£ç­”ç‡90%', unlocked: stats.overallRate >= 90 },
                { icon: 'ğŸ†', label: '1000å•é”æˆ', unlocked: stats.totalAnswered >= 1000 },
                { icon: 'ğŸš€', label: 'å…¨ç§‘ç›®åˆ¶è¦‡', unlocked: Object.keys(calculateSubjectStats()).length >= 4 },
                { icon: 'ğŸ¯', label: '30æ—¥ç¶™ç¶š', unlocked: parseInt(streakDays) >= 30 },
                { icon: 'ğŸ‘‘', label: 'ãƒã‚¹ã‚¿ãƒ¼', unlocked: stats.totalAnswered >= 5000 }
            ];
            
            let html = `
                <div class="card">
                    <h4 style="margin-bottom: 15px;">ğŸ† å®Ÿç¸¾ãƒ»ãƒãƒƒã‚¸</h4>
                    <p style="text-align: center; color: var(--gray); margin-bottom: 20px;">ç²å¾—ã—ãŸæˆæœ</p>
                </div>
                
                <div class="achievement-grid">
                    <div class="achievement-card">
                        <div class="achievement-icon">ğŸ¯</div>
                        <div class="achievement-label">åˆå­¦ç¿’</div>
                        <div class="achievement-value">${allRecords.length > 0 ? 'é”æˆ' : 'æœªé”æˆ'}</div>
                    </div>
                    <div class="achievement-card">
                        <div class="achievement-icon">ğŸ“š</div>
                        <div class="achievement-label">100å•é”æˆ</div>
                        <div class="achievement-value">${stats.totalAnswered}å•</div>
                    </div>
                    <div class="achievement-card">
                        <div class="achievement-icon">ğŸ”¥</div>
                        <div class="achievement-label">7æ—¥é€£ç¶š</div>
                        <div class="achievement-value">${streakDays}æ—¥</div>
                    </div>
                    <div class="achievement-card">
                        <div class="achievement-icon">â­</div>
                        <div class="achievement-label">æ­£ç­”ç‡90%</div>
                        <div class="achievement-value">${stats.overallRate}%</div>
                    </div>
                </div>
                
                <div class="card" style="margin-top: 20px;">
                    <h4 style="margin-bottom: 15px;">ç²å¾—ãƒãƒƒã‚¸</h4>
                    <div class="achievement-badge-grid">
            `;
            
            badges.forEach(badge => {
                html += `
                    <div class="badge-card ${badge.unlocked ? 'unlocked' : ''}">
                        <div class="badge-icon">${badge.icon}</div>
                        <div class="badge-label">${badge.label}</div>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
            
            return html;
        }
        
        function getSettingsContent() {
            return `
                <div class="card">
                    <h4>ğŸ“– ä½¿ã„æ–¹</h4>
                    <ol style="margin-left: 20px; line-height: 1.8;">
                        <li>ã€Œç™»éŒ²ã€ã‹ã‚‰å•é¡Œé›†ã‚’ç™»éŒ²</li>
                        <li>ã€Œè¨˜éŒ²å…¥åŠ›ã€ã§å•é¡Œã‚’è§£ã„ãŸçµæœã‚’è¨˜éŒ²</li>
                        <li>ã€Œåˆ†æã€ã§å­¦ç¿’çŠ¶æ³ã‚’ç¢ºèª</li>
                        <li>ã€Œé€²æ—ã€ã§å…¨ä½“ã®é€²ã¿å…·åˆã‚’æŠŠæ¡</li>
                        <li>é–“é•ãˆãŸå•é¡Œã¯ã€Œå¾©ç¿’ã€æ©Ÿèƒ½ã§é›†ä¸­å­¦ç¿’</li>
                    </ol>
                </div>
                <div class="card">
                    <button class="save-button" style="background: var(--danger);" onclick="clearAllData()">ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤</button>
                </div>
            `;
        }
        
        // ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³
        function toggleAccordion(header) {
            header.classList.toggle('active');
            const content = header.nextElementSibling;
            content.classList.toggle('active');
        }
        
        // ãƒãƒ£ãƒ¼ãƒˆåˆ‡ã‚Šæ›¿ãˆ
        function switchChartView(view, btn) {
            currentChartView = view;
            document.querySelectorAll('.chart-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            updateChartBars();
        }
        
        // ãƒãƒ£ãƒ¼ãƒˆæ›´æ–°
        function updateChartBars() {
            const container = document.getElementById('chartBars');
            if (!container) return;
            
            const today = new Date();
            const dayOfWeek = today.getDay();
            
            if (currentChartView === 'week') {
                const weekData = getWeekData();
                const days = ['æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ', 'æ—¥'];
                
                let html = '';
                days.forEach((day, index) => {
                    const count = weekData[index] || 0;
                    const height = count > 0 ? Math.min(80, count * 5) : 10;
                    const isToday = (index === (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
                    
                    html += `
                        <div class="chart-bar">
                            <div class="bar ${isToday ? 'today' : ''}" style="height: ${height}%;">
                                <span class="bar-value">${count}</span>
                            </div>
                            <span class="bar-label">${day}</span>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            } else {
                const monthData = getMonthData();
                let html = '';
                
                for (let i = 0; i < 7; i++) {
                    const weekStart = i * 4 + 1;
                    const weekEnd = Math.min((i + 1) * 4, 31);
                    const weekTotal = monthData.slice(weekStart - 1, weekEnd).reduce((a, b) => a + b, 0);
                    const height = weekTotal > 0 ? Math.min(80, weekTotal * 2) : 10;
                    
                    html += `
                        <div class="chart-bar">
                            <div class="bar" style="height: ${height}%;">
                                <span class="bar-value">${weekTotal}</span>
                            </div>
                            <span class="bar-label">${weekStart}-${weekEnd}</span>
                        </div>
                    `;
                }
                
                container.innerHTML = html;
            }
        }
        
        // ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—åˆ‡ã‚Šæ›¿ãˆ
        function switchHeatmap(view, btn) {
            currentHeatmapView = view;
            document.querySelectorAll('.heatmap-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            updateHeatmap();
        }
        
        // ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—æ›´æ–°
        function updateHeatmap() {
            const container = document.getElementById('heatmapGrid');
            if (!container) return;
            
            let html = '';
            
            Object.values(books).forEach(book => {
                let currentSubject = '';
                let currentChapter = '';
                
                const allQuestions = getAllQuestionsFromBook(book);
                
                allQuestions.forEach(q => {
                    // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãƒ©ãƒ™ãƒ«è¿½åŠ 
                    if (q.subject !== currentSubject) {
                        currentSubject = q.subject;
                        html += `<div class="heatmap-section-label">${currentSubject}</div>`;
                    } else if (q.chapter !== currentChapter) {
                        currentChapter = q.chapter;
                        html += `<div class="heatmap-section-label" style="font-size: 9px; padding: 3px 0;">${currentChapter}</div>`;
                    }
                    
                    const state = getQuestionStateFromRecords(book.id, q);
                    let cellClass = '';
                    
                    if (currentHeatmapView === 'wrong') {
                        if (state.wrong) cellClass = 'wrong';
                        else if (state.correct) cellClass = 'correct';
                    } else if (currentHeatmapView === 'bookmark') {
                        if (state.bookmarked) cellClass = 'bookmarked';
                        else if (state.correct) cellClass = 'correct';
                        else if (state.wrong) cellClass = 'wrong';
                    }
                    
                    html += `<div class="heatmap-cell ${cellClass}">${q.number}</div>`;
                });
            });
            
            container.innerHTML = html || '<p style="color: var(--gray); text-align: center;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
        }
        
        // å•é¡Œé›†ã‹ã‚‰å…¨å•é¡Œã‚’å–å¾—
        function getAllQuestionsFromBook(book) {
            const questions = [];
            
            function traverse(structure, path = []) {
                Object.entries(structure).forEach(([name, item]) => {
                    const newPath = [...path, name];
                    
                    if (item.questions) {
                        item.questions.forEach(num => {
                            questions.push({
                                number: num,
                                subject: newPath[0],
                                chapter: newPath[1],
                                section: newPath[2],
                                subsection: newPath[3],
                                path: newPath
                            });
                        });
                    }
                    
                    if (item.children) {
                        traverse(item.children, newPath);
                    }
                });
            }
            
            traverse(book.structure);
            return questions;
        }
        
        // è¨˜éŒ²ã‹ã‚‰å•é¡Œã®çŠ¶æ…‹ã‚’å–å¾—
        function getQuestionStateFromRecords(bookId, question) {
            let state = { correct: false, wrong: false, bookmarked: false };
            
            allRecords.forEach(record => {
                if (record.bookId === bookId) {
                    const pathMatch = record.path.join('/') === question.path.slice(0, record.path.length).join('/');
                    if (pathMatch && record.questions[question.number]) {
                        const qState = record.questions[question.number];
                        if (qState.state === 'correct') state.correct = true;
                        if (qState.state === 'wrong') state.wrong = true;
                        if (qState.bookmarked) state.bookmarked = true;
                    }
                }
            });
            
            return state;
        }
        
        // å¾©ç¿’ã‚³ãƒ³ãƒ†ãƒ³ãƒ„æ›´æ–°
        function updateReviewContent() {
            const container = document.getElementById('reviewContent');
            if (!container) return;
            
            const wrongQuestions = getWrongQuestions();
            const bookmarkedQuestions = getBookmarkedQuestions();
            
            container.innerHTML = `
                <div>
                    <h4>âŒ ä¸æ­£è§£å•é¡Œ (${wrongQuestions.length}ä»¶)</h4>
                    <div id="wrongQuestionsList">${getPaginatedList(wrongQuestions, 'wrong')}</div>
                    
                    <h4 style="margin-top: 20px;">â­ ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ (${bookmarkedQuestions.length}ä»¶)</h4>
                    <div id="bookmarkedQuestionsList">${getPaginatedList(bookmarkedQuestions, 'bookmark')}</div>
                </div>
            `;
        }
        
        // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ä»˜ããƒªã‚¹ãƒˆ
        function getPaginatedList(items, type) {
            const page = currentReviewPage[type];
            const start = (page - 1) * ITEMS_PER_PAGE;
            const end = start + ITEMS_PER_PAGE;
            const pageItems = items.slice(start, end);
            const totalPages = Math.ceil(items.length / ITEMS_PER_PAGE);
            
            if (items.length === 0) {
                return '<p style="color: var(--gray); padding: 10px;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
            }
            
            let html = '';
            pageItems.forEach(item => {
                html += `
                    <div style="padding: 10px; border-bottom: 1px solid var(--light);">
                        <div style="font-weight: 600;">${item.path.join(' â€º ')} - å•é¡Œ${item.questionNumber}</div>
                        <div style="font-size: 12px; color: var(--gray);">${item.bookName}</div>
                    </div>
                `;
            });
            
            if (totalPages > 1) {
                html += `
                    <div class="pagination">
                        <button class="page-btn" onclick="changePage('${type}', ${page - 1})" ${page === 1 ? 'disabled' : ''}>å‰ã¸</button>
                        <span style="padding: 0 10px;">ãƒšãƒ¼ã‚¸ ${page} / ${totalPages}</span>
                        <button class="page-btn" onclick="changePage('${type}', ${page + 1})" ${page === totalPages ? 'disabled' : ''}>æ¬¡ã¸</button>
                    </div>
                `;
            }
            
            return html;
        }
        
        // ãƒšãƒ¼ã‚¸å¤‰æ›´
        function changePage(type, newPage) {
            currentReviewPage[type] = newPage;
            updateReviewContent();
        }
        
        // é€²æ—ã‚³ãƒ³ãƒ†ãƒ³ãƒ„æ›´æ–°
        function updateProgressContent() {
            const overallContainer = document.getElementById('overallProgress');
            const subjectContainer = document.getElementById('subjectProgress');
            
            const stats = calculateOverallProgress();
            
            overallContainer.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">${stats.totalQuestions}</div>
                        <div class="stat-label">ç·å•é¡Œæ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.totalAnswered}</div>
                        <div class="stat-label">è§£ç­”æ¸ˆã¿</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.totalCorrect}</div>
                        <div class="stat-label">æ­£è§£æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.overallRate}%</div>
                        <div class="stat-label">æ­£ç­”ç‡</div>
                    </div>
                </div>
                <div class="progress-bar-container">
                    <div class="progress-bar-fill" style="width: ${stats.progressPercentage}%;"></div>
                </div>
                <p style="text-align: center; margin-top: 10px;">é€²æ—ç‡: ${stats.progressPercentage}%</p>
            `;
            
            const subjectStats = calculateSubjectStats();
            let subjectHtml = '';
            
            Object.entries(subjectStats).forEach(([subject, stats]) => {
                const percentage = stats.total > 0 ? Math.round((stats.correct / stats.total) * 100) : 0;
                subjectHtml += `
                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span>${subject}</span>
                            <span>${percentage}%</span>
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-bar-fill" style="width: ${percentage}%;"></div>
                        </div>
                        <div style="font-size: 12px; color: var(--gray); margin-top: 3px;">
                            ${stats.total}å•è§£ç­” | ${stats.correct}å•æ­£è§£
                        </div>
                    </div>
                `;
            });
            
            subjectContainer.innerHTML = subjectHtml || '<p style="color: var(--gray);">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
        }
        
        // ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
        function toggleBookmarkMode() {
            bookmarkMode = !bookmarkMode;
            const btn = document.getElementById('bookmarkBtn');
            btn.classList.toggle('active');
        }
        
        // å•é¡Œé¸æŠ
        function toggleQuestion(num) {
            if (bookmarkMode) {
                questionStates[num].bookmarked = !questionStates[num].bookmarked;
                const cell = document.querySelector(`[data-number="${num}"]`);
                cell.classList.toggle('bookmarked');
            } else {
                const cell = document.querySelector(`[data-number="${num}"]`);
                const state = questionStates[num];
                
                if (state.state === null) {
                    state.state = 'correct';
                    cell.classList.add('correct');
                } else if (state.state === 'correct') {
                    state.state = 'wrong';
                    cell.classList.remove('correct');
                    cell.classList.add('wrong');
                } else {
                    state.state = null;
                    cell.classList.remove('wrong');
                }
            }
            
            saveQuestionStates();
            updateStats();
        }
        
        // å•é¡Œé›†é¸æŠæ›´æ–°
        function updateBookSelect() {
            const select = document.getElementById('bookSelect');
            select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„...</option>';
            
            Object.values(books).forEach(book => {
                const option = document.createElement('option');
                option.value = book.id;
                option.textContent = book.name;
                select.appendChild(option);
            });
        }
        
        // å•é¡Œé›†æ§‹é€ èª­ã¿è¾¼ã¿
        function loadBookStructure() {
            const bookId = document.getElementById('bookSelect').value;
            if (!bookId) return;
            
            currentBook = books[bookId];
            currentPath = [];
            
            document.getElementById('breadcrumb').style.display = 'flex';
            document.getElementById('hierarchySection').style.display = 'block';
            document.getElementById('questionSection').style.display = 'none';
            
            updateBreadcrumb();
            showHierarchyLevel(currentBook.structure);
        }
        
        // ãƒ‘ãƒ³ããšãƒªã‚¹ãƒˆæ›´æ–°
        function updateBreadcrumb() {
            const breadcrumb = document.getElementById('breadcrumb');
            const items = [currentBook.name, ...currentPath.map(p => p.name)];
            
            let html = '';
            items.forEach((item, index) => {
                if (index > 0) html += '<span class="breadcrumb-separator">â€º</span>';
                html += `<span class="breadcrumb-item ${index === items.length - 1 ? 'active' : ''}" 
                         onclick="navigateTo(${index - 1})">${item}</span>`;
            });
            
            breadcrumb.innerHTML = html;
        }
        
        // éšå±¤è¡¨ç¤º
        function showHierarchyLevel(structure) {
            const list = document.getElementById('hierarchyList');
            const title = document.getElementById('hierarchyTitle');
            
            list.innerHTML = '';
            
            Object.entries(structure).forEach(([name, item]) => {
                const btn = document.createElement('button');
                btn.className = 'subject-btn';
                btn.onclick = () => selectHierarchy(name, item);
                btn.textContent = name;
                list.appendChild(btn);
            });
            
            // ã‚¿ã‚¤ãƒˆãƒ«æ›´æ–°
            if (currentPath.length === 0) {
                title.textContent = 'ç§‘ç›®é¸æŠ';
            } else if (currentPath[currentPath.length - 1].type === 'subject') {
                title.textContent = 'ç« é¸æŠ';
            } else if (currentPath[currentPath.length - 1].type === 'chapter') {
                title.textContent = 'ç¯€é¸æŠ';
            } else {
                title.textContent = 'é …é¸æŠ';
            }
        }
        
        // éšå±¤é¸æŠ
        function selectHierarchy(name, item) {
            currentPath.push({ name, ...item });
            updateBreadcrumb();
            
            if (item.questions) {
                showQuestions(item);
            } else if (item.children) {
                showHierarchyLevel(item.children);
            }
        }
        
        // ãƒ‘ãƒ³ããšãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
        function navigateTo(index) {
            if (index === -1) {
                currentPath = [];
                showHierarchyLevel(currentBook.structure);
                document.getElementById('questionSection').style.display = 'none';
            } else {
                currentPath = currentPath.slice(0, index + 1);
                if (currentPath[index].questions) {
                    showQuestions(currentPath[index]);
                } else {
                    showHierarchyLevel(currentPath[index].children);
                    document.getElementById('questionSection').style.display = 'none';
                }
            }
            updateBreadcrumb();
        }
        
        // å•é¡Œè¡¨ç¤º
        function showQuestions(item) {
            document.getElementById('hierarchySection').style.display = 'none';
            document.getElementById('questionSection').style.display = 'block';
            
            const grid = document.getElementById('questionGrid');
            grid.innerHTML = '';
            questionStates = {};
            
            item.questions.forEach(num => {
                const cell = document.createElement('div');
                cell.className = 'question-cell';
                cell.textContent = num;
                cell.dataset.number = num;
                cell.onclick = () => toggleQuestion(num);
                
                grid.appendChild(cell);
                
                questionStates[num] = {
                    state: null,
                    bookmarked: false
                };
            });
            
            loadQuestionStates();
        }
        
        // æ­£è§£ãƒãƒ¼ã‚¯
        function markCorrect() {
            Object.keys(questionStates).forEach(num => {
                if (questionStates[num].state === null) {
                    questionStates[num].state = 'correct';
                    const cell = document.querySelector(`[data-number="${num}"]`);
                    if (cell) {
                        cell.classList.add('correct');
                    }
                }
            });
            saveQuestionStates();
            updateStats();
        }
        
        // ä¸æ­£è§£ãƒãƒ¼ã‚¯
        function markWrong() {
            Object.keys(questionStates).forEach(num => {
                if (questionStates[num].state === null) {
                    questionStates[num].state = 'wrong';
                    const cell = document.querySelector(`[data-number="${num}"]`);
                    if (cell) {
                        cell.classList.add('wrong');
                    }
                }
            });
            saveQuestionStates();
            updateStats();
        }
        
        // çµ±è¨ˆæ›´æ–°
        function updateStats() {
            let total = 0;
            let correct = 0;
            let wrong = 0;
            
            Object.values(questionStates).forEach(state => {
                if (state.state !== null) {
                    total++;
                    if (state.state === 'correct') {
                        correct++;
                    } else {
                        wrong++;
                    }
                }
            });
            
            const rate = total > 0 ? Math.round((correct / total) * 100) : 0;
            
            document.getElementById('totalCount').textContent = total;
            document.getElementById('correctCount').textContent = correct;
            document.getElementById('wrongCount').textContent = wrong;
            document.getElementById('correctRate').textContent = rate + '%';
        }
        
        // è¨˜éŒ²ä¿å­˜
        function saveRecord() {
            const record = {
                bookId: currentBook.id,
                bookName: currentBook.name,
                path: currentPath.map(p => p.name),
                questions: questionStates,
                timestamp: new Date().toISOString(),
                stats: {
                    total: parseInt(document.getElementById('totalCount').textContent),
                    correct: parseInt(document.getElementById('correctCount').textContent),
                    wrong: parseInt(document.getElementById('wrongCount').textContent),
                    rate: document.getElementById('correctRate').textContent
                }
            };
            
            saveToHistory(record);
            updateDailyStreak();
            loadAllRecords();
            
            alert('ä¿å­˜ã—ã¾ã—ãŸï¼');
        }
        
        // å±¥æ­´ä¿å­˜
        function saveToHistory(record) {
            let history = localStorage.getItem('studyHistory');
            history = history ? JSON.parse(history) : [];
            history.push(record);
            
            if (history.length > 100) {
                history = history.slice(-100);
            }
            
            localStorage.setItem('studyHistory', JSON.stringify(history));
        }
        
        // é€£ç¶šå­¦ç¿’æ—¥æ•°æ›´æ–°
        function updateDailyStreak() {
            const today = new Date().toDateString();
            const lastStudyDate = localStorage.getItem('lastStudyDate');
            let streakDays = parseInt(localStorage.getItem('streakDays') || '0');
            
            if (lastStudyDate !== today) {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                
                if (lastStudyDate === yesterday.toDateString()) {
                    streakDays++;
                } else if (lastStudyDate !== today) {
                    streakDays = 1;
                }
                
                localStorage.setItem('lastStudyDate', today);
                localStorage.setItem('streakDays', streakDays.toString());
            }
        }
        
        // æ–°è¦å•é¡Œé›†ä½œæˆ
        function createNewBook() {
            const name = document.getElementById('newBookName').value;
            const examType = document.getElementById('newExamType').value;
            
            if (!name || !examType) {
                alert('å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            const bookId = 'book_' + Date.now();
            currentBook = {
                id: bookId,
                name: name,
                examType: examType,
                structure: {},
                createdAt: new Date().toISOString()
            };
            
            books[bookId] = currentBook;
            saveBooksToStorage();
            updateBookSelect();
            
            closeFooterModal();
            openModal('structureModal');
        }
        
        // å•é¡Œé›†ç·¨é›†
        function editBook(bookId) {
            currentBook = books[bookId];
            closeFooterModal();
            openModal('structureModal');
        }
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«æ“ä½œ
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
            if (modalId === 'structureModal') {
                updateHierarchyForm();
            }
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }
        
        // éšå±¤ãƒ•ã‚©ãƒ¼ãƒ æ›´æ–°
        function updateHierarchyForm() {
            const level = document.getElementById('hierarchyLevel').value;
            const parentGroup = document.getElementById('parentSelectGroup');
            const questionGroup = document.getElementById('questionCountGroup');
            
            if (level === 'subject') {
                parentGroup.style.display = 'none';
                questionGroup.style.display = 'none';
            } else if (level === 'chapter') {
                parentGroup.style.display = 'block';
                questionGroup.style.display = 'none';
                updateParentOptions('subject');
            } else if (level === 'section') {
                parentGroup.style.display = 'block';
                questionGroup.style.display = 'block';
                updateParentOptions('chapter');
            } else if (level === 'subsection') {
                parentGroup.style.display = 'block';
                questionGroup.style.display = 'block';
                updateParentOptions('section');
            }
        }
        
        // è¦ªéšå±¤ã‚ªãƒ—ã‚·ãƒ§ãƒ³æ›´æ–°
        function updateParentOptions(parentType) {
            const select = document.getElementById('parentHierarchy');
            select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
            
            if (!currentBook) return;
            
            function addOptions(structure, path = []) {
                Object.entries(structure).forEach(([name, item]) => {
                    if (item.type === parentType) {
                        const option = document.createElement('option');
                        option.value = [...path, name].join('/');
                        option.textContent = [...path, name].join(' â€º ');
                        select.appendChild(option);
                    }
                    if (item.children) {
                        addOptions(item.children, [...path, name]);
                    }
                });
            }
            
            addOptions(currentBook.structure);
        }
        
        // éšå±¤ä¿å­˜
        function saveHierarchy() {
            const level = document.getElementById('hierarchyLevel').value;
            const name = document.getElementById('hierarchyName').value;
            const parent = document.getElementById('parentHierarchy').value;
            const count = document.getElementById('questionCount').value;
            
            if (!name) {
                alert('åç§°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            if (level !== 'subject' && !parent) {
                alert('è¦ªéšå±¤ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            // éšå±¤è¿½åŠ 
            if (level === 'subject') {
                currentBook.structure[name] = {
                    type: 'subject',
                    children: {}
                };
            } else {
                const parentPath = parent.split('/');
                let target = currentBook.structure;
                
                parentPath.forEach(p => {
                    if (target[p]) {
                        target = target[p].children || {};
                    }
                });
                
                if ((level === 'section' || level === 'subsection') && count) {
                    target[name] = {
                        type: level,
                        questions: generateQuestionNumbers(1, parseInt(count))
                    };
                    if (level === 'section') {
                        target[name].children = {};
                    }
                } else {
                    target[name] = {
                        type: level,
                        children: {}
                    };
                }
            }
            
            saveBooksToStorage();
            closeModal('structureModal');
            alert('ä¿å­˜ã—ã¾ã—ãŸ');
        }
        
        // å¼±ç‚¹åˆ†ææ›´æ–°
        function updateWeaknessAnalysis() {
            const container = document.getElementById('weaknessAnalysis');
            if (!container) return;
            
            const subjectStats = calculateSubjectStats();
            const weaknesses = [];
            
            Object.entries(subjectStats).forEach(([subject, stats]) => {
                if (stats.total > 0) {
                    const percentage = Math.round((stats.correct / stats.total) * 100);
                    if (percentage < 70) {
                        weaknesses.push({
                            subject,
                            percentage,
                            wrong: stats.wrong
                        });
                    }
                }
            });
            
            weaknesses.sort((a, b) => a.percentage - b.percentage);
            
            if (weaknesses.length === 0) {
                container.innerHTML = '<p style="color: var(--gray);">å¼±ç‚¹åˆ†é‡ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
            } else {
                container.innerHTML = weaknesses.map(w => `
                    <div style="padding: 10px; background: #fef2f2; border-left: 3px solid var(--danger); border-radius: 5px; margin-bottom: 10px;">
                        <div style="font-weight: 600; color: var(--danger);">${w.subject}</div>
                        <div style="font-size: 14px;">æ­£ç­”ç‡: ${w.percentage}% | é–“é•ã„: ${w.wrong}å•</div>
                    </div>
                `).join('');
            }
        }
        
        // ãƒ‡ãƒ¼ã‚¿è¨ˆç®—é–¢æ•°
        function getWeekData() {
            const weekData = [0, 0, 0, 0, 0, 0, 0];
            const today = new Date();
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - today.getDay() + 1);
            
            allRecords.forEach(record => {
                const recordDate = new Date(record.timestamp);
                if (recordDate >= startOfWeek) {
                    const dayIndex = (recordDate.getDay() + 6) % 7;
                    weekData[dayIndex] += record.stats.total || 0;
                }
            });
            
            return weekData;
        }
        
        function getMonthData() {
            const monthData = new Array(31).fill(0);
            const today = new Date();
            const currentMonth = today.getMonth();
            
            allRecords.forEach(record => {
                const recordDate = new Date(record.timestamp);
                if (recordDate.getMonth() === currentMonth) {
                    const day = recordDate.getDate() - 1;
                    monthData[day] += record.stats.total || 0;
                }
            });
            
            return monthData;
        }
        
        function calculateOverallProgress() {
            let totalQuestions = 0;
            let totalAnswered = 0;
            let totalCorrect = 0;
            
            Object.values(books).forEach(book => {
                totalQuestions += countQuestionsInBook(book);
            });
            
            allRecords.forEach(record => {
                totalAnswered += record.stats.total || 0;
                totalCorrect += record.stats.correct || 0;
            });
            
            const overallRate = totalAnswered > 0 ? Math.round((totalCorrect / totalAnswered) * 100) : 0;
            const progressPercentage = totalQuestions > 0 ? Math.round((totalAnswered / totalQuestions) * 100) : 0;
            
            return {
                totalQuestions,
                totalAnswered,
                totalCorrect,
                overallRate,
                progressPercentage
            };
        }
        
        function calculateSubjectStats() {
            const subjectStats = {};
            
            allRecords.forEach(record => {
                const subject = record.path[0];
                if (!subject) return;
                
                if (!subjectStats[subject]) {
                    subjectStats[subject] = {
                        total: 0,
                        correct: 0,
                        wrong: 0
                    };
                }
                
                subjectStats[subject].total += record.stats.total || 0;
                subjectStats[subject].correct += record.stats.correct || 0;
                subjectStats[subject].wrong += record.stats.wrong || 0;
            });
            
            return subjectStats;
        }
        
        function getWrongQuestions() {
            const wrongQuestions = [];
            
            allRecords.forEach(record => {
                Object.entries(record.questions).forEach(([num, state]) => {
                    if (state.state === 'wrong') {
                        wrongQuestions.push({
                            bookName: record.bookName,
                            path: record.path,
                            questionNumber: num,
                            timestamp: record.timestamp
                        });
                    }
                });
            });
            
            return wrongQuestions;
        }
        
        function getBookmarkedQuestions() {
            const bookmarkedQuestions = [];
            
            allRecords.forEach(record => {
                Object.entries(record.questions).forEach(([num, state]) => {
                    if (state.bookmarked) {
                        bookmarkedQuestions.push({
                            bookName: record.bookName,
                            path: record.path,
                            questionNumber: num,
                            timestamp: record.timestamp
                        });
                    }
                });
            });
            
            return bookmarkedQuestions;
        }
        
        function countQuestionsInBook(book) {
            let count = 0;
            
            function traverse(structure) {
                Object.values(structure).forEach(item => {
                    if (item.questions) {
                        count += item.questions.length;
                    }
                    if (item.children) {
                        traverse(item.children);
                    }
                });
            }
            
            traverse(book.structure);
            return count;
        }
        
        // ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢
        function clearAllData() {
            if (confirm('ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                localStorage.clear();
                location.reload();
            }
        }
    </script>
</body>
</html>
