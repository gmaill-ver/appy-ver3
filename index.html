<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>学習トラッカー - 行政書士試験対策</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- ヘッダー -->
    <header class="app-header">
        <button class="timer-icon-btn" onclick="App.openTimerModal()" title="タイマー">⏰</button>
        <div class="timer-display" id="timerDisplay">00:00:00</div>
        <div class="app-logo">
            <span class="app-logo-icon">📚</span>
            <span class="app-title">学習トラッカー</span>
        </div>
        <div class="exam-countdown" id="examCountdown">試験日まで <span class="days">--</span> 日</div>
    </header>
    
    <!-- メインタブ -->
    <div class="main-tabs">
        <button class="main-tab active" onclick="App.switchMainTab('record', event)">記録入力</button>
        <button class="main-tab" onclick="App.switchMainTab('analysis', event)">分析</button>
        <button class="main-tab" onclick="App.switchMainTab('progress', event)">進捗</button>
    </div>
    
    <!-- コンテンツエリア -->
    <div class="content-area">
        <!-- 記録入力タブ -->
        <div id="record-tab" class="tab-content active">
            <!-- 問題集選択 -->
            <div class="book-cards-wrapper">
                <button class="book-order-btn" onclick="App.toggleBookSort()">並替え</button>
                <div id="bookCardsContainer"></div>
            </div>
            
            <!-- パンくずリスト -->
            <div class="breadcrumb" id="breadcrumb" style="display: none;"></div>
            
            <!-- 階層リスト -->
            <div id="recordHierarchyContainer" style="display: none;"></div>
            
            <!-- 問題入力 -->
            <div class="card" id="questionSection" style="display: none;">
                <div class="card-header">
                    <span class="card-icon">✍️</span>
                    <span class="card-title">問題別正誤入力</span>
                </div>
                
                <div class="action-buttons">
                    <button class="action-btn correct" onclick="App.markCorrect()">
                        <span>⭕</span><span>正解</span>
                    </button>
                    <button class="action-btn wrong" onclick="App.markWrong()">
                        <span>❌</span><span>不正解</span>
                    </button>
                    <button class="action-btn bookmark" id="bookmarkBtn" onclick="App.toggleBookmarkMode()">
                        <span>⭐</span><span>マーク</span>
                    </button>
                </div>
                
                <div class="question-grid" id="questionGrid"></div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalCount">0</div>
                        <div class="stat-label">解答数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="correctCount">0</div>
                        <div class="stat-label">正解数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="wrongCount">0</div>
                        <div class="stat-label">不正解数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="correctRate">0%</div>
                        <div class="stat-label">正答率</div>
                    </div>
                </div>
                
                <button class="save-button" onclick="App.saveRecord()">学習記録を保存</button>
            </div>
            
            <!-- カレンダー -->
            <div class="calendar-container">
                <div class="calendar-header">
                    <div class="calendar-nav">
                        <button class="calendar-nav-btn" onclick="UIComponents.changeMonth(-1)">◀</button>
                        <span class="calendar-month" id="calendarMonth">2025年1月</span>
                        <button class="calendar-nav-btn" onclick="UIComponents.changeMonth(1)">▶</button>
                    </div>
                    <button class="calendar-nav-btn" onclick="UIComponents.goToToday()">今日</button>
                </div>
                <div class="calendar-grid" id="calendarGrid"></div>
                <div class="calendar-actions">
                    <button class="calendar-btn add-plan" onclick="UIComponents.openPlanModal()">📝 学習計画を追加</button>
                    <button class="calendar-btn view-plans" onclick="UIComponents.viewPlans()">📋 計画一覧</button>
                </div>
            </div>
        </div>
        
        <!-- 分析タブ -->
        <div id="analysis-tab" class="tab-content">
            <button class="card-sort-btn" onclick="App.toggleAnalysisSort()">並替え</button>
            <div id="analysisCardsContainer">
                <!-- 学習グラフ -->
                <div class="accordion card" data-card-id="chart">
                    <div class="accordion-header" onclick="App.toggleAccordion(this)">
                        <span>📊 学習グラフ</span>
                        <span class="accordion-arrow">▼</span>
                    </div>
                    <div class="accordion-content">
                        <div class="chart-controls">
                            <button class="chart-btn active" onclick="Analytics.switchChartView('day', this)">日別</button>
                            <button class="chart-btn" onclick="Analytics.switchChartView('week', this)">週間</button>
                            <button class="chart-btn" onclick="Analytics.switchChartView('month', this)">月間</button>
                        </div>
                        <div class="chart-wrapper">
                            <div class="chart-bars" id="chartBars"></div>
                        </div>
                    </div>
                </div>
                
                <!-- 学習履歴 -->
                <div class="accordion card" data-card-id="history">
                    <div class="accordion-header" onclick="App.toggleAccordion(this)">
                        <span>📅 学習履歴</span>
                        <span class="accordion-arrow">▼</span>
                    </div>
                    <div class="accordion-content">
                        <div id="historyContent"></div>
                    </div>
                </div>
                
                <!-- ヒートマップ -->
                <div class="accordion card" data-card-id="heatmap">
                    <div class="accordion-header" onclick="App.toggleAccordion(this)">
                        <span>🗺️ 問題ヒートマップ</span>
                        <span class="accordion-arrow">▼</span>
                    </div>
                    <div class="accordion-content">
                        <div class="heatmap-controls">
                            <select class="heatmap-select" id="heatmapBookSelect" onchange="Analytics.updateHeatmap()">
                                <option value="">問題集を選択</option>
                            </select>
                            <button class="heatmap-toggle-btn" id="heatmapToggleBtn" onclick="Analytics.toggleHeatmapPinned()">📌 固定</button>
                        </div>
                        <div class="heatmap-grid" id="heatmapGrid"></div>
                    </div>
                </div>
                
                <!-- 弱点分析 -->
                <div class="accordion card" data-card-id="weakness">
                    <div class="accordion-header" onclick="App.toggleAccordion(this)">
                        <span>🎯 弱点分析</span>
                        <span class="accordion-arrow">▼</span>
                    </div>
                    <div class="accordion-content">
                        <div id="weaknessAnalysis"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 進捗タブ -->
        <div id="progress-tab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <span class="card-icon">📊</span>
                    <span class="card-title">全体進捗状況</span>
                </div>
                <div id="overallProgress"></div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <span class="card-icon">📈</span>
                    <span class="card-title">科目別進捗</span>
                </div>
                <div class="radar-chart-container">
                    <div class="radar-chart-controls">
                        <select class="radar-chart-select" id="radarBookSelect" onchange="Analytics.drawRadarChart()">
                            <option value="">問題集を選択</option>
                        </select>
                        <button class="radar-toggle-btn" id="radarToggleBtn" onclick="Analytics.toggleRadarPinned()">📌 固定表示</button>
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <button class="chart-btn active" id="radarModeSubject" onclick="Analytics.setRadarMode('subject', this)">科目別</button>
                            <button class="chart-btn" id="radarModeCompare" onclick="Analytics.setRadarMode('compare', this)">問題集比較</button>
                        </div>
                    </div>
                    <canvas id="radarChart" width="300" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- フッタータブ -->
    <div class="footer-tabs">
        <button class="footer-tab active" onclick="App.switchFooterTab('register', event)">
            <span class="footer-tab-icon">📝</span>
            <span class="footer-tab-label">登録</span>
        </button>
        <button class="footer-tab" onclick="App.switchFooterTab('qa', event)">
            <span class="footer-tab-icon">❓</span>
            <span class="footer-tab-label">一問一答</span>
        </button>
        <button class="footer-tab" onclick="App.switchFooterTab('keypoints', event)">
            <span class="footer-tab-icon">📚</span>
            <span class="footer-tab-label">要点確認</span>
        </button>
        <button class="footer-tab" onclick="App.switchFooterTab('results', event)">
            <span class="footer-tab-icon">🏆</span>
            <span class="footer-tab-label">実績</span>
        </button>
        <button class="footer-tab" onclick="App.switchFooterTab('settings', event)">
            <span class="footer-tab-icon">⚙️</span>
            <span class="footer-tab-label">設定</span>
        </button>
    </div>
    
    <!-- タイマーモーダル -->
    <div id="timerModal" class="timer-modal">
        <div class="timer-modal-content">
            <div class="modal-header">
                <h3>⏰ タイマー</h3>
                <button class="modal-close" onclick="TimerModule.closeModal()">×</button>
            </div>
            
            <div class="timer-tabs">
                <button class="timer-tab active" onclick="TimerModule.switchTab('stopwatch', this)">ストップウォッチ</button>
                <button class="timer-tab" onclick="TimerModule.switchTab('countdown', this)">タイマー</button>
                <button class="timer-tab" onclick="TimerModule.switchTab('interval', this)">インターバル</button>
            </div>
            
            <div id="stopwatchTab" class="timer-tab-content">
                <div class="timer-display-large" id="stopwatchDisplay">00:00:00</div>
                <div class="timer-controls">
                    <button class="timer-btn start" onclick="TimerModule.startStopwatch()">開始</button>
                    <button class="timer-btn pause" onclick="TimerModule.pauseStopwatch()">一時停止</button>
                    <button class="timer-btn reset" onclick="TimerModule.resetStopwatch()">リセット</button>
                </div>
            </div>
            
            <div id="countdownTab" class="timer-tab-content" style="display: none;">
                <div class="timer-input-group">
                    <label class="timer-input-label">タイマー設定</label>
                    <div class="timer-input-row">
                        <input type="number" class="timer-input" id="countdownHours" placeholder="時" min="0" max="23">
                        <span>時間</span>
                        <input type="number" class="timer-input" id="countdownMinutes" placeholder="分" min="0" max="59">
                        <span>分</span>
                        <input type="number" class="timer-input" id="countdownSeconds" placeholder="秒" min="0" max="59">
                        <span>秒</span>
                    </div>
                </div>
                <div class="timer-display-large" id="countdownDisplay">00:00:00</div>
                <div class="timer-controls">
                    <button class="timer-btn start" onclick="TimerModule.startCountdown()">開始</button>
                    <button class="timer-btn pause" onclick="TimerModule.pauseCountdown()">一時停止</button>
                    <button class="timer-btn reset" onclick="TimerModule.resetCountdown()">リセット</button>
                </div>
            </div>
            
            <div id="intervalTab" class="timer-tab-content" style="display: none;">
                <div class="timer-input-group">
                    <label class="timer-input-label">作業時間</label>
                    <div class="timer-input-row">
                        <input type="number" class="timer-input" id="workMinutes" value="25" min="1">
                        <span>分</span>
                    </div>
                </div>
                <div class="timer-input-group">
                    <label class="timer-input-label">休憩時間</label>
                    <div class="timer-input-row">
                        <input type="number" class="timer-input" id="breakMinutes" value="5" min="1">
                        <span>分</span>
                    </div>
                </div>
                <div class="timer-input-group">
                    <label class="timer-input-label">セット数</label>
                    <div class="timer-input-row">
                        <input type="number" class="timer-input" id="intervalSets" value="4" min="1">
                        <span>セット</span>
                    </div>
                </div>
                <div class="timer-display-large" id="intervalDisplay">00:00</div>
                <div style="text-align: center; margin: 10px 0;">
                    <span id="intervalStatus">待機中</span> | 
                    <span id="intervalSetCount">0/0 セット</span>
                </div>
                <div class="timer-controls">
                    <button class="timer-btn start" onclick="TimerModule.startInterval()">開始</button>
                    <button class="timer-btn pause" onclick="TimerModule.pauseInterval()">一時停止</button>
                    <button class="timer-btn reset" onclick="TimerModule.resetInterval()">リセット</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 学習計画モーダル -->
    <div id="planModal" class="plan-modal">
        <div class="plan-modal-content">
            <div class="modal-header">
                <h3 id="planModalTitle">📅 学習計画</h3>
                <button class="modal-close" onclick="UIComponents.closePlanModal()">×</button>
            </div>
            
            <div id="planFormSection">
                <div class="plan-form-group">
                    <label class="plan-form-label">計画タイトル</label>
                    <input type="text" class="plan-form-control" id="planTitle" placeholder="例：民法総則の復習">
                </div>
                
                <div class="plan-form-group">
                    <label class="plan-form-label">計画内容</label>
                    <textarea class="plan-form-control" id="planContent" rows="3" placeholder="学習内容の詳細を入力"></textarea>
                </div>
                
                <div class="plan-form-group">
                    <label class="plan-form-label">表示形式</label>
                    <div class="plan-display-type">
                        <label>
                            <input type="radio" name="displayType" value="bullet" checked>
                            <span>・</span>
                        </label>
                        <label>
                            <input type="radio" name="displayType" value="text">
                            <span>通常表示</span>
                        </label>
                    </div>
                </div>
                
                <div class="plan-form-group">
                    <label class="plan-form-label">日付範囲</label>
                    <div class="date-range-inputs">
                        <input type="date" class="plan-form-control" id="planStartDate">
                        <span>〜</span>
                        <input type="date" class="plan-form-control" id="planEndDate">
                    </div>
                </div>
                
                <div class="plan-form-group">
                    <label class="plan-form-label">色設定</label>
                    <div class="color-picker" id="colorPicker">
                        <div class="color-option selected" style="background: #3498db;" data-color="#3498db"></div>
                        <div class="color-option" style="background: #10b981;" data-color="#10b981"></div>
                        <div class="color-option" style="background: #f59e0b;" data-color="#f59e0b"></div>
                        <div class="color-option" style="background: #ef4444;" data-color="#ef4444"></div>
                        <div class="color-option" style="background: #8b5cf6;" data-color="#8b5cf6"></div>
                        <div class="color-option" style="background: #ec4899;" data-color="#ec4899"></div>
                        <div class="color-option" style="background: #6b7280;" data-color="#6b7280"></div>
                    </div>
                </div>
                
                <input type="hidden" id="editPlanId" value="">
                <button class="save-button" onclick="UIComponents.savePlan()">計画を保存</button>
            </div>
            
            <div id="planListSection" style="display: none;">
                <h4>登録済みの計画</h4>
                <div class="plan-list" id="planListContent"></div>
            </div>
        </div>
    </div>
    
    <!-- フッターモーダル -->
    <div id="footerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">タイトル</h3>
                <button class="modal-close" onclick="App.closeFooterModal()">×</button>
            </div>
            <div id="modalBody"></div>
        </div>
        <div class="modal-footer">
            <button class="modal-close-bottom" onclick="App.closeFooterModal()">閉じる</button>
        </div>
    </div>
    
    <!-- 入力ダイアログ -->
    <div id="dialogOverlay" class="dialog-overlay" style="display: none;"></div>
    <div id="inputDialog" class="input-dialog" style="display: none;">
        <h3 id="dialogTitle">タイトル</h3>
        <div id="dialogBody"></div>
        <div class="dialog-buttons">
            <button class="dialog-btn secondary" onclick="App.closeDialog()">キャンセル</button>
            <button class="dialog-btn primary" id="dialogConfirmBtn">確定</button>
        </div>
    </div>

    <!-- 🔥 Firebase SDK v9 (Compat版) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <!-- 🔧 Firebase設定＆初期化 -->
    <script>
    // Firebase設定
    const firebaseConfig = {
        apiKey: "AIzaSyCa3-o7VIbxDzZDy7_SPHTk1kqpq23I79s",
        authDomain: "gakushusintyoku.firebaseapp.com",
        projectId: "gakushusintyoku",
        storageBucket: "gakushusintyoku.firebasestorage.app",
        messagingSenderId: "386582438890",
        appId: "1:386582438890:web:78cd619f0d7ad3ae5a0893"
    };

    // Firebase初期化
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    </script>

    <!-- 📱 JavaScript モジュール読み込み（順序重要） -->
    <script src="data-manager.js"></script>
    <script src="ui-components.js"></script>
    <script src="analytics.js"></script>
    <script src="qa-module.js"></script>
    <script src="timer-module.js"></script>
    <script src="keypoints-module.js"></script>
    <script src="app.js"></script>

    <!-- 🔥 全モジュールFirebase統合修正コード -->
<script>
console.log("🔧 全モジュールFirebase統合修正開始");

// 📅 1. カレンダー（学習計画）保存の拡張
if (window.UIComponents && typeof UIComponents.savePlan === 'function') {
    const originalSavePlan = UIComponents.savePlan;
    UIComponents.savePlan = function() {
        console.log("📅 学習計画保存（Firebase統合版）");
        
        // 元の保存処理を実行
        originalSavePlan.call(this);
        
        // Firebase保存
        if (ULTRA_STABLE_USER_ID && DataManager.saveToFirestore) {
            const planData = {
                type: "studyPlan",
                planCount: DataManager.studyPlans ? DataManager.studyPlans.length : 0,
                action: "planSaved",
                plans: DataManager.studyPlans || []
            };
            DataManager.saveToFirestore(planData);
        }
    };
    console.log("✅ 学習計画保存にFirebase統合追加");
}

// 📚 2. 問題集・教材追加の拡張
if (window.DataManager) {
    // 問題集保存の拡張
    const originalSaveBooksToStorage = DataManager.saveBooksToStorage;
    DataManager.saveBooksToStorage = function() {
        console.log("📚 問題集保存（Firebase統合版）");
        
        // 元の保存処理を実行
        originalSaveBooksToStorage.call(this);
        
        // Firebase保存
        if (ULTRA_STABLE_USER_ID && this.saveToFirestore) {
            const bookData = {
                type: "bookData",
                bookCount: this.books ? Object.keys(this.books).length : 0,
                action: "booksSaved",
                books: this.books || {}
            };
            this.saveToFirestore(bookData);
        }
    };
    
    // CSV テンプレート保存の拡張
    const originalSaveCSVTemplates = DataManager.saveCSVTemplates;
    DataManager.saveCSVTemplates = function() {
        console.log("📊 CSVテンプレート保存（Firebase統合版）");
        
        // 元の保存処理を実行
        originalSaveCSVTemplates.call(this);
        
        // Firebase保存
        if (ULTRA_STABLE_USER_ID && this.saveToFirestore) {
            const csvData = {
                type: "csvTemplates",
                templateCount: this.csvTemplates ? Object.keys(this.csvTemplates).length : 0,
                action: "csvTemplatesSaved",
                templates: this.csvTemplates || {}
            };
            this.saveToFirestore(csvData);
        }
    };
    
    console.log("✅ 問題集・CSV保存にFirebase統合追加");
}

// 📝 3. 要点確認保存の拡張
if (window.KeyPointsModule && typeof KeyPointsModule.saveKeyPointsData === 'function') {
    const originalSaveKeyPointsData = KeyPointsModule.saveKeyPointsData;
    KeyPointsModule.saveKeyPointsData = function() {
        console.log("📝 要点確認保存（Firebase統合版）");
        
        // 元の保存処理を実行
        originalSaveKeyPointsData.call(this);
        
        // Firebase保存
        if (ULTRA_STABLE_USER_ID && DataManager.saveToFirestore) {
            const keyPointsData = {
                type: "keyPoints",
                subjectCount: this.subjects ? Object.keys(this.subjects).length : 0,
                action: "keyPointsSaved",
                keyPointsData: this.subjects || {}
            };
            DataManager.saveToFirestore(keyPointsData);
        }
    };
    console.log("✅ 要点確認保存にFirebase統合追加");
}

// ❓ 4. 一問一答保存の拡張
if (window.QAModule) {
    // 一問一答問題追加の拡張
    const originalAddQuestion = QAModule.addQuestion;
    QAModule.addQuestion = function(setName, question, answer) {
        console.log("❓ 一問一答追加（Firebase統合版）");
        
        // 元の処理を実行
        const result = originalAddQuestion.call(this, setName, question, answer);
        
        // Firebase保存
        if (result && ULTRA_STABLE_USER_ID && DataManager.saveToFirestore) {
            const qaData = {
                type: "qaQuestion",
                setName: setName,
                action: "questionAdded",
                totalSets: DataManager.qaQuestions ? Object.keys(DataManager.qaQuestions).length : 0,
                totalQuestions: this.getTotalQuestionCount()
            };
            DataManager.saveToFirestore(qaData);
        }
        
        return result;
    };
    
    // 一問一答問題削除の拡張
    const originalDeleteQuestion = QAModule.deleteQuestion;
    QAModule.deleteQuestion = function(setName, questionId) {
        console.log("❓ 一問一答削除（Firebase統合版）");
        
        // 元の処理を実行
        const result = originalDeleteQuestion.call(this, setName, questionId);
        
        // Firebase保存
        if (result && ULTRA_STABLE_USER_ID && DataManager.saveToFirestore) {
            const qaData = {
                type: "qaQuestion",
                setName: setName,
                action: "questionDeleted",
                totalSets: DataManager.qaQuestions ? Object.keys(DataManager.qaQuestions).length : 0,
                totalQuestions: this.getTotalQuestionCount()
            };
            DataManager.saveToFirestore(qaData);
        }
        
        return result;
    };
    
    // CSVインポートの拡張
    const originalImportFromCSV = QAModule.importFromCSV;
    QAModule.importFromCSV = function(setName, csvData) {
        console.log("❓ 一問一答CSV（Firebase統合版）");
        
        // 元の処理を実行
        const result = originalImportFromCSV.call(this, setName, csvData);
        
        // Firebase保存
        if (result && ULTRA_STABLE_USER_ID && DataManager.saveToFirestore) {
            const qaData = {
                type: "qaCSVImport",
                setName: setName,
                action: "csvImported",
                totalSets: DataManager.qaQuestions ? Object.keys(DataManager.qaQuestions).length : 0,
                totalQuestions: this.getTotalQuestionCount()
            };
            DataManager.saveToFirestore(qaData);
        }
        
        return result;
    };
    
    // 問題数カウント用ヘルパー
    QAModule.getTotalQuestionCount = function() {
        let total = 0;
        if (DataManager.qaQuestions) {
            Object.values(DataManager.qaQuestions).forEach(questions => {
                if (Array.isArray(questions)) {
                    total += questions.length;
                }
            });
        }
        return total;
    };
    
    console.log("✅ 一問一答保存にFirebase統合追加");
}

// 🔧 5. App内の問題集操作の拡張
if (window.App) {
    // CSV インポートの拡張
    const originalImportCSV = App.importCSV;
    App.importCSV = function() {
        console.log("📊 CSVインポート（Firebase統合版）");
        
        // 元の処理を実行
        originalImportCSV.call(this);
        
        // Firebase保存
        if (ULTRA_STABLE_USER_ID && DataManager.saveToFirestore) {
            const importData = {
                type: "csvImport",
                bookCount: DataManager.books ? Object.keys(DataManager.books).length : 0,
                action: "csvImported"
            };
            DataManager.saveToFirestore(importData);
        }
    };
    
    console.log("✅ App内操作にFirebase統合追加");
}

// 🏥 6. DataManager保存メソッドの総合拡張
if (window.DataManager) {
    // 試験日保存の拡張
    const originalSaveExamDate = DataManager.saveExamDate;
    DataManager.saveExamDate = function(date) {
        console.log("📅 試験日保存（Firebase統合版）");
        
        // 元の処理を実行
        const result = originalSaveExamDate.call(this, date);
        
        // Firebase保存
        if (result && ULTRA_STABLE_USER_ID && this.saveToFirestore) {
            const examData = {
                type: "examDate",
                examDate: date ? date.toISOString() : null,
                action: "examDateSaved"
            };
            this.saveToFirestore(examData);
        }
        
        return result;
    };
    
    // 学習計画保存の拡張
    const originalSaveStudyPlans = DataManager.saveStudyPlans;
    DataManager.saveStudyPlans = function() {
        console.log("📋 学習計画保存（Firebase統合版）");
        
        // 元の処理を実行
        originalSaveStudyPlans.call(this);
        
        // Firebase保存
        if (ULTRA_STABLE_USER_ID && this.saveToFirestore) {
            const planData = {
                type: "studyPlansSync",
                planCount: this.studyPlans ? this.studyPlans.length : 0,
                action: "studyPlansSaved",
                plans: this.studyPlans || []
            };
            this.saveToFirestore(planData);
        }
    };
    
    // 一問一答保存の拡張
    const originalSaveQAQuestions = DataManager.saveQAQuestions;
    DataManager.saveQAQuestions = function() {
        console.log("❓ 一問一答保存（Firebase統合版）");
        
        // 元の処理を実行
        originalSaveQAQuestions.call(this);
        
        // Firebase保存
        if (ULTRA_STABLE_USER_ID && this.saveToFirestore) {
            const qaData = {
                type: "qaQuestionsSync",
                setCount: this.qaQuestions ? Object.keys(this.qaQuestions).length : 0,
                action: "qaQuestionsSaved",
                qaQuestions: this.qaQuestions || {}
            };
            this.saveToFirestore(qaData);
        }
    };
    
    console.log("✅ DataManager総合保存にFirebase統合追加");
}

// 📱 7. ハンドル関数の拡張（App内の手動追加処理）
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        // 一問一答の手動追加ボタン
        const originalHandleAddQuestion = QAModule.handleAddQuestion;
        if (originalHandleAddQuestion) {
            QAModule.handleAddQuestion = function() {
                console.log("❓ 一問一答手動追加（Firebase統合版）");
                
                // 元の処理を実行
                originalHandleAddQuestion.call(this);
                
                // 追加で Firebase 保存通知
                if (ULTRA_STABLE_USER_ID) {
                    showAddQuestionNotification();
                }
            };
        }
        
        // 要点確認の手動追加ボタン
        const originalHandleAddHierarchyItemCard = KeyPointsModule.handleAddHierarchyItemCard;
        if (originalHandleAddHierarchyItemCard) {
            KeyPointsModule.handleAddHierarchyItemCard = function() {
                console.log("📝 要点確認手動追加（Firebase統合版）");
                
                // 元の処理を実行
                originalHandleAddHierarchyItemCard.call(this);
                
                // 追加で Firebase 保存通知
                if (ULTRA_STABLE_USER_ID) {
                    showAddKeyPointNotification();
                }
            };
        }
        
        console.log("✅ 手動追加処理にFirebase統合追加");
    }, 2000);
});

// 🔔 8. 各種通知機能の追加
function showAddQuestionNotification() {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 140px;
        right: 20px;
        background: linear-gradient(135deg, #ff9800, #ffb74d);
        color: white;
        padding: 12px 18px;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(255, 152, 0, 0.4);
        z-index: 9999;
        font-weight: 600;
        font-size: 14px;
        animation: slideInRight 0.3s ease;
    `;
    notification.innerHTML = '❓ 一問一答を保存中...';
    document.body.appendChild(notification);
    
    setTimeout(() => notification.remove(), 2000);
}

function showAddKeyPointNotification() {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 140px;
        right: 20px;
        background: linear-gradient(135deg, #9c27b0, #ba68c8);
        color: white;
        padding: 12px 18px;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(156, 39, 176, 0.4);
        z-index: 9999;
        font-weight: 600;
        font-size: 14px;
        animation: slideInRight 0.3s ease;
    `;
    notification.innerHTML = '📝 要点確認を保存中...';
    document.body.appendChild(notification);
    
    setTimeout(() => notification.remove(), 2000);
}

function showPlanSaveNotification() {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 140px;
        right: 20px;
        background: linear-gradient(135deg, #00bcd4, #4dd0e1);
        color: white;
        padding: 12px 18px;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0, 188, 212, 0.4);
        z-index: 9999;
        font-weight: 600;
        font-size: 14px;
        animation: slideInRight 0.3s ease;
    `;
    notification.innerHTML = '📅 学習計画を保存中...';
    document.body.appendChild(notification);
    
    setTimeout(() => notification.remove(), 2000);
}

// 🧪 9. テスト機能の拡張
window.testAllSaves = function() {
    console.log("🧪 全保存機能テスト開始");
    
    if (!ULTRA_STABLE_USER_ID) {
        alert("❌ 固定IDが未設定です");
        return;
    }
    
    // 1. 学習記録テスト
    const testRecord = {
        type: "testRecord",
        test: "全保存テスト",
        timestamp: new Date().toISOString()
    };
    DataManager.saveToFirestore(testRecord);
    
    // 2. 学習計画テスト
    if (DataManager.saveStudyPlans) {
        DataManager.saveStudyPlans();
    }
    
    // 3. 問題集テスト
    if (DataManager.saveBooksToStorage) {
        DataManager.saveBooksToStorage();
    }
    
    // 4. 一問一答テスト
    if (DataManager.saveQAQuestions) {
        DataManager.saveQAQuestions();
    }
    
    alert("🧪 全保存機能テスト実行完了！\nFirebaseコンソールで確認してください。");
};

// 🎛️ 10. 管理ボタンの拡張（テストボタン追加）
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        const header = document.querySelector('.app-header');
        if (header && ULTRA_STABLE_USER_ID) {
            // 既存のテストボタンを更新
            const existingBtn = header.querySelector('[data-firebase-btn="true"]');
            if (existingBtn) {
                existingBtn.onclick = function() {
                    testAllSaves();
                };
                existingBtn.title = "全保存機能をテスト";
            }
        }
    }, 1500);
});

// デバッグ用関数をグローバルに追加
window.testAllSaves = testAllSaves;

console.log("🎉 全モジュールFirebase統合修正完了");
console.log("📋 対象:");
console.log("  ✅ カレンダー（学習計画）");
console.log("  ✅ 問題集・教材追加");
console.log("  ✅ 要点確認");
console.log("  ✅ 一問一答");
console.log("  ✅ CSV関連");
console.log("  ✅ 試験日設定");
console.log("🧪 テスト: testAllSaves()");
</script>
</body>
</html>
