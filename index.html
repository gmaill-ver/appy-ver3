<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å­¦ç¿’ãƒˆãƒ©ãƒƒã‚«ãƒ¼ - è¡Œæ”¿æ›¸å£«è©¦é¨“å¯¾ç­–</title>
    <link rel="stylesheet" href="styles.css">
    
    <!-- Firebase SDK (ã‚ªãƒ—ã‚·ãƒ§ãƒ³) -->
    <!-- Firebaseã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚’å¤–ã—ã¦ãã ã•ã„
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    -->
</head>
<body>
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="app-header">
        <button class="timer-icon-btn" onclick="App.openTimerModal()" title="ã‚¿ã‚¤ãƒãƒ¼">â°</button>
        <div class="timer-display" id="timerDisplay">00:00:00</div>
        <div class="app-logo">
            <span class="app-logo-icon">ğŸ“š</span>
            <span class="app-title">å­¦ç¿’ãƒˆãƒ©ãƒƒã‚«ãƒ¼</span>
        </div>
        <div class="exam-countdown" id="examCountdown">è©¦é¨“æ—¥ã¾ã§ <span class="days">--</span> æ—¥</div>
    </header>
    
    <!-- ãƒ¡ã‚¤ãƒ³ã‚¿ãƒ– -->
    <div class="main-tabs">
        <button class="main-tab active" onclick="App.switchMainTab('record', event)">è¨˜éŒ²å…¥åŠ›</button>
        <button class="main-tab" onclick="App.switchMainTab('analysis', event)">åˆ†æ</button>
        <button class="main-tab" onclick="App.switchMainTab('progress', event)">é€²æ—</button>
    </div>
    
    <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ -->
    <div class="content-area">
        <!-- è¨˜éŒ²å…¥åŠ›ã‚¿ãƒ– -->
        <div id="record-tab" class="tab-content active">
            <!-- å•é¡Œé›†é¸æŠ -->
            <div class="book-cards-wrapper">
                <button class="book-order-btn" onclick="App.toggleBookSort()">ä¸¦æ›¿ãˆ</button>
                <div id="bookCardsContainer"></div>
            </div>
            
            <!-- ãƒ‘ãƒ³ããšãƒªã‚¹ãƒˆ -->
            <div class="breadcrumb" id="breadcrumb" style="display: none;"></div>
            
            <!-- éšå±¤ãƒªã‚¹ãƒˆ -->
            <div id="recordHierarchyContainer" style="display: none;"></div>
            
            <!-- å•é¡Œå…¥åŠ› -->
            <div class="card" id="questionSection" style="display: none;">
                <div class="card-header">
                    <span class="card-icon">âœï¸</span>
                    <span class="card-title">å•é¡Œåˆ¥æ­£èª¤å…¥åŠ›</span>
                </div>
                
                <div class="action-buttons">
                    <button class="action-btn correct" onclick="App.markCorrect()">
                        <span>â­•</span><span>æ­£è§£</span>
                    </button>
                    <button class="action-btn wrong" onclick="App.markWrong()">
                        <span>âŒ</span><span>ä¸æ­£è§£</span>
                    </button>
                    <button class="action-btn bookmark" id="bookmarkBtn" onclick="App.toggleBookmarkMode()">
                        <span>â­</span><span>ãƒãƒ¼ã‚¯</span>
                    </button>
                </div>
                
                <div class="question-grid" id="questionGrid"></div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalCount">0</div>
                        <div class="stat-label">è§£ç­”æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="correctCount">0</div>
                        <div class="stat-label">æ­£è§£æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="wrongCount">0</div>
                        <div class="stat-label">ä¸æ­£è§£æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="correctRate">0%</div>
                        <div class="stat-label">æ­£ç­”ç‡</div>
                    </div>
                </div>
                
                <button class="save-button" onclick="App.saveRecord()">å­¦ç¿’è¨˜éŒ²ã‚’ä¿å­˜</button>
            </div>
            
            <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ -->
            <div class="calendar-container">
                <div class="calendar-header">
                    <div class="calendar-nav">
                        <button class="calendar-nav-btn" onclick="UIComponents.changeMonth(-1)">â—€</button>
                        <span class="calendar-month" id="calendarMonth">2025å¹´1æœˆ</span>
                        <button class="calendar-nav-btn" onclick="UIComponents.changeMonth(1)">â–¶</button>
                    </div>
                    <button class="calendar-nav-btn" onclick="UIComponents.goToToday()">ä»Šæ—¥</button>
                </div>
                <div class="calendar-grid" id="calendarGrid"></div>
                <div class="calendar-actions">
                    <button class="calendar-btn add-plan" onclick="UIComponents.openPlanModal()">ğŸ“ å­¦ç¿’è¨ˆç”»ã‚’è¿½åŠ </button>
                    <button class="calendar-btn view-plans" onclick="UIComponents.viewPlans()">ğŸ“‹ è¨ˆç”»ä¸€è¦§</button>
                </div>
            </div>
        </div>
        
        <!-- åˆ†æã‚¿ãƒ– -->
        <div id="analysis-tab" class="tab-content">
            <button class="card-sort-btn" onclick="App.toggleAnalysisSort()">ä¸¦æ›¿ãˆ</button>
            <div id="analysisCardsContainer">
                <!-- å­¦ç¿’ã‚°ãƒ©ãƒ• -->
                <div class="accordion card" data-card-id="chart">
                    <div class="accordion-header" onclick="App.toggleAccordion(this)">
                        <span>ğŸ“Š å­¦ç¿’ã‚°ãƒ©ãƒ•</span>
                        <span class="accordion-arrow">â–¼</span>
                    </div>
                    <div class="accordion-content">
                        <div class="chart-controls">
                            <button class="chart-btn active" onclick="Analytics.switchChartView('day', this)">æ—¥åˆ¥</button>
                            <button class="chart-btn" onclick="Analytics.switchChartView('week', this)">é€±é–“</button>
                            <button class="chart-btn" onclick="Analytics.switchChartView('month', this)">æœˆé–“</button>
                        </div>
                        <div class="chart-wrapper">
                            <div class="chart-bars" id="chartBars"></div>
                        </div>
                    </div>
                </div>
                
                <!-- å­¦ç¿’å±¥æ­´ -->
                <div class="accordion card" data-card-id="history">
                    <div class="accordion-header" onclick="App.toggleAccordion(this)">
                        <span>ğŸ“… å­¦ç¿’å±¥æ­´</span>
                        <span class="accordion-arrow">â–¼</span>
                    </div>
                    <div class="accordion-content">
                        <div id="historyContent"></div>
                    </div>
                </div>
                
                <!-- ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ— -->
                <div class="accordion card" data-card-id="heatmap">
                    <div class="accordion-header" onclick="App.toggleAccordion(this)">
                        <span>ğŸ—ºï¸ å•é¡Œãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—</span>
                        <span class="accordion-arrow">â–¼</span>
                    </div>
                    <div class="accordion-content">
                        <div class="heatmap-controls">
                            <select class="heatmap-select" id="heatmapBookSelect" onchange="Analytics.updateHeatmap()">
                                <option value="">å•é¡Œé›†ã‚’é¸æŠ</option>
                            </select>
                            <button class="heatmap-toggle-btn" id="heatmapToggleBtn" onclick="Analytics.toggleHeatmapPinned()">ğŸ“Œ å›ºå®š</button>
                        </div>
                        <div class="heatmap-grid" id="heatmapGrid"></div>
                    </div>
                </div>
                
                <!-- å¼±ç‚¹åˆ†æ -->
                <div class="accordion card" data-card-id="weakness">
                    <div class="accordion-header" onclick="App.toggleAccordion(this)">
                        <span>ğŸ¯ å¼±ç‚¹åˆ†æ</span>
                        <span class="accordion-arrow">â–¼</span>
                    </div>
                    <div class="accordion-content">
                        <div id="weaknessAnalysis"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- é€²æ—ã‚¿ãƒ– -->
        <div id="progress-tab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <span class="card-icon">ğŸ“Š</span>
                    <span class="card-title">å…¨ä½“é€²æ—çŠ¶æ³</span>
                </div>
                <div id="overallProgress"></div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <span class="card-icon">ğŸ“ˆ</span>
                    <span class="card-title">ç§‘ç›®åˆ¥é€²æ—</span>
                </div>
                <div class="radar-chart-container">
                    <div class="radar-chart-controls">
                        <select class="radar-chart-select" id="radarBookSelect" onchange="Analytics.drawRadarChart()">
                            <option value="">å•é¡Œé›†ã‚’é¸æŠ</option>
                        </select>
                        <button class="radar-toggle-btn" id="radarToggleBtn" onclick="Analytics.toggleRadarPinned()">ğŸ“Œ å›ºå®šè¡¨ç¤º</button>
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <button class="chart-btn active" id="radarModeSubject" onclick="Analytics.setRadarMode('subject', this)">ç§‘ç›®åˆ¥</button>
                            <button class="chart-btn" id="radarModeCompare" onclick="Analytics.setRadarMode('compare', this)">å•é¡Œé›†æ¯”è¼ƒ</button>
                        </div>
                    </div>
                    <canvas id="radarChart" width="300" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ãƒ•ãƒƒã‚¿ãƒ¼ã‚¿ãƒ– -->
    <div class="footer-tabs">
        <button class="footer-tab active" onclick="App.switchFooterTab('register', event)">
            <span class="footer-tab-icon">ğŸ“</span>
            <span class="footer-tab-label">ç™»éŒ²</span>
        </button>
        <button class="footer-tab" onclick="App.switchFooterTab('qa', event)">
            <span class="footer-tab-icon">â“</span>
            <span class="footer-tab-label">ä¸€å•ä¸€ç­”</span>
        </button>
        <button class="footer-tab" onclick="App.switchFooterTab('keypoints', event)">
            <span class="footer-tab-icon">ğŸ“š</span>
            <span class="footer-tab-label">è¦ç‚¹ç¢ºèª</span>
        </button>
        <button class="footer-tab" onclick="App.switchFooterTab('results', event)">
            <span class="footer-tab-icon">ğŸ†</span>
            <span class="footer-tab-label">å®Ÿç¸¾</span>
        </button>
        <button class="footer-tab" onclick="App.switchFooterTab('settings', event)">
            <span class="footer-tab-icon">âš™ï¸</span>
            <span class="footer-tab-label">è¨­å®š</span>
        </button>
    </div>
    
    <!-- ã‚¿ã‚¤ãƒãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="timerModal" class="timer-modal">
        <div class="timer-modal-content">
            <div class="modal-header">
                <h3>â° ã‚¿ã‚¤ãƒãƒ¼</h3>
                <button class="modal-close" onclick="TimerModule.closeModal()">Ã—</button>
            </div>
            
            <div class="timer-tabs">
                <button class="timer-tab active" onclick="TimerModule.switchTab('stopwatch', this)">ã‚¹ãƒˆãƒƒãƒ—ã‚¦ã‚©ãƒƒãƒ</button>
                <button class="timer-tab" onclick="TimerModule.switchTab('countdown', this)">ã‚¿ã‚¤ãƒãƒ¼</button>
                <button class="timer-tab" onclick="TimerModule.switchTab('interval', this)">ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«</button>
            </div>
            
            <div id="stopwatchTab" class="timer-tab-content">
                <div class="timer-display-large" id="stopwatchDisplay">00:00:00</div>
                <div class="timer-controls">
                    <button class="timer-btn start" onclick="TimerModule.startStopwatch()">é–‹å§‹</button>
                    <button class="timer-btn pause" onclick="TimerModule.pauseStopwatch()">ä¸€æ™‚åœæ­¢</button>
                    <button class="timer-btn reset" onclick="TimerModule.resetStopwatch()">ãƒªã‚»ãƒƒãƒˆ</button>
                </div>
            </div>
            
            <div id="countdownTab" class="timer-tab-content" style="display: none;">
                <div class="timer-input-group">
                    <label class="timer-input-label">ã‚¿ã‚¤ãƒãƒ¼è¨­å®š</label>
                    <div class="timer-input-row">
                        <input type="number" class="timer-input" id="countdownHours" placeholder="æ™‚" min="0" max="23">
                        <span>æ™‚é–“</span>
                        <input type="number" class="timer-input" id="countdownMinutes" placeholder="åˆ†" min="0" max="59">
                        <span>åˆ†</span>
                        <input type="number" class="timer-input" id="countdownSeconds" placeholder="ç§’" min="0" max="59">
                        <span>ç§’</span>
                    </div>
                </div>
                <div class="timer-display-large" id="countdownDisplay">00:00:00</div>
                <div class="timer-controls">
                    <button class="timer-btn start" onclick="TimerModule.startCountdown()">é–‹å§‹</button>
                    <button class="timer-btn pause" onclick="TimerModule.pauseCountdown()">ä¸€æ™‚åœæ­¢</button>
                    <button class="timer-btn reset" onclick="TimerModule.resetCountdown()">ãƒªã‚»ãƒƒãƒˆ</button>
                </div>
            </div>
            
            <div id="intervalTab" class="timer-tab-content" style="display: none;">
                <div class="timer-input-group">
                    <label class="timer-input-label">ä½œæ¥­æ™‚é–“</label>
                    <div class="timer-input-row">
                        <input type="number" class="timer-input" id="workMinutes" value="25" min="1">
                        <span>åˆ†</span>
                    </div>
                </div>
                <div class="timer-input-group">
                    <label class="timer-input-label">ä¼‘æ†©æ™‚é–“</label>
                    <div class="timer-input-row">
                        <input type="number" class="timer-input" id="breakMinutes" value="5" min="1">
                        <span>åˆ†</span>
                    </div>
                </div>
                <div class="timer-input-group">
                    <label class="timer-input-label">ã‚»ãƒƒãƒˆæ•°</label>
                    <div class="timer-input-row">
                        <input type="number" class="timer-input" id="intervalSets" value="4" min="1">
                        <span>ã‚»ãƒƒãƒˆ</span>
                    </div>
                </div>
                <div class="timer-display-large" id="intervalDisplay">00:00</div>
                <div style="text-align: center; margin: 10px 0;">
                    <span id="intervalStatus">å¾…æ©Ÿä¸­</span> | 
                    <span id="intervalSetCount">0/0 ã‚»ãƒƒãƒˆ</span>
                </div>
                <div class="timer-controls">
                    <button class="timer-btn start" onclick="TimerModule.startInterval()">é–‹å§‹</button>
                    <button class="timer-btn pause" onclick="TimerModule.pauseInterval()">ä¸€æ™‚åœæ­¢</button>
                    <button class="timer-btn reset" onclick="TimerModule.resetInterval()">ãƒªã‚»ãƒƒãƒˆ</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- å­¦ç¿’è¨ˆç”»ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="planModal" class="plan-modal">
        <div class="plan-modal-content">
            <div class="modal-header">
                <h3 id="planModalTitle">ğŸ“… å­¦ç¿’è¨ˆç”»</h3>
                <button class="modal-close" onclick="UIComponents.closePlanModal()">Ã—</button>
            </div>
            
            <div id="planFormSection">
                <div class="plan-form-group">
                    <label class="plan-form-label">è¨ˆç”»ã‚¿ã‚¤ãƒˆãƒ«</label>
                    <input type="text" class="plan-form-control" id="planTitle" placeholder="ä¾‹ï¼šæ°‘æ³•ç·å‰‡ã®å¾©ç¿’">
                </div>
                
                <div class="plan-form-group">
                    <label class="plan-form-label">è¨ˆç”»å†…å®¹</label>
                    <textarea class="plan-form-control" id="planContent" rows="3" placeholder="å­¦ç¿’å†…å®¹ã®è©³ç´°ã‚’å…¥åŠ›"></textarea>
                </div>
                
                <div class="plan-form-group">
                    <label class="plan-form-label">è¡¨ç¤ºå½¢å¼</label>
                    <div class="plan-display-type">
                        <label>
                            <input type="radio" name="displayType" value="bullet" checked>
                            <span>ãƒ»</span>
                        </label>
                        <label>
                            <input type="radio" name="displayType" value="text">
                            <span>é€šå¸¸è¡¨ç¤º</span>
                        </label>
                    </div>
                </div>
                
                <div class="plan-form-group">
                    <label class="plan-form-label">æ—¥ä»˜ç¯„å›²</label>
                    <div class="date-range-inputs">
                        <input type="date" class="plan-form-control" id="planStartDate">
                        <span>ã€œ</span>
                        <input type="date" class="plan-form-control" id="planEndDate">
                    </div>
                </div>
                
                <div class="plan-form-group">
                    <label class="plan-form-label">è‰²è¨­å®š</label>
                    <div class="color-picker" id="colorPicker">
                        <div class="color-option selected" style="background: #3498db;" data-color="#3498db"></div>
                        <div class="color-option" style="background: #10b981;" data-color="#10b981"></div>
                        <div class="color-option" style="background: #f59e0b;" data-color="#f59e0b"></div>
                        <div class="color-option" style="background: #ef4444;" data-color="#ef4444"></div>
                        <div class="color-option" style="background: #8b5cf6;" data-color="#8b5cf6"></div>
                        <div class="color-option" style="background: #ec4899;" data-color="#ec4899"></div>
                        <div class="color-option" style="background: #6b7280;" data-color="#6b7280"></div>
                    </div>
                </div>
                
                <input type="hidden" id="editPlanId" value="">
                <button class="save-button" onclick="UIComponents.savePlan()">è¨ˆç”»ã‚’ä¿å­˜</button>
            </div>
            
            <div id="planListSection" style="display: none;">
                <h4>ç™»éŒ²æ¸ˆã¿ã®è¨ˆç”»</h4>
                <div class="plan-list" id="planListContent"></div>
            </div>
        </div>
    </div>
    
    <!-- ãƒ•ãƒƒã‚¿ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="footerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">ã‚¿ã‚¤ãƒˆãƒ«</h3>
                <button class="modal-close" onclick="App.closeFooterModal()">Ã—</button>
            </div>
            <div id="modalBody"></div>
        </div>
        <div class="modal-footer">
            <button class="modal-close-bottom" onclick="App.closeFooterModal()">é–‰ã˜ã‚‹</button>
        </div>
    </div>
    
    <!-- å…¥åŠ›ãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
    <div id="dialogOverlay" class="dialog-overlay" style="display: none;"></div>
    <div id="inputDialog" class="input-dialog" style="display: none;">
        <h3 id="dialogTitle">ã‚¿ã‚¤ãƒˆãƒ«</h3>
        <div id="dialogBody"></div>
        <div class="dialog-buttons">
            <button class="dialog-btn secondary" onclick="App.closeDialog()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button class="dialog-btn primary" id="dialogConfirmBtn">ç¢ºå®š</button>
        </div>
    </div>
    
    <!-- Firebase SDK v9 (Compatç‰ˆ) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
// Firebaseè¨­å®š
const firebaseConfig = {
    apiKey: "AIzaSyCa3-o7VIbxDzZDy7_SPHTk1kqpq23I79s",
    authDomain: "gakushusintyoku.firebaseapp.com",
    projectId: "gakushusintyoku",
    storageBucket: "gakushusintyoku.firebasestorage.app",
    messagingSenderId: "386582438890",
    appId: "1:386582438890:web:78cd619f0d7ad3ae5a0893"
};

// FirebaseåˆæœŸåŒ–
firebase.initializeApp(firebaseConfig);

// Firestoreã®åˆæœŸåŒ–ã¨åŒæœŸå‡¦ç†ï¼ˆ1å›ã ã‘ï¼ï¼‰
const db = firebase.firestore();

// ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼çŠ¶æ…‹ã®ç›£è¦–
firebase.auth().onAuthStateChanged((user) => {
    if (user) {
        console.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸ:', user.uid);
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼å›ºæœ‰ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç›£è¦–
        const userRef = db.collection('users').doc(user.uid);
        
        // ãƒ‡ãƒ¼ã‚¿ä¿å­˜é–¢æ•°
        window.saveUserData = function(data) {
            userRef.set(data, { merge: true })
                .then(() => {
                    console.log('ãƒ‡ãƒ¼ã‚¿ä¿å­˜æˆåŠŸ');
                    alert('ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
                })
                .catch((error) => {
                    console.error('ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                    alert('ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
                });
        };
        
        // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–¢æ•°ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ï¼‰
        userRef.onSnapshot((doc) => {
            if (doc.exists) {
                const userData = doc.data();
                console.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿:', userData);
                
                // ãƒ‡ãƒ¼ã‚¿ã‚’ç”»é¢ã«åæ˜ ã™ã‚‹å‡¦ç†
                if (userData.allRecords) {
                    DataManager.allRecords = userData.allRecords;
                    if (window.Analytics) {
                        Analytics.updateHistoryContent();
                    }
                }
                
                if (userData.books) {
                    DataManager.books = userData.books;
                }
            } else {
                console.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }
        }, (error) => {
            console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        });
        
        // å®šæœŸçš„ãªè‡ªå‹•ä¿å­˜
        setInterval(() => {
            const dataToSave = {
                allRecords: DataManager.allRecords,
                books: DataManager.books,
                studyPlans: DataManager.studyPlans,
            };
            
            saveUserData(dataToSave);
        }, 5 * 60 * 1000); // 5åˆ†ã”ã¨ã«è‡ªå‹•ä¿å­˜
    } else {
        console.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¦ã„ã¾ã™');
    }
});

// ãƒ‡ãƒãƒƒã‚°ç”¨ã®æ‰‹å‹•ä¿å­˜ãƒœã‚¿ãƒ³ï¼ˆå¿…è¦ã«å¿œã˜ã¦è¿½åŠ ï¼‰
function manualSaveData() {
    const user = firebase.auth().currentUser;
    if (user) {
        const dataToSave = {
            allRecords: DataManager.allRecords,
            books: DataManager.books,
            studyPlans: DataManager.studyPlans,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        db.collection('users').doc(user.uid).set(dataToSave, { merge: true })
            .then(() => {
                console.log('æ‰‹å‹•ã§ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
                alert('ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
            })
            .catch((error) => {
                console.error('æ‰‹å‹•ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
            });
    } else {
        alert('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„');
    }
}
</script>

<!-- JavaScript ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«èª­ã¿è¾¼ã¿ï¼ˆé †åºé‡è¦ï¼‰ -->
<script src="data-manager.js"></script>
<script src="ui-components.js"></script>
<script src="analytics.js"></script>
<script src="qa-module.js"></script>
<script src="timer-module.js"></script>
<script src="keypoints-module.js"></script>
<script src="app.js"></script>

<!-- ğŸ”¥ å›ºå®šãƒ¦ãƒ¼ã‚¶ãƒ¼IDç‰ˆFirebaseçµ±åˆã‚³ãƒ¼ãƒ‰ -->
<script>
console.log("ğŸš€ å›ºå®šãƒ¦ãƒ¼ã‚¶ãƒ¼IDç‰ˆFirebaseçµ±åˆé–‹å§‹");

// Firebaseã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ°¸ç¶šåŒ–ã‚’æœ‰åŠ¹ã«ã™ã‚‹
try {
    firebase.firestore().enablePersistence({ synchronizeTabs: true })
        .then(() => {
            console.log("âœ… ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ°¸ç¶šåŒ–æœ‰åŠ¹ï¼ˆã‚¿ãƒ–åŒæœŸã‚ã‚Šï¼‰");
        })
        .catch((err) => {
            console.log("âš ï¸ æ°¸ç¶šåŒ–ã‚¨ãƒ©ãƒ¼:", err.code);
        });
} catch (error) {
    console.log("âš ï¸ æ°¸ç¶šåŒ–è¨­å®šã‚¨ãƒ©ãƒ¼:", error);
}

// ğŸ”‘ å›ºå®šãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å–å¾—ãƒ»ç”Ÿæˆï¼ˆè¤‡æ•°ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å¯¾å¿œï¼‰
function getFixedUserId() {
    // è¤‡æ•°ã®å ´æ‰€ã‹ã‚‰IDã‚’å–å¾—è©¦è¡Œ
    let userId = localStorage.getItem('fixedUserId') || 
                 sessionStorage.getItem('fixedUserId') ||
                 getCookieValue('fixedUserId');
    
    if (!userId) {
        // å›ºå®šIDã‚’ç”Ÿæˆï¼ˆãƒ‡ãƒã‚¤ã‚¹å›ºæœ‰ï¼‹ãƒ–ãƒ©ã‚¦ã‚¶ãƒ•ã‚£ãƒ³ã‚¬ãƒ¼ãƒ—ãƒªãƒ³ãƒˆï¼‰
        const timestamp = Date.now();
        const random = Math.random().toString(36).substr(2, 9);
        const device = /Mobile|Android|iPhone|iPad/.test(navigator.userAgent) ? 'mobile' : 'desktop';
        const fingerprint = btoa(navigator.userAgent + navigator.language + screen.width + screen.height).substr(0, 8);
        userId = `${device}_${timestamp}_${random}_${fingerprint}`;
        
        // è¤‡æ•°ã®å ´æ‰€ã«ä¿å­˜
        localStorage.setItem('fixedUserId', userId);
        sessionStorage.setItem('fixedUserId', userId);
        setCookie('fixedUserId', userId, 365); // 1å¹´é–“æœ‰åŠ¹
        
        console.log("ğŸ†• æ–°ã—ã„å›ºå®šãƒ¦ãƒ¼ã‚¶ãƒ¼IDç”Ÿæˆ:", userId);
    } else {
        // è¦‹ã¤ã‹ã£ãŸIDã‚’å…¨ã¦ã®å ´æ‰€ã«ä¿å­˜ï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼‰
        localStorage.setItem('fixedUserId', userId);
        sessionStorage.setItem('fixedUserId', userId);
        setCookie('fixedUserId', userId, 365);
        console.log("âœ… æ—¢å­˜ã®å›ºå®šãƒ¦ãƒ¼ã‚¶ãƒ¼IDä½¿ç”¨:", userId);
    }
    return userId;
}

// Cookieæ“ä½œãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
function setCookie(name, value, days) {
    const expires = new Date();
    expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));
    document.cookie = `${name}=${value};expires=${expires.toUTCString()};path=/;SameSite=Lax`;
}

function getCookieValue(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return null;
}

// å›ºå®šãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å–å¾—
const FIXED_USER_ID = getFixedUserId();

// çµ±åˆãƒ‡ãƒ¼ã‚¿ä¿å­˜å‡¦ç†ï¼ˆå›ºå®šIDç‰ˆï¼‰
DataManager.saveToFirestore = async function(data) {
    try {
        console.log("ğŸ“¤ å›ºå®šIDçµ±åˆä¿å­˜é–‹å§‹ - ãƒ¦ãƒ¼ã‚¶ãƒ¼:", FIXED_USER_ID);
        console.log("ğŸ“¤ ä¿å­˜ãƒ‡ãƒ¼ã‚¿:", data);
        
        // å›ºå®šãƒ¦ãƒ¼ã‚¶ãƒ¼IDã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«çµ±åˆä¿å­˜
        const userRef = db.collection('fixedUsers').doc(FIXED_USER_ID);
        
        // ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        const userDoc = await userRef.get();
        let existingData = userDoc.exists ? userDoc.data() : {
            userId: FIXED_USER_ID,
            createdAt: new Date().toISOString(),
            deviceInfo: {
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                language: navigator.language,
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
            }
        };
        
        // å­¦ç¿’è¨˜éŒ²ã‚’é…åˆ—ã«è¿½åŠ ï¼ˆæœ€æ–°100ä»¶ã¾ã§ä¿æŒï¼‰
        if (!existingData.studyRecords) {
            existingData.studyRecords = [];
        }
        
        // æ–°ã—ã„è¨˜éŒ²ã‚’è¿½åŠ 
        const newRecord = {
            ...data,
            timestamp: new Date().toISOString(),
            deviceType: /Mobile|Android|iPhone|iPad/.test(navigator.userAgent) ? 'mobile' : 'desktop',
            id: Date.now().toString(),
            recordId: 'rec_' + Date.now() + '_' + Math.random().toString(36).substr(2, 6)
        };
        
        existingData.studyRecords.unshift(newRecord); // å…ˆé ­ã«è¿½åŠ 
        
        // æœ€æ–°100ä»¶ã¾ã§ä¿æŒ
        if (existingData.studyRecords.length > 100) {
            existingData.studyRecords = existingData.studyRecords.slice(0, 100);
        }
        
        // LocalStorageãƒ‡ãƒ¼ã‚¿ã‚‚çµ±åˆä¿å­˜
        existingData.allRecords = DataManager.allRecords || [];
        existingData.books = DataManager.books || {};
        existingData.studyPlans = DataManager.studyPlans || [];
        existingData.qaQuestions = DataManager.qaQuestions || {};
        existingData.csvTemplates = DataManager.csvTemplates || {};
        existingData.examDate = DataManager.examDate ? DataManager.examDate.toISOString() : null;
        existingData.heatmapPinnedBook = DataManager.heatmapPinnedBook || null;
        existingData.radarPinnedBook = DataManager.radarPinnedBook || null;
        existingData.bookOrder = DataManager.bookOrder || [];
        existingData.analysisCardOrder = DataManager.analysisCardOrder || [];
        
        // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿æ›´æ–°
        existingData.lastUpdated = new Date().toISOString();
        existingData.lastDevice = /Mobile|Android|iPhone|iPad/.test(navigator.userAgent) ? 'mobile' : 'desktop';
        existingData.lastUserAgent = navigator.userAgent;
        existingData.syncCount = (existingData.syncCount || 0) + 1;
        
        // Firestoreã«ä¿å­˜
        await userRef.set(existingData, { merge: true });
        
        console.log("âœ… å›ºå®šIDçµ±åˆä¿å­˜æˆåŠŸ - è¨˜éŒ²æ•°:", existingData.studyRecords.length);
        
        // æˆåŠŸé€šçŸ¥
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #4caf50, #81c784);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(76, 175, 80, 0.3);
            z-index: 9999;
            font-weight: 600;
            animation: slideIn 0.3s ease;
        `;
        notification.innerHTML = `
            âœ… ä¿å­˜å®Œäº†ï¼<br>
            è¨˜éŒ²æ•°: ${existingData.studyRecords.length}<br>
            ID: ${FIXED_USER_ID.substr(0, 12)}...
        `;
        document.body.appendChild(notification);
        
        // 3ç§’å¾Œã«è‡ªå‹•å‰Šé™¤
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 3000);
        
        // å±¥æ­´ã‚’å³åº§ã«æ›´æ–°
        updateFixedHistoryDisplay(existingData);
        
        return true;
    } catch (error) {
        console.error("âŒ å›ºå®šIDçµ±åˆä¿å­˜å¤±æ•—:", error);
        
        // ã‚¨ãƒ©ãƒ¼é€šçŸ¥
        const errorNotification = document.createElement('div');
        errorNotification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #f44336, #ef5350);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(244, 67, 54, 0.3);
            z-index: 9999;
            font-weight: 600;
        `;
        errorNotification.innerHTML = `âŒ ä¿å­˜å¤±æ•—<br>${error.message}`;
        document.body.appendChild(errorNotification);
        
        setTimeout(() => {
            if (errorNotification.parentNode) {
                errorNotification.remove();
            }
        }, 5000);
        
        return false;
    }
};

// çµ±åˆãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ãƒ»å¾©å…ƒå‡¦ç†ï¼ˆå¼·åŒ–ç‰ˆï¼‰
DataManager.loadFromFirestore = function() {
    console.log("ğŸ“¥ å›ºå®šIDçµ±åˆãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–‹å§‹ - ID:", FIXED_USER_ID);
    
    const userRef = db.collection('fixedUsers').doc(FIXED_USER_ID);
    
    // åˆå›å³åº§ã«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–ã®å‰ã«ï¼‰
    userRef.get().then((doc) => {
        if (doc.exists) {
            console.log("ğŸ“¥ åˆå›ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ");
            restoreDataFromFirebase(doc.data());
        } else {
            console.log("ğŸ“­ åˆå›ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼šãƒ‡ãƒ¼ã‚¿ãªã—");
        }
    }).catch((error) => {
        console.error("âŒ åˆå›ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:", error);
    });
    
    // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ç›£è¦–
    userRef.onSnapshot((doc) => {
        if (doc.exists) {
            const userData = doc.data();
            console.log("ğŸ“¥ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°æ¤œçŸ¥ - åŒæœŸå›æ•°:", userData.syncCount || 0);
            restoreDataFromFirebase(userData);
        } else {
            console.log("ğŸ“­ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ï¼šãƒ‡ãƒ¼ã‚¿ãªã—ï¼ˆåˆå›åˆ©ç”¨ï¼‰");
            scheduleInitialDataSave();
        }
    }, (error) => {
        console.error("âŒ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–ã‚¨ãƒ©ãƒ¼:", error);
    });
};

// ãƒ‡ãƒ¼ã‚¿å¾©å…ƒå‡¦ç†ã‚’é–¢æ•°åŒ–
function restoreDataFromFirebase(userData) {
    let restoredCount = 0;
    
    // å­¦ç¿’å±¥æ­´å¾©å…ƒ
    if (userData.allRecords && Array.isArray(userData.allRecords)) {
        DataManager.allRecords = userData.allRecords;
        localStorage.setItem('studyHistory', JSON.stringify(userData.allRecords));
        console.log("âœ… å­¦ç¿’å±¥æ­´å¾©å…ƒ:", userData.allRecords.length + "ä»¶");
        restoredCount++;
    }
    
    // å•é¡Œé›†ãƒ‡ãƒ¼ã‚¿å¾©å…ƒ
    if (userData.books && typeof userData.books === 'object') {
        DataManager.books = userData.books;
        localStorage.setItem('studyTrackerBooks', JSON.stringify(userData.books));
        console.log("âœ… å•é¡Œé›†ãƒ‡ãƒ¼ã‚¿å¾©å…ƒ:", Object.keys(userData.books).length + "å†Š");
        restoredCount++;
    }
    
    // å­¦ç¿’è¨ˆç”»å¾©å…ƒ
    if (userData.studyPlans && Array.isArray(userData.studyPlans)) {
        DataManager.studyPlans = userData.studyPlans;
        localStorage.setItem('studyPlans', JSON.stringify(userData.studyPlans));
        console.log("âœ… å­¦ç¿’è¨ˆç”»å¾©å…ƒ:", userData.studyPlans.length + "ä»¶");
        restoredCount++;
    }
    
    // ä¸€å•ä¸€ç­”å¾©å…ƒ
    if (userData.qaQuestions && typeof userData.qaQuestions === 'object') {
        DataManager.qaQuestions = userData.qaQuestions;
        localStorage.setItem('qaQuestions', JSON.stringify(userData.qaQuestions));
        console.log("âœ… ä¸€å•ä¸€ç­”å¾©å…ƒ:", Object.keys(userData.qaQuestions).length + "ã‚»ãƒƒãƒˆ");
        restoredCount++;
    }
    
    // CSVãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå¾©å…ƒ
    if (userData.csvTemplates && typeof userData.csvTemplates === 'object') {
        DataManager.csvTemplates = userData.csvTemplates;
        localStorage.setItem('csvTemplates', JSON.stringify(userData.csvTemplates));
        console.log("âœ… CSVãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå¾©å…ƒ:", Object.keys(userData.csvTemplates).length + "ä»¶");
        restoredCount++;
    }
    
    // è©¦é¨“æ—¥å¾©å…ƒ
    if (userData.examDate) {
        try {
            DataManager.examDate = new Date(userData.examDate);
            localStorage.setItem('examDate', userData.examDate);
            console.log("âœ… è©¦é¨“æ—¥å¾©å…ƒ:", DataManager.examDate);
            restoredCount++;
        } catch (e) {
            console.log("âš ï¸ è©¦é¨“æ—¥å¾©å…ƒã‚¨ãƒ©ãƒ¼");
        }
    }
    
    // ãã®ä»–è¨­å®šå¾©å…ƒ
    if (userData.heatmapPinnedBook) {
        DataManager.heatmapPinnedBook = userData.heatmapPinnedBook;
        localStorage.setItem('heatmapPinnedBook', userData.heatmapPinnedBook);
        restoredCount++;
    }
    
    if (userData.radarPinnedBook) {
        DataManager.radarPinnedBook = userData.radarPinnedBook;
        localStorage.setItem('radarPinnedBook', userData.radarPinnedBook);
        restoredCount++;
    }
    
    if (userData.bookOrder && Array.isArray(userData.bookOrder)) {
        DataManager.bookOrder = userData.bookOrder;
        localStorage.setItem('bookOrder', JSON.stringify(userData.bookOrder));
        restoredCount++;
    }
    
    if (userData.analysisCardOrder && Array.isArray(userData.analysisCardOrder)) {
        DataManager.analysisCardOrder = userData.analysisCardOrder;
        localStorage.setItem('analysisCardOrder', JSON.stringify(userData.analysisCardOrder));
        restoredCount++;
    }
    
    // å¾©å…ƒå®Œäº†é€šçŸ¥
    if (restoredCount > 0) {
        showRestoreNotification(restoredCount, userData.syncCount || 0);
    }
    
    // å­¦ç¿’è¨˜éŒ²å±¥æ­´ã‚’è¡¨ç¤º
    updateFixedHistoryDisplay(userData);
    
    // ç”»é¢ã‚’æ›´æ–°ï¼ˆå°‘ã—é…å»¶ã•ã›ã¦ç¢ºå®Ÿã«å®Ÿè¡Œï¼‰
    setTimeout(() => {
        updateAllUI();
    }, 300);
    
    console.log(`âœ… å›ºå®šIDå…¨ãƒ‡ãƒ¼ã‚¿å¾©å…ƒå®Œäº† - å¾©å…ƒé …ç›®æ•°: ${restoredCount}, åŒæœŸå›æ•°: ${userData.syncCount || 0}`);
}

// UIæ›´æ–°å‡¦ç†
function updateAllUI() {
    try {
        if (window.App && typeof App.renderBookCards === 'function') {
            App.renderBookCards();
        }
        if (window.Analytics && typeof Analytics.updateHistoryContent === 'function') {
            Analytics.updateHistoryContent();
        }
        if (window.Analytics && typeof Analytics.updateHeatmapBookSelect === 'function') {
            Analytics.updateHeatmapBookSelect();
            Analytics.updateRadarBookSelect();
        }
        if (window.UIComponents && typeof UIComponents.updateExamCountdown === 'function') {
            UIComponents.updateExamCountdown();
        }
        console.log("âœ… UIæ›´æ–°å®Œäº†");
    } catch (error) {
        console.error("âš ï¸ UIæ›´æ–°ã‚¨ãƒ©ãƒ¼:", error);
    }
}

// åˆå›ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
function scheduleInitialDataSave() {
    setTimeout(() => {
        if (DataManager.books && Object.keys(DataManager.books).length > 0) {
            console.log("ğŸ’¾ åˆå›ãƒ‡ãƒ¼ã‚¿ã‚’Firestoreã«ä¿å­˜");
            DataManager.saveToFirestore({
                type: "initialDataMigration",
                message: "åˆå›LocalStorageãƒ‡ãƒ¼ã‚¿ã‚’Firestoreã«ç§»è¡Œ",
                dataInfo: {
                    books: Object.keys(DataManager.books).length,
                    records: DataManager.allRecords ? DataManager.allRecords.length : 0,
                    plans: DataManager.studyPlans ? DataManager.studyPlans.length : 0
                },
                migrationTime: new Date().toISOString()
            });
        }
    }, 3000);
}

// å¾©å…ƒå®Œäº†é€šçŸ¥
function showRestoreNotification(restoredCount, syncCount) {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 80px;
        right: 20px;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
        z-index: 9999;
        font-weight: 600;
        animation: slideIn 0.3s ease;
        max-width: 300px;
    `;
    notification.innerHTML = `
        ğŸ”„ ãƒ‡ãƒ¼ã‚¿å¾©å…ƒå®Œäº†ï¼<br>
        å¾©å…ƒé …ç›®: ${restoredCount}å€‹<br>
        åŒæœŸå›æ•°: ${syncCount}å›<br>
        ID: ${FIXED_USER_ID.substr(0, 15)}...
    `;
    document.body.appendChild(notification);
    
    // 5ç§’å¾Œã«è‡ªå‹•å‰Šé™¤
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

// å›ºå®šIDå±¥æ­´è¡¨ç¤º
function updateFixedHistoryDisplay(userData) {
    const container = document.getElementById('historyContent');
    if (!container) return;
    
    // æ—¢å­˜ã®çµ±åˆå±¥æ­´ã‚’ã‚¯ãƒªã‚¢
    const existingItems = container.querySelectorAll('[data-fixed-history]');
    existingItems.forEach(item => item.remove());
    
    // å›ºå®šIDãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¿½åŠ 
    const headerItem = document.createElement('div');
    headerItem.setAttribute('data-fixed-history', 'header');
    headerItem.style.cssText = 'padding: 15px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border-radius: 10px; margin-bottom: 10px; text-align: center; position: relative;';
    headerItem.innerHTML = `
        <div style="font-weight: 700; font-size: 16px; margin-bottom: 5px;">
            ğŸ”’ å›ºå®šIDåŒæœŸå®Œäº†
        </div>
        <div style="font-size: 13px; opacity: 0.9;">
            å›ºå®šID: ${FIXED_USER_ID.substr(0, 20)}...
        </div>
        <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">
            è¨˜éŒ²: ${userData.studyRecords ? userData.studyRecords.length : 0}ä»¶ | åŒæœŸ: ${userData.syncCount || 0}å›
        </div>
        <div style="font-size: 11px; opacity: 0.7; margin-top: 5px;">
            æœ€çµ‚æ›´æ–°: ${userData.lastDevice || 'unknown'} - ${userData.lastUpdated ? new Date(userData.lastUpdated).toLocaleString('ja-JP') : 'ä¸æ˜'}
        </div>
    `;
    container.insertBefore(headerItem, container.firstChild);
    
    // æœ€æ–°10ä»¶ã®è¨˜éŒ²ã‚’è¡¨ç¤º
    if (userData.studyRecords && userData.studyRecords.length > 0) {
        const recentRecords = userData.studyRecords.slice(0, 10);
        recentRecords.forEach((record, index) => {
            const item = document.createElement('div');
            item.setAttribute('data-fixed-history', 'record');
            item.style.cssText = 'padding: 12px; background: linear-gradient(135deg, #f8f9fa, #e9ecef); border-left: 4px solid #667eea; border-radius: 8px; margin-bottom: 8px;';
            
            const timeStr = new Date(record.timestamp).toLocaleString('ja-JP');
            
            item.innerHTML = `
                <div style="font-weight: 600; color: #495057; margin-bottom: 5px;">
                    ğŸ“± ${record.deviceType} - ${record.type || 'ãƒ‡ãƒ¼ã‚¿'}
                </div>
                <div style="font-size: 12px; color: #6c757d; margin-bottom: 8px;">
                    ğŸ“… ${timeStr} | ID: ${record.recordId || 'N/A'}
                </div>
                <div style="font-size: 11px; background: white; padding: 8px; border-radius: 4px; font-family: monospace; max-height: 60px; overflow: hidden;">
                    ${JSON.stringify(record, null, 1).substring(0, 200)}...
                </div>
            `;
            
            container.insertBefore(item, container.children[1]); // ãƒ˜ãƒƒãƒ€ãƒ¼ã®æ¬¡ã«æŒ¿å…¥
        });
    }
}

// ä¿å­˜ãƒœã‚¿ãƒ³ã®å‹•ä½œã‚’æ‹¡å¼µï¼ˆå›ºå®šIDç‰ˆï¼‰
const originalSaveRecord = App.saveRecord;
App.saveRecord = function() {
    console.log("ğŸ’¾ App.saveRecord å®Ÿè¡Œï¼ˆå›ºå®šIDç‰ˆï¼‰");
    originalSaveRecord.call(this);
    
    const record = {
        type: "studyRecord",
        bookId: this.currentBook?.id,
        bookName: this.currentBook?.name,
        path: this.currentPath ? [...this.currentPath] : [],
        questionsCount: this.questionStates ? Object.keys(this.questionStates).length : 0,
        stats: {
            total: parseInt(document.getElementById('totalCount')?.textContent || '0'),
            correct: parseInt(document.getElementById('correctCount')?.textContent || '0'),
            wrong: parseInt(document.getElementById('wrongCount')?.textContent || '0'),
            rate: document.getElementById('correctRate')?.textContent || '0%'
        }
    };
    
    console.log("ğŸ’¾ å­¦ç¿’è¨˜éŒ²ã‚’å›ºå®šIDçµ±åˆä¿å­˜:", record);
    DataManager.saveToFirestore(record);
};

// å›ºå®šIDãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ã¨ç®¡ç†æ©Ÿèƒ½
document.addEventListener('DOMContentLoaded', function() {
    console.log("ğŸ¯ å›ºå®šIDç®¡ç†æ©Ÿèƒ½è¿½åŠ ");
    
    const header = document.querySelector('.app-header');
    if (header) {
        // æ—¢å­˜ãƒœã‚¿ãƒ³ã‚’å‰Šé™¤
        const existingBtn = header.querySelector('[data-test-firebase]');
        if (existingBtn) existingBtn.remove();
        
        // ãƒ¡ã‚¤ãƒ³ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³
        const testBtn = document.createElement('button');
        testBtn.setAttribute('data-test-firebase', 'true');
        testBtn.textContent = 'ğŸ”’å›ºå®š';
        testBtn.style.cssText = `
            position: absolute;
            top: 20px;
            left: 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            border-radius: 8px;
            color: white;
            padding: 10px 15px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 3px 15px rgba(102, 126, 234, 0.4);
            z-index: 1000;
        `;
        testBtn.onclick = function() {
            console.log("ğŸ”’ å›ºå®šIDãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯");
            
            const testData = {
                test: "å›ºå®šIDãƒ†ã‚¹ãƒˆ_" + Date.now(),
                message: "å›ºå®šãƒ¦ãƒ¼ã‚¶ãƒ¼ID + ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ–ãƒ†ã‚¹ãƒˆ",
                userAgent: navigator.userAgent,
                fixedUserId: FIXED_USER_ID,
                randomValue: Math.random(),
                testTime: new Date().toISOString()
            };
            
            console.log("ğŸ§ª å›ºå®šIDãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿:", testData);
            DataManager.saveToFirestore(testData);
        };
        header.appendChild(testBtn);
        
        // IDæƒ…å ±ãƒœã‚¿ãƒ³
        const infoBtn = document.createElement('button');
        infoBtn.textContent = 'â„¹ï¸';
        infoBtn.style.cssText = `
            position: absolute;
            top: 20px;
            left: 90px;
            background: rgba(102, 126, 234, 0.8);
            border: none;
            border-radius: 50%;
            color: white;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 12px;
            z-index: 1000;
        `;
        infoBtn.onclick = function() {
            alert(`ğŸ”’ å›ºå®šãƒ¦ãƒ¼ã‚¶ãƒ¼IDæƒ…å ±\n\nID: ${FIXED_USER_ID}\nä½œæˆæ—¥: ${localStorage.getItem('fixedUserId') ? 'æ—¢å­˜' : 'æ–°è¦'}\n\nã“ã®IDã§ãƒ‡ãƒ¼ã‚¿ãŒæ°¸ç¶šåŒ–ã•ã‚Œã¾ã™ã€‚\nã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢å¾Œã‚‚åŒã˜IDã§å¾©å…ƒã•ã‚Œã¾ã™ã€‚`);
        };
        header.appendChild(infoBtn);
        
        console.log("âœ… ğŸ”’å›ºå®šç®¡ç†ãƒœã‚¿ãƒ³è¿½åŠ å®Œäº†");
    }
    
    // èµ·å‹•æ™‚ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼ˆæ—©æœŸå®Ÿè¡Œï¼‰
    setTimeout(() => {
        console.log("ğŸ“¥ å›ºå®šIDèµ·å‹•æ™‚ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–‹å§‹");
        DataManager.loadFromFirestore();
    }, 500); // 500msã«çŸ­ç¸®
    
    // ãƒ‡ãƒ¼ã‚¿å­˜åœ¨ç¢ºèªï¼‹å¼·åˆ¶å¾©å…ƒï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢å¯¾ç­–ï¼‰
    setTimeout(() => {
        console.log("ğŸ” ãƒ‡ãƒ¼ã‚¿å­˜åœ¨ç¢ºèªï¼‹å¼·åˆ¶å¾©å…ƒå®Ÿè¡Œ");
        forceDataCheck();
    }, 2000);
});

// ãƒ‡ãƒ¼ã‚¿å­˜åœ¨ç¢ºèªï¼‹å¼·åˆ¶å¾©å…ƒ
async function forceDataCheck() {
    try {
        // LocalStorageãŒç©ºã®å ´åˆã€å¼·åˆ¶çš„ã«Firebaseã‹ã‚‰å¾©å…ƒ
        const hasLocalBooks = DataManager.books && Object.keys(DataManager.books).length > 0;
        const hasLocalRecords = DataManager.allRecords && DataManager.allRecords.length > 0;
        
        if (!hasLocalBooks || !hasLocalRecords) {
            console.log("âš ï¸ LocalStorageã«ãƒ‡ãƒ¼ã‚¿ãªã— - å¼·åˆ¶Firebaseå¾©å…ƒå®Ÿè¡Œ");
            
            const userRef = db.collection('fixedUsers').doc(FIXED_USER_ID);
            const doc = await userRef.get();
            
            if (doc.exists) {
                const userData = doc.data();
                console.log("ğŸ”„ å¼·åˆ¶å¾©å…ƒå®Ÿè¡Œ - Firebaseãƒ‡ãƒ¼ã‚¿ã‚ã‚Š");
                restoreDataFromFirebase(userData);
                
                // å¼·åˆ¶å¾©å…ƒå®Œäº†é€šçŸ¥
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 140px;
                    right: 20px;
                    background: linear-gradient(135deg, #ff9800, #f57c00);
                    color: white;
                    padding: 15px 20px;
                    border-radius: 8px;
                    box-shadow: 0 4px 20px rgba(255, 152, 0, 0.3);
                    z-index: 9999;
                    font-weight: 600;
                    animation: slideIn 0.3s ease;
                `;
                notification.innerHTML = `
                    ğŸ”„ å¼·åˆ¶å¾©å…ƒå®Œäº†ï¼<br>
                    ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢å¾Œã®ãƒ‡ãƒ¼ã‚¿å¾©å…ƒ<br>
                    ID: ${FIXED_USER_ID.substr(0, 15)}...
                `;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 4000);
                
            } else {
                console.log("ğŸ“­ Firebaseã«ã‚‚ãƒ‡ãƒ¼ã‚¿ãªã—");
            }
        } else {
            console.log("âœ… LocalStorageã«ãƒ‡ãƒ¼ã‚¿ã‚ã‚Š - å¼·åˆ¶å¾©å…ƒã‚¹ã‚­ãƒƒãƒ—");
        }
    } catch (error) {
        console.error("âŒ å¼·åˆ¶å¾©å…ƒã‚¨ãƒ©ãƒ¼:", error);
    }
}

// å›ºå®šIDãƒªã‚»ãƒƒãƒˆæ©Ÿèƒ½ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
window.resetFixedUserId = function() {
    if (confirm('å›ºå®šãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ\n\nâš ï¸ è­¦å‘Š: æ–°ã—ã„IDãŒç”Ÿæˆã•ã‚Œã€ä»¥å‰ã®ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªããªã‚Šã¾ã™ã€‚\n\nç¾åœ¨ã®ID: ' + FIXED_USER_ID.substr(0, 20) + '...')) {
        // å…¨ã¦ã®ä¿å­˜å ´æ‰€ã‹ã‚‰IDã‚’å‰Šé™¤
        localStorage.removeItem('fixedUserId');
        sessionStorage.removeItem('fixedUserId');
        setCookie('fixedUserId', '', -1); // Cookieå‰Šé™¤
        
        alert('å›ºå®šIDã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¾ã™ã€‚');
        location.reload();
    }
};

// IDç¢ºèªæ©Ÿèƒ½ï¼ˆå¼·åŒ–ç‰ˆï¼‰
window.showFixedUserId = function() {
    const storageInfo = {
        localStorage: localStorage.getItem('fixedUserId') ? 'âœ…' : 'âŒ',
        sessionStorage: sessionStorage.getItem('fixedUserId') ? 'âœ…' : 'âŒ',
        cookie: getCookieValue('fixedUserId') ? 'âœ…' : 'âŒ'
    };
    
    const info = `
ğŸ”’ å›ºå®šãƒ¦ãƒ¼ã‚¶ãƒ¼IDè©³ç´°æƒ…å ±

ç¾åœ¨ã®ID: ${FIXED_USER_ID}
çŸ­ç¸®è¡¨ç¤º: ${FIXED_USER_ID.substr(0, 25)}...

ä¿å­˜çŠ¶æ³:
â”œ LocalStorage: ${storageInfo.localStorage}
â”œ SessionStorage: ${storageInfo.sessionStorage}
â”” Cookie: ${storageInfo.cookie}

ãƒ‡ãƒã‚¤ã‚¹: ${/Mobile|Android|iPhone|iPad/.test(navigator.userAgent) ? 'ãƒ¢ãƒã‚¤ãƒ«' : 'ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—'}
ä½œæˆæ—¥æ™‚: ${localStorage.getItem('fixedUserId') ? 'æ—¢å­˜IDä½¿ç”¨ä¸­' : 'æ–°è¦ä½œæˆ'}

ã“ã®IDã§ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ‡ãƒ¼ã‚¿ãŒç®¡ç†ã•ã‚Œã¦ã„ã¾ã™ã€‚
è¤‡æ•°ã®å ´æ‰€ã«ä¿å­˜ã—ã¦ã„ã‚‹ãŸã‚ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢å¾Œã‚‚å¾©å…ƒã•ã‚Œã¾ã™ã€‚

ãƒ‡ãƒãƒƒã‚°ã‚³ãƒãƒ³ãƒ‰:
- resetFixedUserId() : IDãƒªã‚»ãƒƒãƒˆ
- showFixedUserId() : ã“ã®æƒ…å ±è¡¨ç¤º
- forceDataCheck() : å¼·åˆ¶ãƒ‡ãƒ¼ã‚¿ç¢ºèªãƒ»å¾©å…ƒ
    `;
    console.log(info);
    alert(info);
};

// å¼·åˆ¶ãƒ‡ãƒ¼ã‚¿ç¢ºèªã‚‚å¤–éƒ¨ã‹ã‚‰å®Ÿè¡Œå¯èƒ½ã«
window.forceDataCheck = forceDataCheck;

// ã‚¹ã‚¿ã‚¤ãƒ«è¿½åŠ 
const style = document.createElement('style');
style.textContent = `
@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}
`;
document.head.appendChild(style);

console.log("ğŸ”’ å›ºå®šãƒ¦ãƒ¼ã‚¶ãƒ¼IDç‰ˆFirebaseçµ±åˆãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸ");
console.log("ğŸ†” ç¾åœ¨ã®å›ºå®šID:", FIXED_USER_ID);
console.log("ğŸ› ï¸ ãƒ‡ãƒãƒƒã‚°ã‚³ãƒãƒ³ãƒ‰: resetFixedUserId(), showFixedUserId()");
</script>
</body>
</html>
