<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å­¦ç¿’ãƒˆãƒ©ãƒƒã‚«ãƒ¼ - è¡Œæ”¿æ›¸å£«è©¦é¨“å¯¾ç­–</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="app-header">
        <button class="timer-icon-btn" onclick="App.openTimerModal()" title="ã‚¿ã‚¤ãƒãƒ¼">â°</button>
        <div class="timer-display" id="timerDisplay">00:00:00</div>
        <div class="app-logo">
            <span class="app-logo-icon">ğŸ“š</span>
            <span class="app-title">å­¦ç¿’ãƒˆãƒ©ãƒƒã‚«ãƒ¼</span>
        </div>
        <div class="exam-countdown" id="examCountdown">è©¦é¨“æ—¥ã¾ã§ <span class="days">--</span> æ—¥</div>
    </header>
    
    <!-- ãƒ¡ã‚¤ãƒ³ã‚¿ãƒ– -->
    <div class="main-tabs">
        <button class="main-tab active" onclick="App.switchMainTab('record', event)">è¨˜éŒ²å…¥åŠ›</button>
        <button class="main-tab" onclick="App.switchMainTab('analysis', event)">åˆ†æ</button>
        <button class="main-tab" onclick="App.switchMainTab('progress', event)">é€²æ—</button>
    </div>
    
    <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ -->
    <div class="content-area">
        <!-- è¨˜éŒ²å…¥åŠ›ã‚¿ãƒ– -->
        <div id="record-tab" class="tab-content active">
            <!-- å•é¡Œé›†é¸æŠ -->
            <div class="book-cards-wrapper">
                <button class="book-order-btn" onclick="App.toggleBookSort()">ä¸¦æ›¿ãˆ</button>
                <div id="bookCardsContainer"></div>
            </div>
            
            <!-- ãƒ‘ãƒ³ããšãƒªã‚¹ãƒˆ -->
            <div class="breadcrumb" id="breadcrumb" style="display: none;"></div>
            
            <!-- éšå±¤ãƒªã‚¹ãƒˆ -->
            <div id="recordHierarchyContainer" style="display: none;"></div>
            
            <!-- å•é¡Œå…¥åŠ› -->
            <div class="card" id="questionSection" style="display: none;">
                <div class="card-header">
                    <span class="card-icon">âœï¸</span>
                    <span class="card-title">å•é¡Œåˆ¥æ­£èª¤å…¥åŠ›</span>
                    <!-- â˜…è¿½åŠ : ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ -->
                    <div class="question-nav-buttons">
                        <button class="nav-btn" onclick="App.navigateQuestion(-1)" title="å‰ã¸">â—€</button>
                        <button class="nav-btn" onclick="App.navigateQuestion(1)" title="æ¬¡ã¸">â–¶</button>
                    </div>
                </div>
                
                <div class="action-buttons">
    <button class="action-btn correct" onclick="App.markCorrect()">
        <span style="font-size: 18px;">â—‹</span>
    </button>
    <button class="action-btn wrong" onclick="App.markWrong()">
        <span style="font-size: 18px;">âœ•</span>
    </button>
    <button class="action-btn bookmark" id="bookmarkBtn" onclick="App.toggleBookmarkMode()">
        <span style="font-size: 16px;">âœ“</span>
    </button>
    <!-- â˜…è¿½åŠ : ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ -->
    <button class="action-btn reset" onclick="App.resetAllQuestions()">
        <span style="font-size: 16px;">â†»</span>
    </button>
</div>
                
                <div class="question-grid" id="questionGrid"></div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalCount">0</div>
                        <div class="stat-label">è§£ç­”æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="correctCount">0</div>
                        <div class="stat-label">æ­£è§£æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="wrongCount">0</div>
                        <div class="stat-label">ä¸æ­£è§£æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="correctRate">0%</div>
                        <div class="stat-label">æ­£ç­”ç‡</div>
                    </div>
                </div>
                
            </div>
            
            <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ -->
            <div class="calendar-container">
                <div class="calendar-header">
                    <div class="calendar-nav">
                        <button class="calendar-nav-btn" onclick="UIComponents.changeMonth(-1)">â—€</button>
                        <span class="calendar-month" id="calendarMonth">2025å¹´1æœˆ</span>
                        <button class="calendar-nav-btn" onclick="UIComponents.changeMonth(1)">â–¶</button>
                    </div>
                    <button class="calendar-nav-btn" onclick="UIComponents.goToToday()">ä»Šæ—¥</button>
                </div>
                <div class="calendar-grid" id="calendarGrid"></div>
                <div class="calendar-actions">
                    <button class="calendar-btn add-plan" onclick="UIComponents.openPlanModal()">ğŸ“ å­¦ç¿’è¨ˆç”»ã‚’è¿½åŠ </button>
                    <button class="calendar-btn view-plans" onclick="UIComponents.viewPlans()">ğŸ“‹ è¨ˆç”»ä¸€è¦§</button>
                </div>
            </div>
        </div>
        
        <!-- åˆ†æã‚¿ãƒ– -->
        <div id="analysis-tab" class="tab-content">
            <button class="card-sort-btn" onclick="App.toggleAnalysisSort()">ä¸¦æ›¿ãˆ</button>
            <div id="analysisCardsContainer">
                <!-- å­¦ç¿’ã‚°ãƒ©ãƒ• -->
                <!-- å­¦ç¿’ã‚°ãƒ©ãƒ• -->
                <div class="accordion" data-card-id="chart">
                    <div class="accordion-header active" onclick="App.toggleAccordion(this)">
                        <span>ğŸ“Š å­¦ç¿’ã‚°ãƒ©ãƒ•</span>
                        <span class="accordion-arrow">â–¼</span>
                    </div>
                    <div class="accordion-content active">
                        <div class="chart-controls">
                            <button class="chart-btn active" onclick="Analytics.switchChartView('day', this)">æ—¥åˆ¥</button>
                            <button class="chart-btn" onclick="Analytics.switchChartView('week', this)">é€±é–“</button>
                            <button class="chart-btn" onclick="Analytics.switchChartView('month', this)">æœˆé–“</button>
                        </div>
                        <div class="chart-wrapper">
                            <div class="chart-bars" id="chartBars"></div>
                        </div>
                    </div>
                </div>
                
                <!-- ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ— -->
                <div class="accordion" data-card-id="heatmap">
                    <div class="accordion-header active" onclick="App.toggleAccordion(this)">
                        <span>ğŸ—ºï¸ å•é¡Œãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—</span>
                        <span class="accordion-arrow">â–¼</span>
                    </div>
                    <div class="accordion-content active">
                        <div class="heatmap-controls" style="display: flex; gap: 10px; align-items: center;">
    <select class="heatmap-select" id="heatmapBookSelect" onchange="Analytics.updateHeatmap()" style="flex: 1; min-width: 0;">
        <option value="">å•é¡Œé›†ã‚’é¸æŠ</option>
    </select>
    <button class="heatmap-toggle-btn" id="heatmapToggleBtn" onclick="Analytics.toggleHeatmapPinned()" style="flex-shrink: 0; width: 60px; padding: 8px 10px;">ğŸ“Œ</button>
</div>
                        <div class="heatmap-grid" id="heatmapGrid"></div>
                    </div>
                </div>
                
                <!-- å¼±ç‚¹åˆ†æ -->
                <div class="accordion" data-card-id="weakness">
                    <div class="accordion-header" onclick="App.toggleAccordion(this)">
                        <span>ğŸ¯ å¼±ç‚¹åˆ†æ</span>
                        <span class="accordion-arrow">â–¼</span>
                    </div>
                    <div class="accordion-content">
                        <div id="weaknessAnalysis"></div>
                    </div>
                </div>
                
                <!-- å­¦ç¿’å±¥æ­´ -->
                <div class="accordion" data-card-id="history">
                    <div class="accordion-header" onclick="App.toggleAccordion(this)">
                        <span>ğŸ“… å­¦ç¿’å±¥æ­´</span>
                        <span class="accordion-arrow">â–¼</span>
                    </div>
                    <div class="accordion-content">
                        <div id="historyContent"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- é€²æ—ã‚¿ãƒ– -->
        <div id="progress-tab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <span class="card-icon">ğŸ“Š</span>
                    <span class="card-title">å…¨ä½“é€²æ—çŠ¶æ³</span>
                </div>
                <div id="overallProgress"></div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <span class="card-icon">ğŸ“ˆ</span>
                    <span class="card-title">ç§‘ç›®åˆ¥é€²æ—</span>
                </div>
                <div class="radar-chart-container">
                    <div class="radar-chart-controls">
                        <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
    <select class="radar-chart-select" id="radarBookSelect" onchange="Analytics.drawRadarChart()" style="flex: 1; min-width: 0;">
        <option value="">å•é¡Œé›†ã‚’é¸æŠ</option>
    </select>
    <button class="radar-toggle-btn" id="radarToggleBtn" onclick="Analytics.toggleRadarPinned()" style="flex-shrink: 0; width: 60px; padding: 8px 10px;">ğŸ“Œ</button>
</div>
                        <div style="display: flex; gap: 10px;">
                            <button class="chart-btn active" id="radarModeSubject" onclick="Analytics.setRadarMode('subject', this)">ç§‘ç›®åˆ¥</button>
                            <button class="chart-btn" id="radarModeCompare" onclick="Analytics.setRadarMode('compare', this)">å•é¡Œé›†æ¯”è¼ƒ</button>
                        </div>
                    </div>
                    <canvas id="radarChart" width="300" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ãƒ•ãƒƒã‚¿ãƒ¼ã‚¿ãƒ– -->
    <div class="footer-tabs">
        <button class="footer-tab active" onclick="App.switchFooterTab('register', event)">
            <span class="footer-tab-icon">ğŸ“</span>
            <span class="footer-tab-label">ç™»éŒ²</span>
        </button>
        <button class="footer-tab" onclick="App.switchFooterTab('qa', event)">
            <span class="footer-tab-icon">â“</span>
            <span class="footer-tab-label">ä¸€å•ä¸€ç­”</span>
        </button>
        <button class="footer-tab" onclick="App.switchFooterTab('keypoints', event)">
            <span class="footer-tab-icon">ğŸ“š</span>
            <span class="footer-tab-label">è¦ç‚¹ç¢ºèª</span>
        </button>
        <button class="footer-tab" onclick="App.switchFooterTab('results', event)">
            <span class="footer-tab-icon">ğŸ†</span>
            <span class="footer-tab-label">å®Ÿç¸¾</span>
        </button>
        <button class="footer-tab" onclick="App.switchFooterTab('settings', event)">
            <span class="footer-tab-icon">âš™ï¸</span>
            <span class="footer-tab-label">è¨­å®š</span>
        </button>
    </div>
    
    <!-- ã‚¿ã‚¤ãƒãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="timerModal" class="timer-modal">
        <div class="timer-modal-content">
            <div class="modal-header">
                <h3>â° ã‚¿ã‚¤ãƒãƒ¼</h3>
                <button class="modal-close" onclick="TimerModule.closeModal()">Ã—</button>
            </div>
            
            <div class="timer-tabs">
                <button class="timer-tab active" onclick="TimerModule.switchTab('stopwatch', this)">ã‚¹ãƒˆãƒƒãƒ—ã‚¦ã‚©ãƒƒãƒ</button>
                <button class="timer-tab" onclick="TimerModule.switchTab('countdown', this)">ã‚¿ã‚¤ãƒãƒ¼</button>
                <button class="timer-tab" onclick="TimerModule.switchTab('interval', this)">ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«</button>
            </div>
            
            <div id="stopwatchTab" class="timer-tab-content">
                <div class="timer-display-large" id="stopwatchDisplay">00:00:00</div>
                <div class="timer-controls">
                    <button class="timer-btn start" onclick="TimerModule.startStopwatch()">é–‹å§‹</button>
                    <button class="timer-btn pause" onclick="TimerModule.pauseStopwatch()">ä¸€æ™‚åœæ­¢</button>
                    <button class="timer-btn reset" onclick="TimerModule.resetStopwatch()">ãƒªã‚»ãƒƒãƒˆ</button>
                </div>
            </div>
            
            <div id="countdownTab" class="timer-tab-content" style="display: none;">
                <div class="timer-input-group">
                    <label class="timer-input-label">ã‚¿ã‚¤ãƒãƒ¼è¨­å®š</label>
                    <div class="timer-input-row">
                        <input type="number" class="timer-input" id="countdownHours" placeholder="æ™‚" min="0" max="23">
                        <span>æ™‚é–“</span>
                        <input type="number" class="timer-input" id="countdownMinutes" placeholder="åˆ†" min="0" max="59">
                        <span>åˆ†</span>
                        <input type="number" class="timer-input" id="countdownSeconds" placeholder="ç§’" min="0" max="59">
                        <span>ç§’</span>
                    </div>
                </div>
                <div class="timer-display-large" id="countdownDisplay">00:00:00</div>
                <div class="timer-controls">
                    <button class="timer-btn start" onclick="TimerModule.startCountdown()">é–‹å§‹</button>
                    <button class="timer-btn pause" onclick="TimerModule.pauseCountdown()">ä¸€æ™‚åœæ­¢</button>
                    <button class="timer-btn reset" onclick="TimerModule.resetCountdown()">ãƒªã‚»ãƒƒãƒˆ</button>
                </div>
            </div>
            
            <div id="intervalTab" class="timer-tab-content" style="display: none;">
                <div class="timer-input-group">
                    <label class="timer-input-label">ä½œæ¥­æ™‚é–“</label>
                    <div class="timer-input-row">
                        <input type="number" class="timer-input" id="workMinutes" value="25" min="1">
                        <span>åˆ†</span>
                    </div>
                </div>
                <div class="timer-input-group">
                    <label class="timer-input-label">ä¼‘æ†©æ™‚é–“</label>
                    <div class="timer-input-row">
                        <input type="number" class="timer-input" id="breakMinutes" value="5" min="1">
                        <span>åˆ†</span>
                    </div>
                </div>
                <div class="timer-input-group">
                    <label class="timer-input-label">ã‚»ãƒƒãƒˆæ•°</label>
                    <div class="timer-input-row">
                        <input type="number" class="timer-input" id="intervalSets" value="4" min="1">
                        <span>ã‚»ãƒƒãƒˆ</span>
                    </div>
                </div>
                <div class="timer-display-large" id="intervalDisplay">00:00</div>
                <div style="text-align: center; margin: 10px 0;">
                    <span id="intervalStatus">å¾…æ©Ÿä¸­</span> | 
                    <span id="intervalSetCount">0/0 ã‚»ãƒƒãƒˆ</span>
                </div>
                <div class="timer-controls">
                    <button class="timer-btn start" onclick="TimerModule.startInterval()">é–‹å§‹</button>
                    <button class="timer-btn pause" onclick="TimerModule.pauseInterval()">ä¸€æ™‚åœæ­¢</button>
                    <button class="timer-btn reset" onclick="TimerModule.resetInterval()">ãƒªã‚»ãƒƒãƒˆ</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- å­¦ç¿’è¨ˆç”»ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="planModal" class="plan-modal">
        <div class="plan-modal-content">
            <div class="modal-header">
                <h3 id="planModalTitle">ğŸ“… å­¦ç¿’è¨ˆç”»</h3>
                <button class="modal-close" onclick="UIComponents.closePlanModal()">Ã—</button>
            </div>
            
            <div id="planFormSection">
                <div class="plan-form-group">
                    <label class="plan-form-label">è¨ˆç”»ã‚¿ã‚¤ãƒˆãƒ«</label>
                    <input type="text" class="plan-form-control" id="planTitle" placeholder="ä¾‹ï¼šæ°‘æ³•ç·å‰‡ã®å¾©ç¿’">
                </div>
                
                <div class="plan-form-group">
                    <label class="plan-form-label">è¨ˆç”»å†…å®¹</label>
                    <textarea class="plan-form-control" id="planContent" rows="3" placeholder="å­¦ç¿’å†…å®¹ã®è©³ç´°ã‚’å…¥åŠ›"></textarea>
                </div>
                
                <div class="plan-form-group">
                    <label class="plan-form-label">è¡¨ç¤ºå½¢å¼</label>
                    <div class="plan-display-type">
                        <label>
                            <input type="radio" name="displayType" value="bullet" checked>
                            <span>ãƒ»</span>
                        </label>
                        <label>
                            <input type="radio" name="displayType" value="text">
                            <span>é€šå¸¸è¡¨ç¤º</span>
                        </label>
                    </div>
                </div>
                
                <div class="plan-form-group">
                    <label class="plan-form-label">æ—¥ä»˜ç¯„å›²</label>
                    <div class="date-range-inputs">
                        <input type="date" class="plan-form-control" id="planStartDate">
                        <span>ã€œ</span>
                        <input type="date" class="plan-form-control" id="planEndDate">
                    </div>
                </div>
                
                <div class="plan-form-group">
                    <label class="plan-form-label">è‰²è¨­å®š</label>
                    <div class="color-picker" id="colorPicker">
                        <div class="color-option selected" style="background: #3498db;" data-color="#3498db"></div>
                        <div class="color-option" style="background: #10b981;" data-color="#10b981"></div>
                        <div class="color-option" style="background: #f59e0b;" data-color="#f59e0b"></div>
                        <div class="color-option" style="background: #ef4444;" data-color="#ef4444"></div>
                        <div class="color-option" style="background: #8b5cf6;" data-color="#8b5cf6"></div>
                        <div class="color-option" style="background: #ec4899;" data-color="#ec4899"></div>
                        <div class="color-option" style="background: #6b7280;" data-color="#6b7280"></div>
                    </div>
                </div>
                
                <input type="hidden" id="editPlanId" value="">
                <button class="save-button" onclick="UIComponents.savePlan()">è¨ˆç”»ã‚’ä¿å­˜</button>
            </div>
            
            <div id="planListSection" style="display: none;">
                <h4>ç™»éŒ²æ¸ˆã¿ã®è¨ˆç”»</h4>
                <div class="plan-list" id="planListContent"></div>
            </div>
        </div>
    </div>
    
    <!-- ãƒ•ãƒƒã‚¿ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="footerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">ã‚¿ã‚¤ãƒˆãƒ«</h3>
                <button class="modal-close" onclick="App.closeFooterModal()">Ã—</button>
            </div>
            <div id="modalBody"></div>
        </div>
        <div class="modal-footer">
            <button class="modal-close-bottom" onclick="App.closeFooterModal()">é–‰ã˜ã‚‹</button>
        </div>
    </div>
    
    <!-- å…¥åŠ›ãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
    <div id="dialogOverlay" class="dialog-overlay" style="display: none;"></div>
    <div id="inputDialog" class="input-dialog" style="display: none;">
        <h3 id="dialogTitle">ã‚¿ã‚¤ãƒˆãƒ«</h3>
        <div id="dialogBody"></div>
        <div class="dialog-buttons">
            <button class="dialog-btn secondary" onclick="App.closeDialog()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button class="dialog-btn primary" id="dialogConfirmBtn">ç¢ºå®š</button>
        </div>
    </div>

    <!-- ğŸ”¥ Firebase SDK v9 (Compatç‰ˆ) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <!-- ğŸ”§ Firebaseè¨­å®šï¼†åˆæœŸåŒ– -->
    <script>
    // Firebaseè¨­å®š
    const firebaseConfig = {
        apiKey: "AIzaSyCa3-o7VIbxDzZDy7_SPHTk1kqpq23I79s",
        authDomain: "gakushusintyoku.firebaseapp.com",
        projectId: "gakushusintyoku",
        storageBucket: "gakushusintyoku.firebasestorage.app",
        messagingSenderId: "386582438890",
        appId: "1:386582438890:web:78cd619f0d7ad3ae5a0893"
    };

    // FirebaseåˆæœŸåŒ–
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    </script>

    <!-- ğŸ“± JavaScript ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«èª­ã¿è¾¼ã¿ï¼ˆé †åºé‡è¦ï¼‰ -->
    <script src="data-manager.js"></script>
    <script src="ui-components.js"></script>
    <script src="analytics.js"></script>
    <script src="qa-module.js"></script>
    <script src="timer-module.js"></script>
    <script src="keypoints-module.js"></script>
    <script src="app.js"></script>

    <!-- ğŸ”¥ å®Œå…¨å›ºå®šãƒ¦ãƒ¼ã‚¶ãƒ¼IDç‰ˆFirebaseçµ±åˆã‚³ãƒ¼ãƒ‰ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢å®Œå…¨å¯¾å¿œï¼‰ -->
    <script>
    console.log("ğŸš€ Firebaseçµ±åˆé–‹å§‹ï¼ˆã‚«ãƒ†ã‚´ãƒªãƒ¼åˆ†å‰²å¯¾å¿œãƒ»å®Œå…¨ä¿®æ­£ç‰ˆï¼‰");

// ğŸ”§ Firebaseè¨­å®šã¨ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ°¸ç¶šåŒ–
try {
    firebase.firestore().enablePersistence({ 
        synchronizeTabs: true,
        experimentalForceOwningTab: true 
    }).then(() => {
        console.log("âœ… Firebase ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ°¸ç¶šåŒ–æœ‰åŠ¹");
    }).catch((err) => {
        if (err.code === 'failed-precondition') {
            console.log("âš ï¸ è¤‡æ•°ã‚¿ãƒ–é–‹ã„ã¦ã„ã‚‹ãŸã‚æ°¸ç¶šåŒ–ç„¡åŠ¹");
        } else if (err.code === 'unimplemented') {
            console.log("âš ï¸ ãƒ–ãƒ©ã‚¦ã‚¶ãŒæ°¸ç¶šåŒ–éå¯¾å¿œ");
        }
    });
} catch (error) {
    console.error("Firebaseè¨­å®šã‚¨ãƒ©ãƒ¼:", error);
}

// ğŸ”‘ è¶…å®‰å®šå›ºå®šãƒ¦ãƒ¼ã‚¶ãƒ¼IDç”Ÿæˆï¼ˆå®Œå…¨å›ºå®šç‰ˆï¼‰
function generateUltraStableUserId() {
    const stableElements = [
        navigator.userAgent.split(' ')[0],
        navigator.platform,
        screen.width,
        screen.height,
        navigator.language,
        navigator.hardwareConcurrency || '4',
        new Date().getTimezoneOffset().toString()
    ];
    
    let hash = 'stable';
    const combined = stableElements.join('|');
    
    for (let i = 0; i < combined.length; i++) {
        const char = combined.charCodeAt(i);
        hash = ((hash << 5) - hash + char) & 0xffffffff;
    }
    
    const isMobile = /Mobile|Android|iPhone|iPad/.test(navigator.userAgent);
    const deviceType = isMobile ? 'mobile' : 'desktop';
    const baseId = Math.abs(hash).toString(36).padStart(8, '0');
    
    return `${deviceType}_${baseId}_permanent`;
}

// ğŸª è¤‡æ•°ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ã®ç¢ºå®ŸãªIDå–å¾—
async function getOrCreateFixedUserId() {
    console.log("ğŸ” å›ºå®šIDå–å¾—ãƒ»ç”Ÿæˆé–‹å§‹");
    
    // 1. LocalStorageã‹ã‚‰å–å¾—
    let userId = localStorage.getItem('ultraStableUserId');
    if (userId) {
        console.log("âœ… LocalStorageã‹ã‚‰å›ºå®šIDå–å¾—:", userId);
        return userId;
    }
    
    // 2. SessionStorageã‹ã‚‰å–å¾—
    userId = sessionStorage.getItem('ultraStableUserId');
    if (userId) {
        console.log("âœ… SessionStorageã‹ã‚‰å›ºå®šIDå–å¾—:", userId);
        localStorage.setItem('ultraStableUserId', userId);
        return userId;
    }
    
    // 3. æ–°è¦ç”Ÿæˆ
    userId = generateUltraStableUserId();
    console.log("ğŸ†• æ–°è¦å›ºå®šIDç”Ÿæˆ:", userId);
    
    // å…¨ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
    localStorage.setItem('ultraStableUserId', userId);
    sessionStorage.setItem('ultraStableUserId', userId);
    
    return userId;
}

// ğŸš€ å›ºå®šIDã®åˆæœŸåŒ–ã¨è¨­å®š
let ULTRA_STABLE_USER_ID = null;

(async function initializeUltraStableId() {
    try {
        ULTRA_STABLE_USER_ID = await getOrCreateFixedUserId();
        window.ULTRA_STABLE_USER_ID = ULTRA_STABLE_USER_ID;
        console.log("ğŸ”’ è¶…å®‰å®šå›ºå®šIDè¨­å®šå®Œäº†:", ULTRA_STABLE_USER_ID);
        
        // DataManagerã®æ‹¡å¼µ
        extendDataManager();
        
        // å³åº§ã«ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        await loadFromFirebaseInstantly();
        
    } catch (error) {
        console.error("å›ºå®šIDåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:", error);
    }
})();

// ğŸ“Š DataManageræ‹¡å¼µï¼ˆã‚«ãƒ†ã‚´ãƒªãƒ¼åˆ†å‰²å¯¾å¿œãƒ»å®Œå…¨ä¿®æ­£ç‰ˆï¼‰
function extendDataManager() {
    if (!window.DataManager) {
        console.warn("DataManageræœªå®šç¾©");
        return;
    }
    
    console.log("ğŸ”§ DataManageræ‹¡å¼µé–‹å§‹ï¼ˆã‚«ãƒ†ã‚´ãƒªãƒ¼åˆ†å‰²å¯¾å¿œï¼‰");
    
    // â˜…å®Œå…¨ä¿®æ­£ç‰ˆ: ã‚«ãƒ†ã‚´ãƒªãƒ¼åˆ†å‰²ä¿å­˜
    DataManager.saveToFirestore = async function(additionalData = {}) {
        if (!ULTRA_STABLE_USER_ID) return false;
        
        try {
            console.log("ğŸ’¾ ã‚«ãƒ†ã‚´ãƒªãƒ¼åˆ†å‰²Firebaseä¿å­˜é–‹å§‹");
            const batch = db.batch();
            const userRef = db.collection('users').doc(ULTRA_STABLE_USER_ID);
            
            // ãƒ¡ã‚¤ãƒ³ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼ˆãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã¨å°ã•ã„ãƒ‡ãƒ¼ã‚¿ï¼‰
            const mainDoc = userRef;
            const mainData = {
                userId: ULTRA_STABLE_USER_ID,
                lastSyncTime: firebase.firestore.FieldValue.serverTimestamp(),
                deviceType: /Mobile|Android|iPhone|iPad/.test(navigator.userAgent) ? 'mobile' : 'desktop',
                examDate: this.examDate ? this.examDate.toISOString() : null,
                bookOrder: this.bookOrder || [],
                analysisCardOrder: this.analysisCardOrder || [],
                heatmapPinnedBook: this.heatmapPinnedBook || null,
                radarPinnedBook: this.radarPinnedBook || null,
                deletedItems: this.deletedItems || [],
                syncCount: firebase.firestore.FieldValue.increment(1),
                ...additionalData
            };
            batch.set(mainDoc, mainData, { merge: true });
            
            // ã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³1: å•é¡Œé›†ãƒ‡ãƒ¼ã‚¿
            if (this.books && Object.keys(this.books).length > 0) {
                const booksRef = userRef.collection('books').doc('data');
                batch.set(booksRef, {
                    books: this.books,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
            }
            
            // ã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³2: å­¦ç¿’è¨˜éŒ²ï¼ˆå¤§ãã„ãƒ‡ãƒ¼ã‚¿ï¼‰
            if (this.allRecords && this.allRecords.length > 0) {
                const recordsRef = userRef.collection('records').doc('data');
                // æœ€æ–°500ä»¶ã®ã¿ä¿å­˜ï¼ˆå®¹é‡åˆ¶é™å¯¾ç­–ï¼‰
                const recentRecords = this.allRecords.slice(-500);
                batch.set(recordsRef, {
                    records: recentRecords,
                    totalCount: this.allRecords.length,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
            }
            
            // ã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³3: å­¦ç¿’è¨ˆç”»
            if (this.studyPlans && this.studyPlans.length > 0) {
                const plansRef = userRef.collection('plans').doc('data');
                batch.set(plansRef, {
                    plans: this.studyPlans,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
            }
            
            // ã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³4: ä¸€å•ä¸€ç­”
            if (this.qaQuestions && Object.keys(this.qaQuestions).length > 0) {
                const qaRef = userRef.collection('qa').doc('data');
                batch.set(qaRef, {
                    questions: this.qaQuestions,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
            }
            
            // ã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³5: CSVãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
            if (this.csvTemplates && Object.keys(this.csvTemplates).length > 0) {
                const csvRef = userRef.collection('csv').doc('data');
                batch.set(csvRef, {
                    templates: this.csvTemplates,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
            }
            
            // ã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³6: å•é¡ŒçŠ¶æ…‹
            if (this.savedQuestionStates && Object.keys(this.savedQuestionStates).length > 0) {
                const statesRef = userRef.collection('states').doc('data');
                batch.set(statesRef, {
                    states: this.savedQuestionStates,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
            }
            
            // ãƒãƒƒãƒã‚³ãƒŸãƒƒãƒˆ
            await batch.commit();
            console.log("âœ… ã‚«ãƒ†ã‚´ãƒªãƒ¼åˆ†å‰²Firebaseä¿å­˜å®Œäº†");
            
            return true;
        } catch (error) {
            console.error("âŒ Firebaseä¿å­˜ã‚¨ãƒ©ãƒ¼:", error);
            return false;
        }
    };
    
    // â˜…å®Œå…¨ä¿®æ­£ç‰ˆ: ã‚«ãƒ†ã‚´ãƒªãƒ¼åˆ†å‰²èª­ã¿è¾¼ã¿
    DataManager.loadFromFirestore = async function() {
        if (!ULTRA_STABLE_USER_ID) return;
        
        console.log("ğŸ“¥ ã‚«ãƒ†ã‚´ãƒªãƒ¼åˆ†å‰²Firebaseèª­ã¿è¾¼ã¿é–‹å§‹");
        
        try {
            const userRef = db.collection('users').doc(ULTRA_STABLE_USER_ID);
            
            // ãƒ¡ã‚¤ãƒ³ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆèª­ã¿è¾¼ã¿
            const mainDoc = await userRef.get();
            if (mainDoc.exists) {
                const mainData = mainDoc.data();
                
                // â˜…é‡è¦: å‰Šé™¤æ¸ˆã¿ã‚¢ã‚¤ãƒ†ãƒ ã‚’æœ€åˆã«å¾©å…ƒ
                if (mainData.deletedItems && Array.isArray(mainData.deletedItems)) {
                    this.deletedItems = mainData.deletedItems;
                    localStorage.setItem('deletedItems', JSON.stringify(mainData.deletedItems));
                    console.log(`ğŸ—‘ï¸ å‰Šé™¤æ¸ˆã¿ã‚¢ã‚¤ãƒ†ãƒ å¾©å…ƒ: ${mainData.deletedItems.length}ä»¶`);
                }
                
                // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å¾©å…ƒ
                if (mainData.bookOrder) {
                    this.bookOrder = mainData.bookOrder.filter(id => !this.isDeleted('books', id));
                    localStorage.setItem('bookOrder', JSON.stringify(this.bookOrder));
                }
                
                if (mainData.analysisCardOrder) {
                    this.analysisCardOrder = mainData.analysisCardOrder;
                    localStorage.setItem('analysisCardOrder', JSON.stringify(this.analysisCardOrder));
                }
                
                if (mainData.examDate) {
                    this.examDate = new Date(mainData.examDate);
                    localStorage.setItem('examDate', mainData.examDate);
                }
                
                if (mainData.heatmapPinnedBook) {
                    this.heatmapPinnedBook = mainData.heatmapPinnedBook;
                    localStorage.setItem('heatmapPinnedBook', mainData.heatmapPinnedBook);
                }
                
                if (mainData.radarPinnedBook) {
                    this.radarPinnedBook = mainData.radarPinnedBook;
                    localStorage.setItem('radarPinnedBook', mainData.radarPinnedBook);
                }
            }
            
            // ã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³èª­ã¿è¾¼ã¿ï¼ˆä¸¦åˆ—å‡¦ç†ï¼‰
            const [booksDoc, recordsDoc, plansDoc, qaDoc, csvDoc, statesDoc] = await Promise.all([
                userRef.collection('books').doc('data').get(),
                userRef.collection('records').doc('data').get(),
                userRef.collection('plans').doc('data').get(),
                userRef.collection('qa').doc('data').get(),
                userRef.collection('csv').doc('data').get(),
                userRef.collection('states').doc('data').get()
            ]);
            
            // å•é¡Œé›†å¾©å…ƒï¼ˆå‰Šé™¤æ¸ˆã¿é™¤å¤–ï¼‰
            if (booksDoc.exists && booksDoc.data().books) {
                const books = booksDoc.data().books;
                const filteredBooks = {};
                Object.keys(books).forEach(bookId => {
                    if (!this.isDeleted('books', bookId)) {
                        filteredBooks[bookId] = books[bookId];
                    }
                });
                this.books = filteredBooks;
                localStorage.setItem('studyTrackerBooks', JSON.stringify(filteredBooks));
                console.log(`ğŸ“š å•é¡Œé›†å¾©å…ƒ: ${Object.keys(filteredBooks).length}ä»¶`);
            }
            
            // å­¦ç¿’è¨˜éŒ²å¾©å…ƒ
            if (recordsDoc.exists && recordsDoc.data().records) {
                this.allRecords = recordsDoc.data().records;
                localStorage.setItem('studyHistory', JSON.stringify(this.allRecords));
                console.log(`ğŸ“ å­¦ç¿’è¨˜éŒ²å¾©å…ƒ: ${this.allRecords.length}ä»¶`);
            }
            
            // å­¦ç¿’è¨ˆç”»å¾©å…ƒï¼ˆå‰Šé™¤æ¸ˆã¿é™¤å¤–ï¼‰
            if (plansDoc.exists && plansDoc.data().plans) {
                const plans = plansDoc.data().plans;
                this.studyPlans = plans.filter(plan => !this.isDeleted('studyPlans', plan.id));
                localStorage.setItem('studyPlans', JSON.stringify(this.studyPlans));
                console.log(`ğŸ“… å­¦ç¿’è¨ˆç”»å¾©å…ƒ: ${this.studyPlans.length}ä»¶`);
            }
            
            // ä¸€å•ä¸€ç­”å¾©å…ƒï¼ˆå‰Šé™¤æ¸ˆã¿é™¤å¤–ï¼‰
            if (qaDoc.exists && qaDoc.data().questions) {
                const questions = qaDoc.data().questions;
                const filteredQuestions = {};
                Object.keys(questions).forEach(setId => {
                    if (!this.isDeleted('qaQuestions', setId)) {
                        filteredQuestions[setId] = questions[setId];
                    }
                });
                this.qaQuestions = filteredQuestions;
                localStorage.setItem('qaQuestions', JSON.stringify(filteredQuestions));
                console.log(`â“ ä¸€å•ä¸€ç­”å¾©å…ƒ: ${Object.keys(filteredQuestions).length}ã‚»ãƒƒãƒˆ`);
            }
            
            // CSVãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå¾©å…ƒï¼ˆå‰Šé™¤æ¸ˆã¿é™¤å¤–ï¼‰
            if (csvDoc.exists && csvDoc.data().templates) {
                const templates = csvDoc.data().templates;
                const filteredTemplates = {};
                Object.keys(templates).forEach(templateId => {
                    if (!this.isDeleted('csvTemplates', templateId)) {
                        filteredTemplates[templateId] = templates[templateId];
                    }
                });
                this.csvTemplates = filteredTemplates;
                localStorage.setItem('csvTemplates', JSON.stringify(filteredTemplates));
                console.log(`ğŸ“„ CSVãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå¾©å…ƒ: ${Object.keys(filteredTemplates).length}ä»¶`);
            }
            
            // å•é¡ŒçŠ¶æ…‹å¾©å…ƒ
            if (statesDoc.exists && statesDoc.data().states) {
                this.savedQuestionStates = statesDoc.data().states;
                localStorage.setItem('savedQuestionStates', JSON.stringify(this.savedQuestionStates));
                console.log(`âœï¸ å•é¡ŒçŠ¶æ…‹å¾©å…ƒ: ${Object.keys(this.savedQuestionStates).length}ä»¶`);
            }
            
            // UIã‚’æ›´æ–°
            if (window.App && typeof App.renderBookCards === 'function') {
                App.renderBookCards();
            }
            if (window.Analytics) {
                Analytics.updateHeatmapBookSelect();
                Analytics.updateRadarBookSelect();
            }
            
            console.log("âœ… ã‚«ãƒ†ã‚´ãƒªãƒ¼åˆ†å‰²Firebaseèª­ã¿è¾¼ã¿å®Œäº†");
            
        } catch (error) {
            console.error("âŒ Firebaseèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", error);
        }
    };
    
    // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–è¨­å®š
    const userRef = db.collection('users').doc(ULTRA_STABLE_USER_ID);
    userRef.onSnapshot((doc) => {
        if (doc.exists && doc.data().lastSyncTime) {
            console.log("ğŸ“¡ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°æ¤œçŸ¥");
            // ä»–ãƒ‡ãƒã‚¤ã‚¹ã‹ã‚‰ã®æ›´æ–°ã‚’æ¤œçŸ¥ã—ãŸã‚‰å†èª­ã¿è¾¼ã¿
            DataManager.loadFromFirestore();
        }
    });
}

// ğŸ“¥ å³åº§ã«ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
async function loadFromFirebaseInstantly() {
    if (!ULTRA_STABLE_USER_ID || !window.DataManager) return;
    
    console.log("ğŸ“¥ å³åº§Firebaseèª­ã¿è¾¼ã¿é–‹å§‹");
    
    try {
        await DataManager.loadFromFirestore();
        console.log("âœ… å³åº§Firebaseèª­ã¿è¾¼ã¿å®Œäº†");
    } catch (error) {
        console.error("âŒ å³åº§èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", error);
    }
}

// å…¨ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ‹¡å¼µï¼ˆDOMContentLoadedæ™‚ï¼‰
document.addEventListener('DOMContentLoaded', function() {
    console.log("ğŸ›ï¸ å…¨ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ‹¡å¼µé–‹å§‹");
    
    setTimeout(() => {
        // å„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ä¿å­˜ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æ‹¡å¼µ
        extendModuleSaveMethods();
        console.log("âœ… å…¨ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«Firebaseçµ±åˆå®Œäº†");
    }, 1000);
});

// ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ä¿å­˜ãƒ¡ã‚½ãƒƒãƒ‰ã®æ‹¡å¼µ
function extendModuleSaveMethods() {
    // å­¦ç¿’è¨˜éŒ²ä¿å­˜ã®æ‹¡å¼µ
    if (window.App && window.App.saveRecord) {
        const originalSaveRecord = window.App.saveRecord;
        window.App.saveRecord = function() {
            originalSaveRecord.call(this);
            DataManager.saveToFirestore({ type: "record", action: "save" });
        };
    }
    
    // è‡ªå‹•ä¿å­˜ã®æ‹¡å¼µ
    if (window.App && window.App.autoSaveRecord) {
        const originalAutoSave = window.App.autoSaveRecord;
        window.App.autoSaveRecord = function() {
            originalAutoSave.call(this);
            DataManager.saveToFirestore({ type: "record", action: "autosave" });
        };
    }
    
    // å­¦ç¿’è¨ˆç”»ä¿å­˜ã®æ‹¡å¼µ
    if (window.UIComponents && window.UIComponents.savePlan) {
        const originalSavePlan = window.UIComponents.savePlan;
        window.UIComponents.savePlan = function() {
            originalSavePlan.call(this);
            DataManager.saveToFirestore({ type: "plan", action: "save" });
        };
    }
    
    // ä¸€å•ä¸€ç­”ä¿å­˜ã®æ‹¡å¼µ
    if (window.QAModule && window.QAModule.saveQuestions) {
        const originalSaveQA = window.QAModule.saveQuestions;
        window.QAModule.saveQuestions = function() {
            originalSaveQA.call(this);
            DataManager.saveToFirestore({ type: "qa", action: "save" });
        };
    }
}

console.log("âœ… Firebaseçµ±åˆã‚³ãƒ¼ãƒ‰èª­ã¿è¾¼ã¿å®Œäº†ï¼ˆã‚«ãƒ†ã‚´ãƒªãƒ¼åˆ†å‰²å¯¾å¿œç‰ˆï¼‰");
    </script>
</body>
</html>
