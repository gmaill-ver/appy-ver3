<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>学習トラッカー - 行政書士試験対策</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- ヘッダー -->
    <header class="app-header">
        <button class="timer-icon-btn" onclick="App.openTimerModal()" title="タイマー">⏰</button>
        <div class="timer-display" id="timerDisplay">00:00:00</div>
        <div class="app-logo">
            <span class="app-logo-icon">📚</span>
            <span class="app-title">学習トラッカー</span>
        </div>
        <div class="exam-countdown" id="examCountdown">試験日まで <span class="days">--</span> 日</div>
    </header>
    
    <!-- メインタブ -->
    <div class="main-tabs">
        <button class="main-tab active" onclick="App.switchMainTab('record', event)">記録入力</button>
        <button class="main-tab" onclick="App.switchMainTab('analysis', event)">分析</button>
        <button class="main-tab" onclick="App.switchMainTab('progress', event)">進捗</button>
    </div>
    
    <!-- コンテンツエリア -->
    <div class="content-area">
        <!-- 記録入力タブ -->
        <div id="record-tab" class="tab-content active">
            <!-- 問題集選択 -->
            <div class="book-cards-wrapper">
                <button class="book-order-btn" onclick="App.toggleBookSort()">並替え</button>
                <div id="bookCardsContainer"></div>
            </div>
            
            <!-- パンくずリスト -->
            <div class="breadcrumb" id="breadcrumb" style="display: none;"></div>
            
            <!-- 階層リスト -->
            <div id="recordHierarchyContainer" style="display: none;"></div>
            
            <!-- 問題入力 -->
            <div class="card" id="questionSection" style="display: none;">
                <div class="card-header">
                    <span class="card-icon">✍️</span>
                    <span class="card-title">問題別正誤入力</span>
                    <!-- ★追加: ページネーション -->
                    <div class="question-nav-buttons">
                        <button class="nav-btn" onclick="App.navigateQuestion(-1)" title="前へ">◀</button>
                        <button class="nav-btn" onclick="App.navigateQuestion(1)" title="次へ">▶</button>
                    </div>
                </div>
                
                <div class="action-buttons">
    <button class="action-btn correct" onclick="App.markCorrect()">
        <span style="font-size: 18px;">○</span>
    </button>
    <button class="action-btn wrong" onclick="App.markWrong()">
        <span style="font-size: 18px;">✕</span>
    </button>
    <button class="action-btn bookmark" id="bookmarkBtn" onclick="App.toggleBookmarkMode()">
        <span style="font-size: 16px;">✓</span>
    </button>
    <!-- ★追加: リセットボタン -->
    <button class="action-btn reset" onclick="App.resetAllQuestions()">
        <span style="font-size: 16px;">↻</span>
    </button>
</div>
                
                <div class="question-grid" id="questionGrid"></div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalCount">0</div>
                        <div class="stat-label">解答数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="correctCount">0</div>
                        <div class="stat-label">正解数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="wrongCount">0</div>
                        <div class="stat-label">不正解数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="correctRate">0%</div>
                        <div class="stat-label">正答率</div>
                    </div>
                </div>
                
            </div>
            
            <!-- カレンダー -->
            <div class="calendar-container">
                <div class="calendar-header">
                    <div class="calendar-nav">
                        <button class="calendar-nav-btn" onclick="UIComponents.changeMonth(-1)">◀</button>
                        <span class="calendar-month" id="calendarMonth">2025年1月</span>
                        <button class="calendar-nav-btn" onclick="UIComponents.changeMonth(1)">▶</button>
                    </div>
                    <button class="calendar-nav-btn" onclick="UIComponents.goToToday()">今日</button>
                </div>
                <div class="calendar-grid" id="calendarGrid"></div>
                <div class="calendar-actions">
                    <button class="calendar-btn add-plan" onclick="UIComponents.openPlanModal()">📝 学習計画を追加</button>
                    <button class="calendar-btn view-plans" onclick="UIComponents.viewPlans()">📋 計画一覧</button>
                </div>
            </div>
        </div>
        
        <!-- 分析タブ -->
        <div id="analysis-tab" class="tab-content">
            <button class="card-sort-btn" onclick="App.toggleAnalysisSort()">並替え</button>
            <div id="analysisCardsContainer">
                <!-- 学習グラフ -->
                <!-- 学習グラフ -->
                <div class="accordion" data-card-id="chart">
                    <div class="accordion-header active" onclick="App.toggleAccordion(this)">
                        <span>📊 学習グラフ</span>
                        <span class="accordion-arrow">▼</span>
                    </div>
                    <div class="accordion-content active">
                        <div class="chart-controls">
                            <button class="chart-btn active" onclick="Analytics.switchChartView('day', this)">日別</button>
                            <button class="chart-btn" onclick="Analytics.switchChartView('week', this)">週間</button>
                            <button class="chart-btn" onclick="Analytics.switchChartView('month', this)">月間</button>
                        </div>
                        <div class="chart-wrapper">
                            <div class="chart-bars" id="chartBars"></div>
                        </div>
                    </div>
                </div>
                
                <!-- ヒートマップ -->
                <div class="accordion" data-card-id="heatmap">
                    <div class="accordion-header active" onclick="App.toggleAccordion(this)">
                        <span>🗺️ 問題ヒートマップ</span>
                        <span class="accordion-arrow">▼</span>
                    </div>
                    <div class="accordion-content active">
                        <div class="heatmap-controls" style="display: flex; gap: 10px; align-items: center;">
    <select class="heatmap-select" id="heatmapBookSelect" onchange="Analytics.updateHeatmap()" style="flex: 1; min-width: 0;">
        <option value="">問題集を選択</option>
    </select>
    <button class="heatmap-toggle-btn" id="heatmapToggleBtn" onclick="Analytics.toggleHeatmapPinned()" style="flex-shrink: 0; width: 60px; padding: 8px 10px;">📌</button>
</div>
                        <div class="heatmap-grid" id="heatmapGrid"></div>
                    </div>
                </div>
                
                <!-- 弱点分析 -->
                <div class="accordion" data-card-id="weakness">
                    <div class="accordion-header" onclick="App.toggleAccordion(this)">
                        <span>🎯 弱点分析</span>
                        <span class="accordion-arrow">▼</span>
                    </div>
                    <div class="accordion-content">
                        <div id="weaknessAnalysis"></div>
                    </div>
                </div>
                
                <!-- 学習履歴 -->
                <div class="accordion" data-card-id="history">
                    <div class="accordion-header" onclick="App.toggleAccordion(this)">
                        <span>📅 学習履歴</span>
                        <span class="accordion-arrow">▼</span>
                    </div>
                    <div class="accordion-content">
                        <div id="historyContent"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 進捗タブ -->
        <div id="progress-tab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <span class="card-icon">📊</span>
                    <span class="card-title">全体進捗状況</span>
                </div>
                <div id="overallProgress"></div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <span class="card-icon">📈</span>
                    <span class="card-title">科目別進捗</span>
                </div>
                <div class="radar-chart-container">
                    <div class="radar-chart-controls">
                        <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
    <select class="radar-chart-select" id="radarBookSelect" onchange="Analytics.drawRadarChart()" style="flex: 1; min-width: 0;">
        <option value="">問題集を選択</option>
    </select>
    <button class="radar-toggle-btn" id="radarToggleBtn" onclick="Analytics.toggleRadarPinned()" style="flex-shrink: 0; width: 60px; padding: 8px 10px;">📌</button>
</div>
                        <div style="display: flex; gap: 10px;">
                            <button class="chart-btn active" id="radarModeSubject" onclick="Analytics.setRadarMode('subject', this)">科目別</button>
                            <button class="chart-btn" id="radarModeCompare" onclick="Analytics.setRadarMode('compare', this)">問題集比較</button>
                        </div>
                    </div>
                    <canvas id="radarChart" width="300" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- フッタータブ -->
    <div class="footer-tabs">
        <button class="footer-tab active" onclick="App.switchFooterTab('register', event)">
            <span class="footer-tab-icon">📝</span>
            <span class="footer-tab-label">登録</span>
        </button>
        <button class="footer-tab" onclick="App.switchFooterTab('qa', event)">
            <span class="footer-tab-icon">❓</span>
            <span class="footer-tab-label">一問一答</span>
        </button>
        <button class="footer-tab" onclick="App.switchFooterTab('keypoints', event)">
            <span class="footer-tab-icon">📚</span>
            <span class="footer-tab-label">要点確認</span>
        </button>
        <button class="footer-tab" onclick="App.switchFooterTab('results', event)">
            <span class="footer-tab-icon">🏆</span>
            <span class="footer-tab-label">実績</span>
        </button>
        <button class="footer-tab" onclick="App.switchFooterTab('settings', event)">
            <span class="footer-tab-icon">⚙️</span>
            <span class="footer-tab-label">設定</span>
        </button>
    </div>
    
    <!-- タイマーモーダル -->
    <div id="timerModal" class="timer-modal">
        <div class="timer-modal-content">
            <div class="modal-header">
                <h3>⏰ タイマー</h3>
                <button class="modal-close" onclick="TimerModule.closeModal()">×</button>
            </div>
            
            <div class="timer-tabs">
                <button class="timer-tab active" onclick="TimerModule.switchTab('stopwatch', this)">ストップウォッチ</button>
                <button class="timer-tab" onclick="TimerModule.switchTab('countdown', this)">タイマー</button>
                <button class="timer-tab" onclick="TimerModule.switchTab('interval', this)">インターバル</button>
            </div>
            
            <div id="stopwatchTab" class="timer-tab-content">
                <div class="timer-display-large" id="stopwatchDisplay">00:00:00</div>
                <div class="timer-controls">
                    <button class="timer-btn start" onclick="TimerModule.startStopwatch()">開始</button>
                    <button class="timer-btn pause" onclick="TimerModule.pauseStopwatch()">一時停止</button>
                    <button class="timer-btn reset" onclick="TimerModule.resetStopwatch()">リセット</button>
                </div>
            </div>
            
            <div id="countdownTab" class="timer-tab-content" style="display: none;">
                <div class="timer-input-group">
                    <label class="timer-input-label">タイマー設定</label>
                    <div class="timer-input-row">
                        <input type="number" class="timer-input" id="countdownHours" placeholder="時" min="0" max="23">
                        <span>時間</span>
                        <input type="number" class="timer-input" id="countdownMinutes" placeholder="分" min="0" max="59">
                        <span>分</span>
                        <input type="number" class="timer-input" id="countdownSeconds" placeholder="秒" min="0" max="59">
                        <span>秒</span>
                    </div>
                </div>
                <div class="timer-display-large" id="countdownDisplay">00:00:00</div>
                <div class="timer-controls">
                    <button class="timer-btn start" onclick="TimerModule.startCountdown()">開始</button>
                    <button class="timer-btn pause" onclick="TimerModule.pauseCountdown()">一時停止</button>
                    <button class="timer-btn reset" onclick="TimerModule.resetCountdown()">リセット</button>
                </div>
            </div>
            
            <div id="intervalTab" class="timer-tab-content" style="display: none;">
                <div class="timer-input-group">
                    <label class="timer-input-label">作業時間</label>
                    <div class="timer-input-row">
                        <input type="number" class="timer-input" id="workMinutes" value="25" min="1">
                        <span>分</span>
                    </div>
                </div>
                <div class="timer-input-group">
                    <label class="timer-input-label">休憩時間</label>
                    <div class="timer-input-row">
                        <input type="number" class="timer-input" id="breakMinutes" value="5" min="1">
                        <span>分</span>
                    </div>
                </div>
                <div class="timer-input-group">
                    <label class="timer-input-label">セット数</label>
                    <div class="timer-input-row">
                        <input type="number" class="timer-input" id="intervalSets" value="4" min="1">
                        <span>セット</span>
                    </div>
                </div>
                <div class="timer-display-large" id="intervalDisplay">00:00</div>
                <div style="text-align: center; margin: 10px 0;">
                    <span id="intervalStatus">待機中</span> | 
                    <span id="intervalSetCount">0/0 セット</span>
                </div>
                <div class="timer-controls">
                    <button class="timer-btn start" onclick="TimerModule.startInterval()">開始</button>
                    <button class="timer-btn pause" onclick="TimerModule.pauseInterval()">一時停止</button>
                    <button class="timer-btn reset" onclick="TimerModule.resetInterval()">リセット</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 学習計画モーダル -->
    <div id="planModal" class="plan-modal">
        <div class="plan-modal-content">
            <div class="modal-header">
                <h3 id="planModalTitle">📅 学習計画</h3>
                <button class="modal-close" onclick="UIComponents.closePlanModal()">×</button>
            </div>
            
            <div id="planFormSection">
                <div class="plan-form-group">
                    <label class="plan-form-label">計画タイトル</label>
                    <input type="text" class="plan-form-control" id="planTitle" placeholder="例：民法総則の復習">
                </div>
                
                <div class="plan-form-group">
                    <label class="plan-form-label">計画内容</label>
                    <textarea class="plan-form-control" id="planContent" rows="3" placeholder="学習内容の詳細を入力"></textarea>
                </div>
                
                <div class="plan-form-group">
                    <label class="plan-form-label">表示形式</label>
                    <div class="plan-display-type">
                        <label>
                            <input type="radio" name="displayType" value="bullet" checked>
                            <span>・</span>
                        </label>
                        <label>
                            <input type="radio" name="displayType" value="text">
                            <span>通常表示</span>
                        </label>
                    </div>
                </div>
                
                <div class="plan-form-group">
                    <label class="plan-form-label">日付範囲</label>
                    <div class="date-range-inputs">
                        <input type="date" class="plan-form-control" id="planStartDate">
                        <span>〜</span>
                        <input type="date" class="plan-form-control" id="planEndDate">
                    </div>
                </div>
                
                <div class="plan-form-group">
                    <label class="plan-form-label">色設定</label>
                    <div class="color-picker" id="colorPicker">
                        <div class="color-option selected" style="background: #3498db;" data-color="#3498db"></div>
                        <div class="color-option" style="background: #10b981;" data-color="#10b981"></div>
                        <div class="color-option" style="background: #f59e0b;" data-color="#f59e0b"></div>
                        <div class="color-option" style="background: #ef4444;" data-color="#ef4444"></div>
                        <div class="color-option" style="background: #8b5cf6;" data-color="#8b5cf6"></div>
                        <div class="color-option" style="background: #ec4899;" data-color="#ec4899"></div>
                        <div class="color-option" style="background: #6b7280;" data-color="#6b7280"></div>
                    </div>
                </div>
                
                <input type="hidden" id="editPlanId" value="">
                <button class="save-button" onclick="UIComponents.savePlan()">計画を保存</button>
            </div>
            
            <div id="planListSection" style="display: none;">
                <h4>登録済みの計画</h4>
                <div class="plan-list" id="planListContent"></div>
            </div>
        </div>
    </div>
    
    <!-- フッターモーダル -->
    <div id="footerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">タイトル</h3>
                <button class="modal-close" onclick="App.closeFooterModal()">×</button>
            </div>
            <div id="modalBody"></div>
        </div>
        <div class="modal-footer">
            <button class="modal-close-bottom" onclick="App.closeFooterModal()">閉じる</button>
        </div>
    </div>
    
    <!-- 入力ダイアログ -->
    <div id="dialogOverlay" class="dialog-overlay" style="display: none;"></div>
    <div id="inputDialog" class="input-dialog" style="display: none;">
        <h3 id="dialogTitle">タイトル</h3>
        <div id="dialogBody"></div>
        <div class="dialog-buttons">
            <button class="dialog-btn secondary" onclick="App.closeDialog()">キャンセル</button>
            <button class="dialog-btn primary" id="dialogConfirmBtn">確定</button>
        </div>
    </div>

    <!-- 🔥 Firebase SDK v9 (Compat版) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <!-- 🔧 Firebase設定＆初期化 -->
    <script>
    // Firebase設定
    const firebaseConfig = {
        apiKey: "AIzaSyCa3-o7VIbxDzZDy7_SPHTk1kqpq23I79s",
        authDomain: "gakushusintyoku.firebaseapp.com",
        projectId: "gakushusintyoku",
        storageBucket: "gakushusintyoku.firebasestorage.app",
        messagingSenderId: "386582438890",
        appId: "1:386582438890:web:78cd619f0d7ad3ae5a0893"
    };

    // Firebase初期化
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    </script>

    <!-- 📱 JavaScript モジュール読み込み（順序重要） -->
    <script src="data-manager.js"></script>
    <script src="ui-components.js"></script>
    <script src="analytics.js"></script>
    <script src="qa-module.js"></script>
    <script src="timer-module.js"></script>
    <script src="keypoints-module.js"></script>
    <script src="app.js"></script>

    <!-- 🔥 修正済み完全固定ユーザーID版Firebase統合コード -->
<script>
console.log("🚀 完全修正版Firebase統合開始（サブコレクション対応版）");

// 🔧 Firebase設定とオフライン永続化
try {
    // Firestoreのオフライン永続化（重要：他の処理より先に実行）
    firebase.firestore().enablePersistence({ 
        synchronizeTabs: true,
        experimentalForceOwningTab: true 
    }).then(() => {
        console.log("✅ Firebase オフライン永続化有効");
    }).catch((err) => {
        if (err.code === 'failed-precondition') {
            console.log("⚠️ 複数タブ開いているため永続化無効");
        } else if (err.code === 'unimplemented') {
            console.log("⚠️ ブラウザが永続化非対応");
        }
    });
} catch (error) {
    console.error("Firebase設定エラー:", error);
}

// 🔑 超安定固定ユーザーID生成（完全固定版）
function generateUltraStableUserId() {
    // より安定した要素のみ使用
    const stableElements = [
        navigator.userAgent.split(' ')[0], // ブラウザ名のみ
        navigator.platform,
        screen.width,
        screen.height,
        navigator.language,
        navigator.hardwareConcurrency || '4',
        new Date().getTimezoneOffset().toString()
    ];
    
    // 最も安定したハッシュ生成
    let hash = 'stable';
    const combined = stableElements.join('|');
    
    for (let i = 0; i < combined.length; i++) {
        const char = combined.charCodeAt(i);
        hash = ((hash << 5) - hash + char) & 0xffffffff;
    }
    
    // デバイスタイプ判定（簡素化）
    const isMobile = /Mobile|Android|iPhone|iPad/.test(navigator.userAgent);
    const deviceType = isMobile ? 'mobile' : 'desktop';
    
    // 完全固定ID（時間要素一切なし）
    const baseId = Math.abs(hash).toString(36).padStart(8, '0');
    return `${deviceType}_${baseId}_permanent`;
}

// 🏪 複数ストレージからの確実なID取得
async function getOrCreateFixedUserId() {
    console.log("🔍 固定ID取得・生成開始");
    
    // 1. 既存IDを複数の場所から検索
    let existingId = null;
    
    // LocalStorage
    existingId = localStorage.getItem('ultraStableUserId');
    if (existingId) {
        console.log("✅ LocalStorageから固定ID取得");
        await backupIdToAllStorages(existingId);
        return existingId;
    }
    
    // SessionStorage
    existingId = sessionStorage.getItem('ultraStableUserId');
    if (existingId) {
        console.log("✅ SessionStorageから固定ID復元");
        await backupIdToAllStorages(existingId);
        return existingId;
    }
    
    // Cookie
    existingId = getCookieValue('ultraStableUserId');
    if (existingId) {
        console.log("✅ Cookieから固定ID復元");
        await backupIdToAllStorages(existingId);
        return existingId;
    }
    
    // IndexedDB
    existingId = await loadFromIndexedDB('ultraStableUserId');
    if (existingId) {
        console.log("✅ IndexedDBから固定ID復元");
        await backupIdToAllStorages(existingId);
        return existingId;
    }
    
    // 2. Firebase検索（既存データがあるかもしれない）
    const calculatedId = generateUltraStableUserId();
    const firebaseId = await searchExistingDataInFirebase(calculatedId);
    if (firebaseId) {
        console.log("✅ Firebaseから既存データ発見");
        await backupIdToAllStorages(firebaseId);
        return firebaseId;
    }
    
    // 3. 新規ID生成
    console.log("🆕 新しい超安定固定ID生成");
    const newId = calculatedId;
    await backupIdToAllStorages(newId);
    return newId;
}

// 🔍 Firebaseで既存データ検索
async function searchExistingDataInFirebase(calculatedId) {
    try {
        console.log("🔍 Firebase既存データ検索中...");
        
        // 1. 直接IDで検索
        const directDoc = await db.collection('users').doc(calculatedId).get();
        if (directDoc.exists) {
            console.log("✅ Firebase直接検索ヒット");
            return calculatedId;
        }
        
        // 2. デバイス指紋でクエリ検索
        const fingerprint = generateUltraStableUserId().split('_')[1]; // ハッシュ部分
        const querySnapshot = await db.collection('users')
            .where('deviceFingerprint', '==', fingerprint)
            .limit(1)
            .get();
        
        if (!querySnapshot.empty) {
            const doc = querySnapshot.docs[0];
            console.log("✅ Firebase指紋検索ヒット");
            return doc.id;
        }
        
        console.log("📭 Firebase既存データなし");
        return null;
    } catch (error) {
        console.error("Firebase検索エラー:", error);
        return null;
    }
}

// 💾 全ストレージにバックアップ
async function backupIdToAllStorages(userId) {
    // LocalStorage
    localStorage.setItem('ultraStableUserId', userId);
    
    // SessionStorage  
    sessionStorage.setItem('ultraStableUserId', userId);
    
    // Cookie（1年間有効）
    setCookie('ultraStableUserId', userId, 365);
    
    // IndexedDB
    await saveToIndexedDB('ultraStableUserId', userId);
    
    console.log("💾 全ストレージにID保存完了:", userId);
}

// 🍪 Cookie操作
function setCookie(name, value, days) {
    const expires = new Date();
    expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));
    document.cookie = `${name}=${value};expires=${expires.toUTCString()};path=/;SameSite=Lax;Secure`;
}

function getCookieValue(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return null;
}

// 💿 IndexedDB操作（Promise版・エラー修正）
function saveToIndexedDB(key, value) {
    return new Promise((resolve) => {
        try {
            const request = indexedDB.open('StudyTrackerPermanentDB', 1);
            
            request.onupgradeneeded = function(e) {
                const db = e.target.result;
                console.log("🔧 IndexedDB初期化中...");
                if (!db.objectStoreNames.contains('permanentData')) {
                    const store = db.createObjectStore('permanentData', { keyPath: 'key' });
                    console.log("✅ IndexedDBオブジェクトストア作成");
                }
            };
            
            request.onsuccess = function(e) {
                const db = e.target.result;
                try {
                    // オブジェクトストアの存在確認
                    if (!db.objectStoreNames.contains('permanentData')) {
                        console.warn("⚠️ オブジェクトストアが存在しません");
                        resolve(false);
                        return;
                    }
                    
                    const transaction = db.transaction(['permanentData'], 'readwrite');
                    const store = transaction.objectStore('permanentData');
                    
                    const putRequest = store.put({ 
                        key: key, 
                        value: value, 
                        timestamp: Date.now(),
                        version: '2.1'
                    });
                    
                    putRequest.onsuccess = () => {
                        console.log("✅ IndexedDB保存成功:", key);
                        resolve(true);
                    };
                    
                    putRequest.onerror = (error) => {
                        console.error("❌ IndexedDB保存エラー:", error);
                        resolve(false);
                    };
                    
                    transaction.onerror = (error) => {
                        console.error("❌ IndexedDBトランザクションエラー:", error);
                        resolve(false);
                    };
                    
                } catch (error) {
                    console.error("❌ IndexedDB操作エラー:", error);
                    resolve(false);
                }
            };
            
            request.onerror = (error) => {
                console.error("❌ IndexedDBオープンエラー:", error);
                resolve(false);
            };
            
            request.onblocked = () => {
                console.warn("⚠️ IndexedDBがブロックされています");
                resolve(false);
            };
            
        } catch (error) {
            console.error("❌ IndexedDB初期化エラー:", error);
            resolve(false);
        }
    });
}

function loadFromIndexedDB(key) {
    return new Promise((resolve) => {
        try {
            const request = indexedDB.open('StudyTrackerPermanentDB', 1);
            
            request.onupgradeneeded = function(e) {
                const db = e.target.result;
                console.log("🔧 IndexedDB初期化中（読み込み）...");
                if (!db.objectStoreNames.contains('permanentData')) {
                    const store = db.createObjectStore('permanentData', { keyPath: 'key' });
                    console.log("✅ IndexedDBオブジェクトストア作成（読み込み時）");
                }
            };
            
            request.onsuccess = function(e) {
                const db = e.target.result;
                try {
                    // オブジェクトストアの存在確認
                    if (!db.objectStoreNames.contains('permanentData')) {
                        console.log("📭 IndexedDBオブジェクトストアなし");
                        resolve(null);
                        return;
                    }
                    
                    const transaction = db.transaction(['permanentData'], 'readonly');
                    const store = transaction.objectStore('permanentData');
                    const getRequest = store.get(key);
                    
                    getRequest.onsuccess = function() {
                        if (getRequest.result && getRequest.result.value) {
                            console.log("✅ IndexedDB読み込み成功:", key);
                            resolve(getRequest.result.value);
                        } else {
                            console.log("📭 IndexedDBにデータなし:", key);
                            resolve(null);
                        }
                    };
                    
                    getRequest.onerror = (error) => {
                        console.error("❌ IndexedDB取得エラー:", error);
                        resolve(null);
                    };
                    
                    transaction.onerror = (error) => {
                        console.error("❌ IndexedDBトランザクションエラー:", error);
                        resolve(null);
                    };
                    
                } catch (error) {
                    console.error("❌ IndexedDB操作エラー:", error);
                    resolve(null);
                }
            };
            
            request.onerror = (error) => {
                console.error("❌ IndexedDBオープンエラー:", error);
                resolve(null);
            };
            
            request.onblocked = () => {
                console.warn("⚠️ IndexedDBがブロックされています");
                resolve(null);
            };
            
        } catch (error) {
            console.error("❌ IndexedDB読み込みエラー:", error);
            resolve(null);
        }
    });
}

// 🆔 グローバル固定ID（初期化後設定）
let ULTRA_STABLE_USER_ID = null;

// ⭐️ 完全修正版：Firebaseからサブコレクションを含む全データ読み込み
async function loadAllDataFromFirebase() {
    if (!ULTRA_STABLE_USER_ID) {
        console.error("❌ ユーザーIDが設定されていません");
        return false;
    }
    
    console.log("📥 Firebaseから全データ読み込み開始...");
    
    try {
        const userRef = db.collection('users').doc(ULTRA_STABLE_USER_ID);
        
        // 1. 問題集データの読み込み
        const booksSnapshot = await userRef.collection('books').get();
        if (!booksSnapshot.empty) {
            const books = {};
            booksSnapshot.forEach(doc => {
                books[doc.id] = doc.data();
            });
            DataManager.books = books;
            DataManager.saveBooksToStorage();
            console.log(`✅ 問題集 ${Object.keys(books).length}件読み込み`);
        } else {
            console.log("📭 問題集データなし");
        }
        
        // 2. 学習記録の読み込み
        const recordsSnapshot = await userRef.collection('records').orderBy('timestamp', 'desc').limit(1000).get();
        if (!recordsSnapshot.empty) {
            const records = [];
            recordsSnapshot.forEach(doc => {
                records.push(doc.data());
            });
            DataManager.allRecords = records;
            DataManager.saveRecordsToStorage();
            console.log(`✅ 学習記録 ${records.length}件読み込み`);
        } else {
            console.log("📭 学習記録なし");
        }
        
        // 3. 学習計画の読み込み
        const plansSnapshot = await userRef.collection('studyPlans').get();
        if (!plansSnapshot.empty) {
            const plans = [];
            plansSnapshot.forEach(doc => {
                plans.push(doc.data());
            });
            DataManager.studyPlans = plans;
            DataManager.saveStudyPlans();
            console.log(`✅ 学習計画 ${plans.length}件読み込み`);
        } else {
            console.log("📭 学習計画なし");
        }
        
        // 4. 一問一答データの読み込み
        const qaSnapshot = await userRef.collection('qaQuestions').get();
        if (!qaSnapshot.empty) {
            const qaQuestions = {};
            qaSnapshot.forEach(doc => {
                qaQuestions[doc.id] = doc.data();
            });
            DataManager.qaQuestions = qaQuestions;
            DataManager.saveQAQuestions();
            console.log(`✅ 一問一答 ${Object.keys(qaQuestions).length}セット読み込み`);
        } else {
            console.log("📭 一問一答データなし");
        }
        
        // 5. CSVテンプレートの読み込み
        const templatesSnapshot = await userRef.collection('csvTemplates').get();
        if (!templatesSnapshot.empty) {
            const templates = {};
            templatesSnapshot.forEach(doc => {
                templates[doc.id] = doc.data();
            });
            DataManager.csvTemplates = templates;
            DataManager.saveCSVTemplates();
            console.log(`✅ CSVテンプレート ${Object.keys(templates).length}件読み込み`);
        } else {
            console.log("📭 CSVテンプレートなし");
        }
        
        // 6. その他メタデータの読み込み
        const metaDoc = await userRef.get();
        if (metaDoc.exists) {
            const metaData = metaDoc.data();
            
            // 試験日設定
            if (metaData.examDate) {
                DataManager.examDate = new Date(metaData.examDate);
                DataManager.saveExamDate(DataManager.examDate);
                console.log("✅ 試験日設定読み込み");
            }
            
            // 削除済みデータ
            if (metaData.deletedItems) {
                DataManager.deletedItems = metaData.deletedItems;
                localStorage.setItem('deletedItems', JSON.stringify(metaData.deletedItems));
                console.log("✅ 削除済みアイテム読み込み");
            }
            
            // 並び順
            if (metaData.bookOrder) {
                DataManager.bookOrder = metaData.bookOrder;
                localStorage.setItem('bookOrder', JSON.stringify(metaData.bookOrder));
                console.log("✅ 問題集並び順読み込み");
            }
            
            // 分析カード並び順
            if (metaData.analysisCardOrder) {
                DataManager.analysisCardOrder = metaData.analysisCardOrder;
                localStorage.setItem('analysisCardOrder', JSON.stringify(metaData.analysisCardOrder));
                console.log("✅ 分析カード並び順読み込み");
            }
        } else {
            console.log("📭 メタデータなし");
        }
        
        console.log("✅ Firebaseから全データ読み込み完了");
        return true;
        
    } catch (error) {
        console.error("❌ Firebase読み込みエラー:", error);
        return false;
    }
}

// ⭐️ 完全修正版：Firebaseへサブコレクションを含む全データ保存
async function saveAllDataToFirebase() {
    if (!ULTRA_STABLE_USER_ID) {
        console.error("❌ ユーザーIDが設定されていません");
        return false;
    }
    
    console.log("📤 Firebaseへ全データ保存開始...");
    
    try {
        const userRef = db.collection('users').doc(ULTRA_STABLE_USER_ID);
        const batch = db.batch();
        
        // メタデータを保存
        batch.set(userRef, {
            userId: ULTRA_STABLE_USER_ID,
            deviceFingerprint: ULTRA_STABLE_USER_ID.split('_')[1],
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
            examDate: DataManager.examDate ? DataManager.examDate.toISOString() : null,
            deletedItems: DataManager.deletedItems || {},
            bookOrder: DataManager.bookOrder || [],
            analysisCardOrder: DataManager.analysisCardOrder || []
        }, { merge: true });
        
        await batch.commit();
        console.log("✅ メタデータ保存完了");
        
        // 1. 問題集データの保存（バッチ処理）
        if (DataManager.books && Object.keys(DataManager.books).length > 0) {
            const booksBatch = db.batch();
            let bookCount = 0;
            
            for (const [bookId, bookData] of Object.entries(DataManager.books)) {
                const bookRef = userRef.collection('books').doc(bookId);
                booksBatch.set(bookRef, bookData);
                bookCount++;
                
                // バッチサイズ制限（500件）
                if (bookCount % 450 === 0) {
                    await booksBatch.commit();
                    console.log(`📚 問題集 ${bookCount}件保存中...`);
                }
            }
            
            await booksBatch.commit();
            console.log(`✅ 問題集 ${bookCount}件保存完了`);
        }
        
        // 2. 学習記録の保存（最新1000件のみ）
        if (DataManager.allRecords && DataManager.allRecords.length > 0) {
            const recordsBatch = db.batch();
            const recordsToSave = DataManager.allRecords.slice(0, 1000); // 最新1000件
            
            for (let i = 0; i < recordsToSave.length; i++) {
                const record = recordsToSave[i];
                const recordId = `record_${record.timestamp || Date.now()}_${i}`;
                const recordRef = userRef.collection('records').doc(recordId);
                recordsBatch.set(recordRef, record);
                
                if ((i + 1) % 450 === 0) {
                    await recordsBatch.commit();
                    console.log(`📝 記録 ${i + 1}件保存中...`);
                }
            }
            
            await recordsBatch.commit();
            console.log(`✅ 学習記録 ${recordsToSave.length}件保存完了`);
        }
        
        // 3. 学習計画の保存
        if (DataManager.studyPlans && DataManager.studyPlans.length > 0) {
            const plansBatch = db.batch();
            
            for (let i = 0; i < DataManager.studyPlans.length; i++) {
                const plan = DataManager.studyPlans[i];
                const planId = plan.id || `plan_${Date.now()}_${i}`;
                const planRef = userRef.collection('studyPlans').doc(planId);
                plansBatch.set(planRef, plan);
            }
            
            await plansBatch.commit();
            console.log(`✅ 学習計画 ${DataManager.studyPlans.length}件保存完了`);
        }
        
        // 4. 一問一答データの保存
        if (DataManager.qaQuestions && Object.keys(DataManager.qaQuestions).length > 0) {
            const qaBatch = db.batch();
            
            for (const [setName, qaData] of Object.entries(DataManager.qaQuestions)) {
                const qaRef = userRef.collection('qaQuestions').doc(setName);
                qaBatch.set(qaRef, qaData);
            }
            
            await qaBatch.commit();
            console.log(`✅ 一問一答 ${Object.keys(DataManager.qaQuestions).length}セット保存完了`);
        }
        
        // 5. CSVテンプレートの保存
        if (DataManager.csvTemplates && Object.keys(DataManager.csvTemplates).length > 0) {
            const templatesBatch = db.batch();
            
            for (const [templateName, templateData] of Object.entries(DataManager.csvTemplates)) {
                const templateRef = userRef.collection('csvTemplates').doc(templateName);
                templatesBatch.set(templateRef, templateData);
            }
            
            await templatesBatch.commit();
            console.log(`✅ CSVテンプレート ${Object.keys(DataManager.csvTemplates).length}件保存完了`);
        }
        
        console.log("✅ Firebaseへ全データ保存完了");
        return true;
        
    } catch (error) {
        console.error("❌ Firebase保存エラー:", error);
        return false;
    }
}

// ⚡ 初期化メイン処理
(async function initializeFirebaseIntegration() {
    try {
        console.log("🔄 完全修正版Firebase統合初期化開始");
        
        // 固定ID取得・生成
        ULTRA_STABLE_USER_ID = await getOrCreateFixedUserId();
        console.log("🔒 確定した超安定固定ID:", ULTRA_STABLE_USER_ID);
        
        // グローバルからアクセス可能に
        window.ULTRA_STABLE_USER_ID = ULTRA_STABLE_USER_ID;
        
        // Firebase操作を設定
        setupFirebaseOperations();
        
        // ⭐️ Firebaseからデータ読み込み（キャッシュクリア後の復元）
        const loadSuccess = await loadAllDataFromFirebase();
        if (loadSuccess) {
            console.log("✅ Firebaseからデータ復元成功");
            updateAllUI();
            showRestoreNotification(
                (DataManager.books ? Object.keys(DataManager.books).length : 0) +
                (DataManager.allRecords ? DataManager.allRecords.length : 0) +
                (DataManager.studyPlans ? DataManager.studyPlans.length : 0),
                1
            );
        } else {
            console.log("📭 Firebaseに保存データなし（新規ユーザー）");
        }
        
        console.log("✅ 完全修正版Firebase統合初期化完了");
        
    } catch (error) {
        console.error("❌ Firebase統合初期化エラー:", error);
    }
})();

// 🔥 Firebase操作設定（修正版）
function setupFirebaseOperations() {
    // data-manager.jsのFirebase機能と固定IDを連携
    if (window.DataManager) {
        // 固定IDをcurrentUserとして設定
        DataManager.currentUser = { uid: ULTRA_STABLE_USER_ID };
        DataManager.firebaseEnabled = true;
        
        console.log("✅ 固定ID連携完了:", ULTRA_STABLE_USER_ID);
        
        // ⭐️ DataManagerのsaveToFirebaseを完全修正版に置き換え
        DataManager.saveToFirebase = saveAllDataToFirebase;
        
        // ⭐️ DataManagerのsyncWithFirebaseを完全修正版に置き換え
        DataManager.syncWithFirebase = loadAllDataFromFirebase;
        
        // アクティビティ記録用（軽量）
        DataManager.saveActivityToFirestore = async function(activityData) {
            if (!ULTRA_STABLE_USER_ID) return false;
            
            try {
                const activityRef = db.collection('users').doc(ULTRA_STABLE_USER_ID)
                    .collection('activities').doc();
                    
                await activityRef.set({
                    ...activityData,
                    timestamp: new Date().toISOString(),
                    userId: ULTRA_STABLE_USER_ID
                });
                
                return true;
            } catch (error) {
                console.warn("アクティビティ記録失敗:", error);
                return false;
            }
        };
        
        // 初回保存を実行
        setTimeout(() => {
            saveAllDataToFirebase().then(() => {
                console.log("✅ 初回同期完了");
            }).catch(error => {
                console.warn("初回同期失敗:", error);
            });
        }, 2000);
    }
}

// ⭐️ UI更新（改良版）
function updateAllUI() {
    setTimeout(() => {
        try {
            if (window.App && typeof App.renderBookCards === 'function') {
                App.renderBookCards();
                console.log("✅ 問題集カード再描画");
            }
            if (window.Analytics) {
                if (typeof Analytics.updateHistoryContent === 'function') {
                    Analytics.updateHistoryContent();
                }
                if (typeof Analytics.updateHeatmapBookSelect === 'function') {
                    Analytics.updateHeatmapBookSelect();
                }
                if (typeof Analytics.updateRadarBookSelect === 'function') {
                    Analytics.updateRadarBookSelect();
                }
                if (typeof Analytics.switchChartView === 'function') {
                    Analytics.switchChartView('day');
                }
                console.log("✅ 分析画面再描画");
            }
            if (window.UIComponents) {
                if (typeof UIComponents.renderCalendar === 'function') {
                    UIComponents.renderCalendar();
                    console.log("✅ カレンダー再描画");
                }
                if (typeof UIComponents.updateExamCountdown === 'function') {
                    UIComponents.updateExamCountdown();
                    console.log("✅ 試験日カウントダウン更新");
                }
            }
            if (window.KeyPointsModule && typeof KeyPointsModule.loadKeyPointsData === 'function') {
                KeyPointsModule.loadKeyPointsData();
                console.log("✅ KeyPointsModule再読み込み");
            }
            if (window.QAModule && typeof QAModule.loadQuestionSets === 'function') {
                QAModule.loadQuestionSets();
                console.log("✅ 一問一答再読み込み");
            }
            console.log("✅ 全UI更新完了");
        } catch (error) {
            console.error("⚠️ UI更新エラー:", error);
        }
    }, 500);
}

// 🔔 通知機能
function showSuccessNotification(recordCount, syncCount) {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #4caf50, #66bb6a);
        color: white;
        padding: 15px 20px;
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(76, 175, 80, 0.4);
        z-index: 9999;
        font-weight: 600;
        animation: slideInRight 0.3s ease;
    `;
    notification.innerHTML = `
        ✅ 保存完了！<br>
        記録: ${recordCount || 0}件<br>
        同期: ${syncCount || 0}回<br>
        ID: ${ULTRA_STABLE_USER_ID?.substring(0, 12)}...
    `;
    document.body.appendChild(notification);
    
    setTimeout(() => notification.remove(), 3000);
}

function showRestoreNotification(restoredCount, syncCount) {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 80px;
        right: 20px;
        background: linear-gradient(135deg, #2196f3, #42a5f5);
        color: white;
        padding: 15px 20px;
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(33, 150, 243, 0.4);
        z-index: 9999;
        font-weight: 600;
        animation: slideInRight 0.3s ease;
    `;
    notification.innerHTML = `
        🔄 データ復元完了！<br>
        復元: ${restoredCount}項目<br>
        同期: ${syncCount}回<br>
        固定ID使用中
    `;
    document.body.appendChild(notification);
    
    setTimeout(() => notification.remove(), 4000);
}

function showErrorNotification(message) {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #f44336, #ef5350);
        color: white;
        padding: 15px 20px;
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(244, 67, 54, 0.4);
        z-index: 9999;
        font-weight: 600;
        animation: slideInRight 0.3s ease;
    `;
    notification.innerHTML = `❌ エラー<br>${message}`;
    document.body.appendChild(notification);
    
    setTimeout(() => notification.remove(), 5000);
}

// 🎯 保存処理のFirebase統合拡張
// 1. 学習記録保存の拡張
const originalSaveRecord = App.saveRecord;
if (typeof originalSaveRecord === 'function') {
    App.saveRecord = function() {
        console.log("💾 学習記録保存（完全修正版）");
        originalSaveRecord.call(this);
        
        if (ULTRA_STABLE_USER_ID) {
            // ⭐️ 完全修正版の保存処理を呼び出し
            saveAllDataToFirebase().then(() => {
                console.log("✅ 学習記録Firebase保存完了");
            }).catch(error => {
                console.warn("学習記録Firebase保存失敗:", error);
            });
        }
    };
}

// 2. カレンダー（学習計画）保存の拡張
const originalSavePlan = UIComponents.savePlan;
if (typeof originalSavePlan === 'function') {
    UIComponents.savePlan = function() {
        console.log("📅 学習計画保存（完全修正版）");
        originalSavePlan.call(this);
        
        if (ULTRA_STABLE_USER_ID) {
            saveAllDataToFirebase().then(() => {
                console.log("✅ 学習計画Firebase保存完了");
            }).catch(error => {
                console.warn("学習計画Firebase保存失敗:", error);
            });
        }
    };
}

// 3. 問題集データ保存の拡張
const originalSaveBooksToStorage = DataManager.saveBooksToStorage;
if (typeof originalSaveBooksToStorage === 'function') {
    DataManager.saveBooksToStorage = function() {
        console.log("📚 問題集データ保存（完全修正版）");
        originalSaveBooksToStorage.call(this);
        
        if (ULTRA_STABLE_USER_ID) {
            saveAllDataToFirebase().then(() => {
                console.log("✅ 問題集Firebase保存完了");
            }).catch(error => {
                console.warn("問題集Firebase保存失敗:", error);
            });
        }
    };
}

// 🎛️ 管理ボタン追加
document.addEventListener('DOMContentLoaded', function() {
    console.log("🎛️ 管理ボタン追加（完全修正版）");
    
    setTimeout(() => {
        const header = document.querySelector('.app-header');
        if (header && ULTRA_STABLE_USER_ID) {
            // 既存ボタン削除
            const existing = header.querySelector('[data-firebase-btn]');
            if (existing) existing.remove();
            
            // 保存テストボタン
            const testBtn = document.createElement('button');
            testBtn.setAttribute('data-firebase-btn', 'true');
            testBtn.textContent = '🔒固定ID';
            testBtn.style.cssText = `
                position: absolute;
                top: 20px;
                left: 20px;
                background: linear-gradient(135deg, #9c27b0, #673ab7);
                border: none;
                border-radius: 8px;
                color: white;
                padding: 8px 12px;
                cursor: pointer;
                font-size: 12px;
                font-weight: bold;
                box-shadow: 0 3px 15px rgba(156, 39, 176, 0.4);
                z-index: 1000;
            `;
            testBtn.onclick = function() {
                // ⭐️ 完全修正版の保存処理を呼び出し
                saveAllDataToFirebase().then(() => {
                    showSuccessNotification(0, 1);
                }).catch(error => {
                    showErrorNotification(error.message);
                });
            };
            header.appendChild(testBtn);
            
            // ID情報ボタン
            const infoBtn = document.createElement('button');
            infoBtn.textContent = 'ℹ️';
            infoBtn.style.cssText = `
                position: absolute;
                top: 20px;
                left: 90px;
                background: rgba(156, 39, 176, 0.8);
                border: none;
                border-radius: 50%;
                color: white;
                width: 28px;
                height: 28px;
                cursor: pointer;
                font-size: 12px;
                z-index: 1000;
            `;
            infoBtn.onclick = function() {
                showIdInfo();
            };
            header.appendChild(infoBtn);
            
            // 全同期ボタン
            const syncBtn = document.createElement('button');
            syncBtn.textContent = '🔄';
            syncBtn.style.cssText = `
                position: absolute;
                top: 20px;
                left: 123px;
                background: rgba(33, 150, 243, 0.8);
                border: none;
                border-radius: 50%;
                color: white;
                width: 28px;
                height: 28px;
                cursor: pointer;
                font-size: 12px;
                z-index: 1000;
            `;
            syncBtn.title = "Firebaseから復元";
            syncBtn.onclick = async function() {
                const success = await loadAllDataFromFirebase();
                if (success) {
                    updateAllUI();
                    showRestoreNotification(
                        (DataManager.books ? Object.keys(DataManager.books).length : 0) +
                        (DataManager.allRecords ? DataManager.allRecords.length : 0),
                        1
                    );
                } else {
                    showErrorNotification("復元失敗");
                }
            };
            header.appendChild(syncBtn);
        }
    }, 1000);
});

// ID情報表示
function showIdInfo() {
    const info = `🔒 固定ユーザーID情報

現在のID: ${ULTRA_STABLE_USER_ID}

保存状況:
├ LocalStorage: ${localStorage.getItem('ultraStableUserId') ? '✅' : '❌'}
├ SessionStorage: ${sessionStorage.getItem('ultraStableUserId') ? '✅' : '❌'}
├ Cookie: ${getCookieValue('ultraStableUserId') ? '✅' : '❌'}
└ IndexedDB: 保存済み

✅ 完全修正版機能:
✅ サブコレクション分散保存・読み込み対応
✅ キャッシュクリア後の自動復元
✅ 1MB制限完全回避

Firebase保存構造:
users/${ULTRA_STABLE_USER_ID}/
├── books/ (問題集)
├── records/ (学習記録)
├── studyPlans/ (学習計画)
├── qaQuestions/ (一問一答)
└── csvTemplates/ (テンプレート)

キャッシュクリア後も完全復元されます！`;

    alert(info);
}

// 🎨 アニメーション追加
const style = document.createElement('style');
style.textContent = `
@keyframes slideInRight {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}
`;
document.head.appendChild(style);

console.log("🔒 完全修正版Firebase統合完了");
console.log("🆔 現在のID:", ULTRA_STABLE_USER_ID);
console.log("✅ サブコレクション分散保存・読み込み対応済み");

// デバッグ用関数をグローバルに
window.showIdInfo = showIdInfo;
window.loadAllDataFromFirebase = loadAllDataFromFirebase;
window.saveAllDataToFirebase = saveAllDataToFirebase;
window.ULTRA_STABLE_USER_ID = ULTRA_STABLE_USER_ID;

console.log("🛠️ デバッグ: showIdInfo(), loadAllDataFromFirebase(), saveAllDataToFirebase()");
</script>
</body>
</html>
