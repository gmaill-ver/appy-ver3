<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å­¦ç¿’ãƒˆãƒ©ãƒƒã‚«ãƒ¼ - è¡Œæ”¿æ›¸å£«è©¦é¨“å¯¾ç­–</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="app-header">
        <button class="timer-icon-btn" onclick="App.openTimerModal()" title="ã‚¿ã‚¤ãƒãƒ¼">â°</button>
        <div class="timer-display" id="timerDisplay">00:00:00</div>
        <div class="app-logo">
            <span class="app-logo-icon">ğŸ“š</span>
            <span class="app-title">å­¦ç¿’ãƒˆãƒ©ãƒƒã‚«ãƒ¼</span>
        </div>
        <div class="exam-countdown" id="examCountdown">è©¦é¨“æ—¥ã¾ã§ <span class="days">--</span> æ—¥</div>
    </header>
    
    <!-- ãƒ¡ã‚¤ãƒ³ã‚¿ãƒ– -->
    <div class="main-tabs">
        <button class="main-tab active" onclick="App.switchMainTab('record', event)">è¨˜éŒ²å…¥åŠ›</button>
        <button class="main-tab" onclick="App.switchMainTab('analysis', event)">åˆ†æ</button>
        <button class="main-tab" onclick="App.switchMainTab('progress', event)">é€²æ—</button>
    </div>
    
    <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ -->
    <div class="content-area">
        <!-- è¨˜éŒ²å…¥åŠ›ã‚¿ãƒ– -->
        <div id="record-tab" class="tab-content active">
            <!-- å•é¡Œé›†é¸æŠ -->
            <div class="book-cards-wrapper">
                <button class="book-order-btn" onclick="App.toggleBookSort()">ä¸¦æ›¿ãˆ</button>
                <div id="bookCardsContainer"></div>
            </div>
            
            <!-- ãƒ‘ãƒ³ããšãƒªã‚¹ãƒˆ -->
            <div class="breadcrumb" id="breadcrumb" style="display: none;"></div>
            
            <!-- éšå±¤ãƒªã‚¹ãƒˆ -->
            <div id="recordHierarchyContainer" style="display: none;"></div>
            
            <!-- å•é¡Œå…¥åŠ› -->
            <div class="card" id="questionSection" style="display: none;">
                <div class="card-header">
                    <span class="card-icon">âœï¸</span>
                    <span class="card-title">å•é¡Œåˆ¥æ­£èª¤å…¥åŠ›</span>
                    <!-- â˜…è¿½åŠ : ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ -->
                    <div class="question-nav-buttons">
                        <button class="nav-btn" onclick="App.navigateQuestion(-1)" title="å‰ã¸">â—€</button>
                        <button class="nav-btn" onclick="App.navigateQuestion(1)" title="æ¬¡ã¸">â–¶</button>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="action-btn correct" onclick="App.markCorrect()">
                        <span>â­•</span><span>æ­£è§£</span>
                    </button>
                    <button class="action-btn wrong" onclick="App.markWrong()">
                        <span>âŒ</span><span>ä¸æ­£è§£</span>
                    </button>
                    <button class="action-btn bookmark" id="bookmarkBtn" onclick="App.toggleBookmarkMode()">
                        <span>â­</span><span>ãƒãƒ¼ã‚¯</span>
                    </button>
                </div>
                
                <div class="question-grid" id="questionGrid"></div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalCount">0</div>
                        <div class="stat-label">è§£ç­”æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="correctCount">0</div>
                        <div class="stat-label">æ­£è§£æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="wrongCount">0</div>
                        <div class="stat-label">ä¸æ­£è§£æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="correctRate">0%</div>
                        <div class="stat-label">æ­£ç­”ç‡</div>
                    </div>
                </div>
                
            </div>
            
            <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ -->
            <div class="calendar-container">
                <div class="calendar-header">
                    <div class="calendar-nav">
                        <button class="calendar-nav-btn" onclick="UIComponents.changeMonth(-1)">â—€</button>
                        <span class="calendar-month" id="calendarMonth">2025å¹´1æœˆ</span>
                        <button class="calendar-nav-btn" onclick="UIComponents.changeMonth(1)">â–¶</button>
                    </div>
                    <button class="calendar-nav-btn" onclick="UIComponents.goToToday()">ä»Šæ—¥</button>
                </div>
                <div class="calendar-grid" id="calendarGrid"></div>
                <div class="calendar-actions">
                    <button class="calendar-btn add-plan" onclick="UIComponents.openPlanModal()">ğŸ“ å­¦ç¿’è¨ˆç”»ã‚’è¿½åŠ </button>
                    <button class="calendar-btn view-plans" onclick="UIComponents.viewPlans()">ğŸ“‹ è¨ˆç”»ä¸€è¦§</button>
                </div>
            </div>
        </div>
        
        <!-- åˆ†æã‚¿ãƒ– -->
        <div id="analysis-tab" class="tab-content">
            <button class="card-sort-btn" onclick="App.toggleAnalysisSort()">ä¸¦æ›¿ãˆ</button>
            <div id="analysisCardsContainer">
                <!-- å­¦ç¿’ã‚°ãƒ©ãƒ• -->
                <div class="accordion" data-card-id="chart">
                    <div class="accordion-header" onclick="App.toggleAccordion(this)">
                        <span>ğŸ“Š å­¦ç¿’ã‚°ãƒ©ãƒ•</span>
                        <span class="accordion-arrow">â–¼</span>
                    </div>
                    <div class="accordion-content">
                        <div class="chart-controls">
                            <button class="chart-btn active" onclick="Analytics.switchChartView('day', this)">æ—¥åˆ¥</button>
                            <button class="chart-btn" onclick="Analytics.switchChartView('week', this)">é€±é–“</button>
                            <button class="chart-btn" onclick="Analytics.switchChartView('month', this)">æœˆé–“</button>
                        </div>
                        <div class="chart-wrapper">
                            <div class="chart-bars" id="chartBars"></div>
                        </div>
                    </div>
                </div>
                
                <!-- å­¦ç¿’å±¥æ­´ -->
                <div class="accordion" data-card-id="history">
                    <div class="accordion-header" onclick="App.toggleAccordion(this)">
                        <span>ğŸ“… å­¦ç¿’å±¥æ­´</span>
                        <span class="accordion-arrow">â–¼</span>
                    </div>
                    <div class="accordion-content">
                        <div id="historyContent"></div>
                    </div>
                </div>
                
                <!-- ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ— -->
                <div class="accordion" data-card-id="heatmap">
                    <div class="accordion-header" onclick="App.toggleAccordion(this)">
                        <span>ğŸ—ºï¸ å•é¡Œãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—</span>
                        <span class="accordion-arrow">â–¼</span>
                    </div>
                    <div class="accordion-content">
                        <div class="heatmap-controls">
                            <select class="heatmap-select" id="heatmapBookSelect" onchange="Analytics.updateHeatmap()">
                                <option value="">å•é¡Œé›†ã‚’é¸æŠ</option>
                            </select>
                            <button class="heatmap-toggle-btn" id="heatmapToggleBtn" onclick="Analytics.toggleHeatmapPinned()">ğŸ“Œ</button>
                        </div>
                        <div class="heatmap-grid" id="heatmapGrid"></div>
                    </div>
                </div>
                
                <!-- å¼±ç‚¹åˆ†æ -->
                <div class="accordion" data-card-id="weakness">
                    <div class="accordion-header" onclick="App.toggleAccordion(this)">
                        <span>ğŸ¯ å¼±ç‚¹åˆ†æ</span>
                        <span class="accordion-arrow">â–¼</span>
                    </div>
                    <div class="accordion-content">
                        <div id="weaknessAnalysis"></div>
                    </div>
                </div>
            </div>
        
        <!-- é€²æ—ã‚¿ãƒ– -->
        <div id="progress-tab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <span class="card-icon">ğŸ“Š</span>
                    <span class="card-title">å…¨ä½“é€²æ—çŠ¶æ³</span>
                </div>
                <div id="overallProgress"></div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <span class="card-icon">ğŸ“ˆ</span>
                    <span class="card-title">ç§‘ç›®åˆ¥é€²æ—</span>
                </div>
                <div class="radar-chart-container">
                    <div class="radar-chart-controls">
                        <select class="radar-chart-select" id="radarBookSelect" onchange="Analytics.drawRadarChart()">
                            <option value="">å•é¡Œé›†ã‚’é¸æŠ</option>
                        </select>
                        <button class="radar-toggle-btn" id="radarToggleBtn" onclick="Analytics.toggleRadarPinned()">ğŸ“Œ å›ºå®šè¡¨ç¤º</button>
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <button class="chart-btn active" id="radarModeSubject" onclick="Analytics.setRadarMode('subject', this)">ç§‘ç›®åˆ¥</button>
                            <button class="chart-btn" id="radarModeCompare" onclick="Analytics.setRadarMode('compare', this)">å•é¡Œé›†æ¯”è¼ƒ</button>
                        </div>
                    </div>
                    <canvas id="radarChart" width="300" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ãƒ•ãƒƒã‚¿ãƒ¼ã‚¿ãƒ– -->
    <div class="footer-tabs">
        <button class="footer-tab active" onclick="App.switchFooterTab('register', event)">
            <span class="footer-tab-icon">ğŸ“</span>
            <span class="footer-tab-label">ç™»éŒ²</span>
        </button>
        <button class="footer-tab" onclick="App.switchFooterTab('qa', event)">
            <span class="footer-tab-icon">â“</span>
            <span class="footer-tab-label">ä¸€å•ä¸€ç­”</span>
        </button>
        <button class="footer-tab" onclick="App.switchFooterTab('keypoints', event)">
            <span class="footer-tab-icon">ğŸ“š</span>
            <span class="footer-tab-label">è¦ç‚¹ç¢ºèª</span>
        </button>
        <button class="footer-tab" onclick="App.switchFooterTab('results', event)">
            <span class="footer-tab-icon">ğŸ†</span>
            <span class="footer-tab-label">å®Ÿç¸¾</span>
        </button>
        <button class="footer-tab" onclick="App.switchFooterTab('settings', event)">
            <span class="footer-tab-icon">âš™ï¸</span>
            <span class="footer-tab-label">è¨­å®š</span>
        </button>
    </div>
    
    <!-- ã‚¿ã‚¤ãƒãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="timerModal" class="timer-modal">
        <div class="timer-modal-content">
            <div class="modal-header">
                <h3>â° ã‚¿ã‚¤ãƒãƒ¼</h3>
                <button class="modal-close" onclick="TimerModule.closeModal()">Ã—</button>
            </div>
            
            <div class="timer-tabs">
                <button class="timer-tab active" onclick="TimerModule.switchTab('stopwatch', this)">ã‚¹ãƒˆãƒƒãƒ—ã‚¦ã‚©ãƒƒãƒ</button>
                <button class="timer-tab" onclick="TimerModule.switchTab('countdown', this)">ã‚¿ã‚¤ãƒãƒ¼</button>
                <button class="timer-tab" onclick="TimerModule.switchTab('interval', this)">ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«</button>
            </div>
            
            <div id="stopwatchTab" class="timer-tab-content">
                <div class="timer-display-large" id="stopwatchDisplay">00:00:00</div>
                <div class="timer-controls">
                    <button class="timer-btn start" onclick="TimerModule.startStopwatch()">é–‹å§‹</button>
                    <button class="timer-btn pause" onclick="TimerModule.pauseStopwatch()">ä¸€æ™‚åœæ­¢</button>
                    <button class="timer-btn reset" onclick="TimerModule.resetStopwatch()">ãƒªã‚»ãƒƒãƒˆ</button>
                </div>
            </div>
            
            <div id="countdownTab" class="timer-tab-content" style="display: none;">
                <div class="timer-input-group">
                    <label class="timer-input-label">ã‚¿ã‚¤ãƒãƒ¼è¨­å®š</label>
                    <div class="timer-input-row">
                        <input type="number" class="timer-input" id="countdownHours" placeholder="æ™‚" min="0" max="23">
                        <span>æ™‚é–“</span>
                        <input type="number" class="timer-input" id="countdownMinutes" placeholder="åˆ†" min="0" max="59">
                        <span>åˆ†</span>
                        <input type="number" class="timer-input" id="countdownSeconds" placeholder="ç§’" min="0" max="59">
                        <span>ç§’</span>
                    </div>
                </div>
                <div class="timer-display-large" id="countdownDisplay">00:00:00</div>
                <div class="timer-controls">
                    <button class="timer-btn start" onclick="TimerModule.startCountdown()">é–‹å§‹</button>
                    <button class="timer-btn pause" onclick="TimerModule.pauseCountdown()">ä¸€æ™‚åœæ­¢</button>
                    <button class="timer-btn reset" onclick="TimerModule.resetCountdown()">ãƒªã‚»ãƒƒãƒˆ</button>
                </div>
            </div>
            
            <div id="intervalTab" class="timer-tab-content" style="display: none;">
                <div class="timer-input-group">
                    <label class="timer-input-label">ä½œæ¥­æ™‚é–“</label>
                    <div class="timer-input-row">
                        <input type="number" class="timer-input" id="workMinutes" value="25" min="1">
                        <span>åˆ†</span>
                    </div>
                </div>
                <div class="timer-input-group">
                    <label class="timer-input-label">ä¼‘æ†©æ™‚é–“</label>
                    <div class="timer-input-row">
                        <input type="number" class="timer-input" id="breakMinutes" value="5" min="1">
                        <span>åˆ†</span>
                    </div>
                </div>
                <div class="timer-input-group">
                    <label class="timer-input-label">ã‚»ãƒƒãƒˆæ•°</label>
                    <div class="timer-input-row">
                        <input type="number" class="timer-input" id="intervalSets" value="4" min="1">
                        <span>ã‚»ãƒƒãƒˆ</span>
                    </div>
                </div>
                <div class="timer-display-large" id="intervalDisplay">00:00</div>
                <div style="text-align: center; margin: 10px 0;">
                    <span id="intervalStatus">å¾…æ©Ÿä¸­</span> | 
                    <span id="intervalSetCount">0/0 ã‚»ãƒƒãƒˆ</span>
                </div>
                <div class="timer-controls">
                    <button class="timer-btn start" onclick="TimerModule.startInterval()">é–‹å§‹</button>
                    <button class="timer-btn pause" onclick="TimerModule.pauseInterval()">ä¸€æ™‚åœæ­¢</button>
                    <button class="timer-btn reset" onclick="TimerModule.resetInterval()">ãƒªã‚»ãƒƒãƒˆ</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- å­¦ç¿’è¨ˆç”»ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="planModal" class="plan-modal">
        <div class="plan-modal-content">
            <div class="modal-header">
                <h3 id="planModalTitle">ğŸ“… å­¦ç¿’è¨ˆç”»</h3>
                <button class="modal-close" onclick="UIComponents.closePlanModal()">Ã—</button>
            </div>
            
            <div id="planFormSection">
                <div class="plan-form-group">
                    <label class="plan-form-label">è¨ˆç”»ã‚¿ã‚¤ãƒˆãƒ«</label>
                    <input type="text" class="plan-form-control" id="planTitle" placeholder="ä¾‹ï¼šæ°‘æ³•ç·å‰‡ã®å¾©ç¿’">
                </div>
                
                <div class="plan-form-group">
                    <label class="plan-form-label">è¨ˆç”»å†…å®¹</label>
                    <textarea class="plan-form-control" id="planContent" rows="3" placeholder="å­¦ç¿’å†…å®¹ã®è©³ç´°ã‚’å…¥åŠ›"></textarea>
                </div>
                
                <div class="plan-form-group">
                    <label class="plan-form-label">è¡¨ç¤ºå½¢å¼</label>
                    <div class="plan-display-type">
                        <label>
                            <input type="radio" name="displayType" value="bullet" checked>
                            <span>ãƒ»</span>
                        </label>
                        <label>
                            <input type="radio" name="displayType" value="text">
                            <span>é€šå¸¸è¡¨ç¤º</span>
                        </label>
                    </div>
                </div>
                
                <div class="plan-form-group">
                    <label class="plan-form-label">æ—¥ä»˜ç¯„å›²</label>
                    <div class="date-range-inputs">
                        <input type="date" class="plan-form-control" id="planStartDate">
                        <span>ã€œ</span>
                        <input type="date" class="plan-form-control" id="planEndDate">
                    </div>
                </div>
                
                <div class="plan-form-group">
                    <label class="plan-form-label">è‰²è¨­å®š</label>
                    <div class="color-picker" id="colorPicker">
                        <div class="color-option selected" style="background: #3498db;" data-color="#3498db"></div>
                        <div class="color-option" style="background: #10b981;" data-color="#10b981"></div>
                        <div class="color-option" style="background: #f59e0b;" data-color="#f59e0b"></div>
                        <div class="color-option" style="background: #ef4444;" data-color="#ef4444"></div>
                        <div class="color-option" style="background: #8b5cf6;" data-color="#8b5cf6"></div>
                        <div class="color-option" style="background: #ec4899;" data-color="#ec4899"></div>
                        <div class="color-option" style="background: #6b7280;" data-color="#6b7280"></div>
                    </div>
                </div>
                
                <input type="hidden" id="editPlanId" value="">
                <button class="save-button" onclick="UIComponents.savePlan()">è¨ˆç”»ã‚’ä¿å­˜</button>
            </div>
            
            <div id="planListSection" style="display: none;">
                <h4>ç™»éŒ²æ¸ˆã¿ã®è¨ˆç”»</h4>
                <div class="plan-list" id="planListContent"></div>
            </div>
        </div>
    </div>
    
    <!-- ãƒ•ãƒƒã‚¿ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="footerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">ã‚¿ã‚¤ãƒˆãƒ«</h3>
                <button class="modal-close" onclick="App.closeFooterModal()">Ã—</button>
            </div>
            <div id="modalBody"></div>
        </div>
        <div class="modal-footer">
            <button class="modal-close-bottom" onclick="App.closeFooterModal()">é–‰ã˜ã‚‹</button>
        </div>
    </div>
    
    <!-- å…¥åŠ›ãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
    <div id="dialogOverlay" class="dialog-overlay" style="display: none;"></div>
    <div id="inputDialog" class="input-dialog" style="display: none;">
        <h3 id="dialogTitle">ã‚¿ã‚¤ãƒˆãƒ«</h3>
        <div id="dialogBody"></div>
        <div class="dialog-buttons">
            <button class="dialog-btn secondary" onclick="App.closeDialog()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button class="dialog-btn primary" id="dialogConfirmBtn">ç¢ºå®š</button>
        </div>
    </div>

    <!-- ğŸ”¥ Firebase SDK v9 (Compatç‰ˆ) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <!-- ğŸ”§ Firebaseè¨­å®šï¼†åˆæœŸåŒ– -->
    <script>
    // Firebaseè¨­å®š
    const firebaseConfig = {
        apiKey: "AIzaSyCa3-o7VIbxDzZDy7_SPHTk1kqpq23I79s",
        authDomain: "gakushusintyoku.firebaseapp.com",
        projectId: "gakushusintyoku",
        storageBucket: "gakushusintyoku.firebasestorage.app",
        messagingSenderId: "386582438890",
        appId: "1:386582438890:web:78cd619f0d7ad3ae5a0893"
    };

    // FirebaseåˆæœŸåŒ–
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    </script>

    <!-- ğŸ“± JavaScript ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«èª­ã¿è¾¼ã¿ï¼ˆé †åºé‡è¦ï¼‰ -->
    <script src="data-manager.js"></script>
    <script src="ui-components.js"></script>
    <script src="analytics.js"></script>
    <script src="qa-module.js"></script>
    <script src="timer-module.js"></script>
    <script src="keypoints-module.js"></script>
    <script src="app.js"></script>

    <!-- ğŸ”¥ å®Œå…¨å›ºå®šãƒ¦ãƒ¼ã‚¶ãƒ¼IDç‰ˆFirebaseçµ±åˆã‚³ãƒ¼ãƒ‰ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢å®Œå…¨å¯¾å¿œï¼‰ -->
    <script>
    console.log("ğŸš€ å®Œå…¨å›ºå®šFirebaseçµ±åˆé–‹å§‹ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢å¯¾å¿œç‰ˆï¼‰");

    // ğŸ”§ Firebaseè¨­å®šã¨ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ°¸ç¶šåŒ–
    try {
        // Firestoreã®ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ°¸ç¶šåŒ–ï¼ˆé‡è¦ï¼šä»–ã®å‡¦ç†ã‚ˆã‚Šå…ˆã«å®Ÿè¡Œï¼‰
        firebase.firestore().enablePersistence({ 
            synchronizeTabs: true,
            experimentalForceOwningTab: true 
        }).then(() => {
            console.log("âœ… Firebase ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ°¸ç¶šåŒ–æœ‰åŠ¹");
        }).catch((err) => {
            if (err.code === 'failed-precondition') {
                console.log("âš ï¸ è¤‡æ•°ã‚¿ãƒ–é–‹ã„ã¦ã„ã‚‹ãŸã‚æ°¸ç¶šåŒ–ç„¡åŠ¹");
            } else if (err.code === 'unimplemented') {
                console.log("âš ï¸ ãƒ–ãƒ©ã‚¦ã‚¶ãŒæ°¸ç¶šåŒ–éå¯¾å¿œ");
            }
        });
    } catch (error) {
        console.error("Firebaseè¨­å®šã‚¨ãƒ©ãƒ¼:", error);
    }

    // ğŸ”‘ è¶…å®‰å®šå›ºå®šãƒ¦ãƒ¼ã‚¶ãƒ¼IDç”Ÿæˆï¼ˆå®Œå…¨å›ºå®šç‰ˆï¼‰
    function generateUltraStableUserId() {
        // ã‚ˆã‚Šå®‰å®šã—ãŸè¦ç´ ã®ã¿ä½¿ç”¨
        const stableElements = [
            navigator.userAgent.split(' ')[0], // ãƒ–ãƒ©ã‚¦ã‚¶åã®ã¿
            navigator.platform,
            screen.width,
            screen.height,
            navigator.language,
            navigator.hardwareConcurrency || '4',
            new Date().getTimezoneOffset().toString()
        ];
        
        // æœ€ã‚‚å®‰å®šã—ãŸãƒãƒƒã‚·ãƒ¥ç”Ÿæˆ
        let hash = 'stable';
        const combined = stableElements.join('|');
        
        for (let i = 0; i < combined.length; i++) {
            const char = combined.charCodeAt(i);
            hash = ((hash << 5) - hash + char) & 0xffffffff;
        }
        
        // ãƒ‡ãƒã‚¤ã‚¹ã‚¿ã‚¤ãƒ—åˆ¤å®šï¼ˆç°¡ç´ åŒ–ï¼‰
        const isMobile = /Mobile|Android|iPhone|iPad/.test(navigator.userAgent);
        const deviceType = isMobile ? 'mobile' : 'desktop';
        
        // å®Œå…¨å›ºå®šIDï¼ˆæ™‚é–“è¦ç´ ä¸€åˆ‡ãªã—ï¼‰
        const baseId = Math.abs(hash).toString(36).padStart(8, '0');
        return `${deviceType}_${baseId}_permanent`;
    }

    // ğŸª è¤‡æ•°ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ã®ç¢ºå®ŸãªIDå–å¾—
    async function getOrCreateFixedUserId() {
        console.log("ğŸ” å›ºå®šIDå–å¾—ãƒ»ç”Ÿæˆé–‹å§‹");
        
        // 1. æ—¢å­˜IDã‚’è¤‡æ•°ã®å ´æ‰€ã‹ã‚‰æ¤œç´¢
        let existingId = null;
        
        // LocalStorage
        existingId = localStorage.getItem('ultraStableUserId');
        if (existingId) {
            console.log("âœ… LocalStorageã‹ã‚‰å›ºå®šIDå–å¾—");
            await backupIdToAllStorages(existingId);
            return existingId;
        }
        
        // SessionStorage
        existingId = sessionStorage.getItem('ultraStableUserId');
        if (existingId) {
            console.log("âœ… SessionStorageã‹ã‚‰å›ºå®šIDå¾©å…ƒ");
            await backupIdToAllStorages(existingId);
            return existingId;
        }
        
        // Cookie
        existingId = getCookieValue('ultraStableUserId');
        if (existingId) {
            console.log("âœ… Cookieã‹ã‚‰å›ºå®šIDå¾©å…ƒ");
            await backupIdToAllStorages(existingId);
            return existingId;
        }
        
        // IndexedDB
        existingId = await loadFromIndexedDB('ultraStableUserId');
        if (existingId) {
            console.log("âœ… IndexedDBã‹ã‚‰å›ºå®šIDå¾©å…ƒ");
            await backupIdToAllStorages(existingId);
            return existingId;
        }
        
        // 2. Firebaseæ¤œç´¢ï¼ˆæ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹ã‹ã‚‚ã—ã‚Œãªã„ï¼‰
        const calculatedId = generateUltraStableUserId();
        const firebaseId = await searchExistingDataInFirebase(calculatedId);
        if (firebaseId) {
            console.log("âœ… Firebaseã‹ã‚‰æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ç™ºè¦‹");
            await backupIdToAllStorages(firebaseId);
            return firebaseId;
        }
        
        // 3. æ–°è¦IDç”Ÿæˆ
        console.log("ğŸ†• æ–°ã—ã„è¶…å®‰å®šå›ºå®šIDç”Ÿæˆ");
        const newId = calculatedId;
        await backupIdToAllStorages(newId);
        return newId;
    }

    // ğŸ” Firebaseã§æ—¢å­˜ãƒ‡ãƒ¼ã‚¿æ¤œç´¢
    async function searchExistingDataInFirebase(calculatedId) {
        try {
            console.log("ğŸ” Firebaseæ—¢å­˜ãƒ‡ãƒ¼ã‚¿æ¤œç´¢ä¸­...");
            
            // 1. ç›´æ¥IDã§æ¤œç´¢
            const directDoc = await db.collection('permanentUsers').doc(calculatedId).get();
            if (directDoc.exists) {
                console.log("âœ… Firebaseç›´æ¥æ¤œç´¢ãƒ’ãƒƒãƒˆ");
                return calculatedId;
            }
            
            // 2. ãƒ‡ãƒã‚¤ã‚¹æŒ‡ç´‹ã§ã‚¯ã‚¨ãƒªæ¤œç´¢
            const fingerprint = generateUltraStableUserId().split('_')[1]; // ãƒãƒƒã‚·ãƒ¥éƒ¨åˆ†
            const querySnapshot = await db.collection('permanentUsers')
                .where('deviceFingerprint', '==', fingerprint)
                .limit(1)
                .get();
            
            if (!querySnapshot.empty) {
                const doc = querySnapshot.docs[0];
                console.log("âœ… FirebaseæŒ‡ç´‹æ¤œç´¢ãƒ’ãƒƒãƒˆ");
                return doc.id;
            }
            
            console.log("ğŸ“­ Firebaseæ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãªã—");
            return null;
        } catch (error) {
            console.error("Firebaseæ¤œç´¢ã‚¨ãƒ©ãƒ¼:", error);
            return null;
        }
    }

    // ğŸ’¾ å…¨ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
    async function backupIdToAllStorages(userId) {
        // LocalStorage
        localStorage.setItem('ultraStableUserId', userId);
        
        // SessionStorage  
        sessionStorage.setItem('ultraStableUserId', userId);
        
        // Cookieï¼ˆ1å¹´é–“æœ‰åŠ¹ï¼‰
        setCookie('ultraStableUserId', userId, 365);
        
        // IndexedDB
        await saveToIndexedDB('ultraStableUserId', userId);
        
        console.log("ğŸ’¾ å…¨ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«IDä¿å­˜å®Œäº†:", userId);
    }

    // ğŸª Cookieæ“ä½œ
    function setCookie(name, value, days) {
        const expires = new Date();
        expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));
        document.cookie = `${name}=${value};expires=${expires.toUTCString()};path=/;SameSite=Lax;Secure`;
    }

    function getCookieValue(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
        return null;
    }

    // ğŸ’¿ IndexedDBæ“ä½œï¼ˆPromiseç‰ˆãƒ»ã‚¨ãƒ©ãƒ¼ä¿®æ­£ï¼‰
    function saveToIndexedDB(key, value) {
        return new Promise((resolve) => {
            try {
                const request = indexedDB.open('StudyTrackerPermanentDB', 1);
                
                request.onupgradeneeded = function(e) {
                    const db = e.target.result;
                    console.log("ğŸ”§ IndexedDBåˆæœŸåŒ–ä¸­...");
                    if (!db.objectStoreNames.contains('permanentData')) {
                        const store = db.createObjectStore('permanentData', { keyPath: 'key' });
                        console.log("âœ… IndexedDBã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¹ãƒˆã‚¢ä½œæˆ");
                    }
                };
                
                request.onsuccess = function(e) {
                    const db = e.target.result;
                    try {
                        // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¹ãƒˆã‚¢ã®å­˜åœ¨ç¢ºèª
                        if (!db.objectStoreNames.contains('permanentData')) {
                            console.warn("âš ï¸ ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¹ãƒˆã‚¢ãŒå­˜åœ¨ã—ã¾ã›ã‚“");
                            resolve(false);
                            return;
                        }
                        
                        const transaction = db.transaction(['permanentData'], 'readwrite');
                        const store = transaction.objectStore('permanentData');
                        
                        const putRequest = store.put({ 
                            key: key, 
                            value: value, 
                            timestamp: Date.now(),
                            version: '2.1'
                        });
                        
                        putRequest.onsuccess = () => {
                            console.log("âœ… IndexedDBä¿å­˜æˆåŠŸ:", key);
                            resolve(true);
                        };
                        
                        request.onerror = (event) => {
    console.error("âŒ IndexedDBã‚ªãƒ¼ãƒ—ãƒ³ã‚¨ãƒ©ãƒ¼:", event);
    // â˜…è¿½åŠ : ã‚¨ãƒ©ãƒ¼æ™‚ã§ã‚‚ã‚¢ãƒ—ãƒªç¶™ç¶šã®ãŸã‚ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    try {
        // LocalStorageã§ä»£æ›¿
        const fallbackValue = localStorage.getItem(key);
        if (fallbackValue) {
            console.log("ğŸ“ LocalStorageã‹ã‚‰ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å–å¾—");
            resolve(fallbackValue);
        } else {
            resolve(false);
        }
    } catch (fallbackError) {
        console.error("ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚‚å¤±æ•—:", fallbackError);
        resolve(false);
    }
};
                        
                        transaction.onerror = (error) => {
                            console.error("âŒ IndexedDBãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼:", error);
                            resolve(false);
                        };
                        
                    } catch (error) {
                        console.error("âŒ IndexedDBæ“ä½œã‚¨ãƒ©ãƒ¼:", error);
                        resolve(false);
                    }
                };
                
                request.onerror = (error) => {
                    console.error("âŒ IndexedDBã‚ªãƒ¼ãƒ—ãƒ³ã‚¨ãƒ©ãƒ¼:", error);
                    resolve(false);
                };
                
                request.onblocked = () => {
                    console.warn("âš ï¸ IndexedDBãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™");
                    resolve(false);
                };
                
            } catch (error) {
                console.error("âŒ IndexedDBåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:", error);
                resolve(false);
            }
        });
    }

    function loadFromIndexedDB(key) {
        return new Promise((resolve) => {
            try {
                const request = indexedDB.open('StudyTrackerPermanentDB', 1);
                
                request.onupgradeneeded = function(e) {
                    const db = e.target.result;
                    console.log("ğŸ”§ IndexedDBåˆæœŸåŒ–ä¸­ï¼ˆèª­ã¿è¾¼ã¿ï¼‰...");
                    if (!db.objectStoreNames.contains('permanentData')) {
                        const store = db.createObjectStore('permanentData', { keyPath: 'key' });
                        console.log("âœ… IndexedDBã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¹ãƒˆã‚¢ä½œæˆï¼ˆèª­ã¿è¾¼ã¿æ™‚ï¼‰");
                    }
                };
                
                request.onsuccess = function(e) {
                    const db = e.target.result;
                    try {
                        // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¹ãƒˆã‚¢ã®å­˜åœ¨ç¢ºèª
                        if (!db.objectStoreNames.contains('permanentData')) {
                            console.log("ğŸ“­ IndexedDBã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¹ãƒˆã‚¢ãªã—");
                            resolve(null);
                            return;
                        }
                        
                        const transaction = db.transaction(['permanentData'], 'readonly');
                        const store = transaction.objectStore('permanentData');
                        const getRequest = store.get(key);
                        
                        getRequest.onsuccess = function() {
                            if (getRequest.result && getRequest.result.value) {
                                console.log("âœ… IndexedDBèª­ã¿è¾¼ã¿æˆåŠŸ:", key);
                                resolve(getRequest.result.value);
                            } else {
                                console.log("ğŸ“­ IndexedDBã«ãƒ‡ãƒ¼ã‚¿ãªã—:", key);
                                resolve(null);
                            }
                        };
                        
                        getRequest.onerror = (error) => {
                            console.error("âŒ IndexedDBå–å¾—ã‚¨ãƒ©ãƒ¼:", error);
                            resolve(null);
                        };
                        
                        transaction.onerror = (error) => {
                            console.error("âŒ IndexedDBãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼:", error);
                            resolve(null);
                        };
                        
                    } catch (error) {
                        console.error("âŒ IndexedDBæ“ä½œã‚¨ãƒ©ãƒ¼:", error);
                        resolve(null);
                    }
                };
                
                request.onerror = (error) => {
                    console.error("âŒ IndexedDBã‚ªãƒ¼ãƒ—ãƒ³ã‚¨ãƒ©ãƒ¼:", error);
                    resolve(null);
                };
                
                request.onblocked = () => {
                    console.warn("âš ï¸ IndexedDBãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™");
                    resolve(null);
                };
                
            } catch (error) {
                console.error("âŒ IndexedDBèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", error);
                resolve(null);
            }
        });
    }

    // ğŸ†” ã‚°ãƒ­ãƒ¼ãƒãƒ«å›ºå®šIDï¼ˆåˆæœŸåŒ–å¾Œè¨­å®šï¼‰
    let ULTRA_STABLE_USER_ID = null;

    // âš¡ åˆæœŸåŒ–ãƒ¡ã‚¤ãƒ³å‡¦ç†
    (async function initializeFirebaseIntegration() {
        try {
            console.log("ğŸ”„ Firebaseçµ±åˆåˆæœŸåŒ–é–‹å§‹");
            
            // å›ºå®šIDå–å¾—ãƒ»ç”Ÿæˆ
            ULTRA_STABLE_USER_ID = await getOrCreateFixedUserId();
            console.log("ğŸ”’ ç¢ºå®šã—ãŸè¶…å®‰å®šå›ºå®šID:", ULTRA_STABLE_USER_ID);
            
            // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã«
            window.ULTRA_STABLE_USER_ID = ULTRA_STABLE_USER_ID;
            
            // Firebaseæ“ä½œã‚’è¨­å®š
            setupFirebaseOperations();
            
            // åˆæœŸãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
            await loadFromFirebaseInstantly();
            
            console.log("âœ… Firebaseçµ±åˆåˆæœŸåŒ–å®Œäº†");
            
        } catch (error) {
            console.error("âŒ Firebaseçµ±åˆåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:", error);
        }
    })();

    // ğŸ”¥ Firebaseæ“ä½œè¨­å®š
    function setupFirebaseOperations() {
        // ä¿å­˜å‡¦ç†
        DataManager.saveToFirestore = async function(data) {
            try {
                if (!ULTRA_STABLE_USER_ID) {
                    console.error("âŒ å›ºå®šIDãŒæœªè¨­å®š");
                    return false;
                }
                
                console.log("ğŸ“¤ è¶…å®‰å®šIDä¿å­˜é–‹å§‹:", ULTRA_STABLE_USER_ID);
                
                const userRef = db.collection('permanentUsers').doc(ULTRA_STABLE_USER_ID);
                
                // ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                const userDoc = await userRef.get();
                let existingData = userDoc.exists ? userDoc.data() : {
                    userId: ULTRA_STABLE_USER_ID,
                    deviceFingerprint: ULTRA_STABLE_USER_ID.split('_')[1],
                    createdAt: new Date().toISOString(),
                    deviceInfo: {
                        userAgent: navigator.userAgent,
                        platform: navigator.platform,
                        language: navigator.language
                    }
                };
                
                // å­¦ç¿’è¨˜éŒ²è¿½åŠ 
                if (!existingData.studyRecords) {
                    existingData.studyRecords = [];
                }
                
                const newRecord = {
                    ...data,
                    timestamp: new Date().toISOString(),
                    deviceType: /Mobile|Android|iPhone|iPad/.test(navigator.userAgent) ? 'mobile' : 'desktop',
                    recordId: 'rec_' + Date.now() + '_' + Math.random().toString(36).substring(2, 6)
                };
                
                existingData.studyRecords.unshift(newRecord);
                
                // æœ€æ–°100ä»¶ã¾ã§ä¿æŒ
                if (existingData.studyRecords.length > 100) {
                    existingData.studyRecords = existingData.studyRecords.slice(0, 100);
                }
                
                // å…¨ãƒ‡ãƒ¼ã‚¿çµ±åˆä¿å­˜
                existingData.allRecords = DataManager.allRecords || [];
                existingData.books = DataManager.books || {};
                existingData.studyPlans = DataManager.studyPlans || [];
                existingData.qaQuestions = DataManager.qaQuestions || {};
                existingData.csvTemplates = DataManager.csvTemplates || {};
                existingData.examDate = DataManager.examDate ? DataManager.examDate.toISOString() : null;
                existingData.heatmapPinnedBook = DataManager.heatmapPinnedBook || null;
                existingData.radarPinnedBook = DataManager.radarPinnedBook || null;
                existingData.bookOrder = DataManager.bookOrder || [];
                existingData.analysisCardOrder = DataManager.analysisCardOrder || [];
                existingData.keyPointsData = KeyPointsModule.subjects || {};

                // ã€é‡è¦ã€‘å‰Šé™¤æ¸ˆã¿ã‚¢ã‚¤ãƒ†ãƒ ãƒªã‚¹ãƒˆã‚‚ä¿å­˜
                existingData.deletedItems = DataManager.deletedItems || [];
                
                // ã€é‡è¦ã€‘å•é¡Œãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã‚‚ä¿å­˜
                existingData.savedQuestionStates = DataManager.savedQuestionStates || {};
                
                // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿æ›´æ–°
                existingData.lastUpdated = new Date().toISOString();
                existingData.lastDevice = /Mobile|Android|iPhone|iPad/.test(navigator.userAgent) ? 'mobile' : 'desktop';
                existingData.syncCount = (existingData.syncCount || 0) + 1;
                
                // Firestoreä¿å­˜
                await userRef.set(existingData, { merge: true });
                
                console.log("âœ… è¶…å®‰å®šIDä¿å­˜æˆåŠŸ");
                showSuccessNotification(existingData.studyRecords.length, existingData.syncCount);
                
                return true;
            } catch (error) {
                console.error("âŒ Firebaseä¿å­˜ã‚¨ãƒ©ãƒ¼:", error);
                showErrorNotification(error.message);
                return false;
            }
        };
        
        // èª­ã¿è¾¼ã¿å‡¦ç†
        DataManager.loadFromFirestore = async function() {
            if (!ULTRA_STABLE_USER_ID) return;
            
            console.log("ğŸ“¥ è¶…å®‰å®šIDèª­ã¿è¾¼ã¿é–‹å§‹:", ULTRA_STABLE_USER_ID);
            
            const userRef = db.collection('permanentUsers').doc(ULTRA_STABLE_USER_ID);
            
            // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–
            userRef.onSnapshot((doc) => {
                if (doc.exists) {
                    const userData = doc.data();
                    console.log("ğŸ“¥ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°æ¤œçŸ¥");
                    restoreAllDataFromFirebase(userData);
                } else {
                    console.log("ğŸ“­ Firebaseãƒ‡ãƒ¼ã‚¿ãªã—");
                }
            }, (error) => {
                console.error("âŒ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–ã‚¨ãƒ©ãƒ¼:", error);
            });
        };
    }

    // ğŸ“¥ å³åº§ã«ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    async function loadFromFirebaseInstantly() {
        if (!ULTRA_STABLE_USER_ID) return;
        
        try {
            const userRef = db.collection('permanentUsers').doc(ULTRA_STABLE_USER_ID);
            const doc = await userRef.get();
            
            if (doc.exists) {
                console.log("ğŸ“¥ å³åº§ã«Firebaseãƒ‡ãƒ¼ã‚¿å¾©å…ƒ");
                restoreAllDataFromFirebase(doc.data());
            } else {
                console.log("ğŸ“­ Firebaseã«åˆå›ãƒ‡ãƒ¼ã‚¿ãªã—");
                // åˆå›ãƒ‡ãƒ¼ã‚¿ç§»è¡Œã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
                setTimeout(() => {
                    if (DataManager.books && Object.keys(DataManager.books).length > 0) {
                        DataManager.saveToFirestore({
                            type: "initialMigration",
                            message: "åˆå›ãƒ‡ãƒ¼ã‚¿ç§»è¡Œ"
                        });
                    }
                }, 2000);
            }
        } catch (error) {
            console.error("âŒ å³åº§èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", error);
        }
    }

    // ğŸ”„ å…¨ãƒ‡ãƒ¼ã‚¿å¾©å…ƒå‡¦ç†ï¼ˆä¿®æ­£ç‰ˆï¼‰
    // ğŸ”„ å…¨ãƒ‡ãƒ¼ã‚¿å¾©å…ƒå‡¦ç†ï¼ˆä¿®æ­£ç‰ˆï¼‰
    function restoreAllDataFromFirebase(userData) {
        let restoredCount = 0;
        
        try {
            // â˜…è¿½åŠ : å‰Šé™¤æ¸ˆã¿ã‚¢ã‚¤ãƒ†ãƒ ãƒªã‚¹ãƒˆã‚’æœ€åˆã«å¾©å…ƒï¼ˆé †åºé‡è¦ï¼ï¼‰
            if (userData.deletedItems && Array.isArray(userData.deletedItems)) {
                DataManager.deletedItems = userData.deletedItems;
                localStorage.setItem('deletedItems', JSON.stringify(userData.deletedItems));
                console.log(`âœ… å‰Šé™¤æ¸ˆã¿ã‚¢ã‚¤ãƒ†ãƒ å¾©å…ƒ: ${userData.deletedItems.length}ä»¶`);
            }
            
            // å­¦ç¿’å±¥æ­´
            if (userData.allRecords && Array.isArray(userData.allRecords)) {
                DataManager.allRecords = userData.allRecords;
                localStorage.setItem('studyHistory', JSON.stringify(userData.allRecords));
                restoredCount++;
            }
            
            // å•é¡Œé›†ï¼ˆå‰Šé™¤æ¸ˆã¿ã‚’é™¤å¤–ï¼‰
if (userData.books && typeof userData.books === 'object') {
    // â˜…è¿½åŠ : å‰Šé™¤æ¸ˆã¿ã‚’é™¤å¤–ã—ã¦ã‹ã‚‰å¾©å…ƒ
    const filteredBooks = {};
    Object.keys(userData.books).forEach(bookId => {
        if (!DataManager.isDeleted('books', bookId)) {
            const book = userData.books[bookId];
            // â˜…è¿½åŠ : å‰Šé™¤æ¸ˆã¿éšå±¤ã‚¢ã‚¤ãƒ†ãƒ ã‚’é™¤å¤–
            if (book.structure) {
                book.structure = DataManager.filterDeletedHierarchy(book.structure, bookId, []);
            }
            filteredBooks[bookId] = book;
        }
    });
    DataManager.books = filteredBooks;
    localStorage.setItem('studyTrackerBooks', JSON.stringify(filteredBooks));
    restoredCount++;
}

// å•é¡Œé›†é †åºï¼ˆå‰Šé™¤æ¸ˆã¿é™¤å¤–ï¼‰
if (userData.bookOrder && Array.isArray(userData.bookOrder)) {
    DataManager.bookOrder = userData.bookOrder.filter(id => !DataManager.isDeleted('books', id));
    localStorage.setItem('bookOrder', JSON.stringify(DataManager.bookOrder));
    restoredCount++;
}
            
            // ã€é‡è¦ã€‘å‰Šé™¤æ¸ˆã¿ã‚¢ã‚¤ãƒ†ãƒ ãƒªã‚¹ãƒˆã®å¾©å…ƒã‚’è¿½åŠ 
            if (userData.deletedItems && Array.isArray(userData.deletedItems)) {
                DataManager.deletedItems = userData.deletedItems;
                localStorage.setItem('deletedItems', JSON.stringify(userData.deletedItems));
                restoredCount++;
                console.log(`âœ… å‰Šé™¤æ¸ˆã¿ã‚¢ã‚¤ãƒ†ãƒ å¾©å…ƒ: ${userData.deletedItems.length}ä»¶`);
            }
            
            // å­¦ç¿’è¨ˆç”»
            if (userData.studyPlans && Array.isArray(userData.studyPlans)) {
                DataManager.studyPlans = userData.studyPlans;
                localStorage.setItem('studyPlans', JSON.stringify(userData.studyPlans));
                restoredCount++;
            }
            
            // ä¸€å•ä¸€ç­”
            if (userData.qaQuestions && typeof userData.qaQuestions === 'object') {
                DataManager.qaQuestions = userData.qaQuestions;
                localStorage.setItem('qaQuestions', JSON.stringify(userData.qaQuestions));
                restoredCount++;
            }

            // CSVãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
            if (userData.csvTemplates && typeof userData.csvTemplates === 'object') {
                DataManager.csvTemplates = userData.csvTemplates;
                localStorage.setItem('csvTemplates', JSON.stringify(userData.csvTemplates));
                restoredCount++;
            }
            
            // ã€é‡è¦ã€‘å•é¡Œãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã®å¾©å…ƒã‚’è¿½åŠ 
            if (userData.savedQuestionStates && typeof userData.savedQuestionStates === 'object') {
                DataManager.savedQuestionStates = userData.savedQuestionStates;
                localStorage.setItem('savedQuestionStates', JSON.stringify(userData.savedQuestionStates));
                restoredCount++;
                console.log(`âœ… å•é¡Œãƒã‚§ãƒƒã‚¯çŠ¶æ…‹å¾©å…ƒ: ${Object.keys(userData.savedQuestionStates).length}ä»¶`);
            }

            // è¦ç‚¹ç¢ºèªãƒ‡ãƒ¼ã‚¿ï¼ˆä¿®æ­£ç‰ˆï¼‰
            if (userData.keyPointsData && typeof userData.keyPointsData === 'object') {
                localStorage.setItem('keyPointsData', JSON.stringify(userData.keyPointsData));
                
                // KeyPointsModuleãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹å ´åˆã¯ç›´æ¥æ›´æ–°
                if (window.KeyPointsModule && KeyPointsModule.subjects) {
                    // å®Œå…¨ã«ãƒ‡ãƒ¼ã‚¿ã‚’ç½®ãæ›ãˆã‚‹
                    KeyPointsModule.subjects = userData.keyPointsData;
                    console.log(`âœ… è¦ç‚¹ç¢ºèªãƒ‡ãƒ¼ã‚¿å¾©å…ƒ: ${Object.keys(userData.keyPointsData).length}ç§‘ç›®`);
                }
                restoredCount++;
            }
            
            // ãã®ä»–è¨­å®š
            if (userData.examDate) {
                DataManager.examDate = new Date(userData.examDate);
                localStorage.setItem('examDate', userData.examDate);
                restoredCount++;
            }
            
            if (userData.bookOrder && Array.isArray(userData.bookOrder)) {
                DataManager.bookOrder = userData.bookOrder;
                localStorage.setItem('bookOrder', JSON.stringify(userData.bookOrder));
                restoredCount++;
            }

            if (userData.heatmapPinnedBook) {
                DataManager.heatmapPinnedBook = userData.heatmapPinnedBook;
                localStorage.setItem('heatmapPinnedBook', userData.heatmapPinnedBook);
                restoredCount++;
            }

            if (userData.radarPinnedBook) {
                DataManager.radarPinnedBook = userData.radarPinnedBook;
                localStorage.setItem('radarPinnedBook', userData.radarPinnedBook);
                restoredCount++;
            }

            if (userData.analysisCardOrder && Array.isArray(userData.analysisCardOrder)) {
                DataManager.analysisCardOrder = userData.analysisCardOrder;
                localStorage.setItem('analysisCardOrder', JSON.stringify(userData.analysisCardOrder));
                restoredCount++;
            }
            
            console.log(`âœ… å…¨ãƒ‡ãƒ¼ã‚¿å¾©å…ƒå®Œäº† - ${restoredCount}é …ç›®`);
            
            if (restoredCount > 0) {
                showRestoreNotification(restoredCount, userData.syncCount || 0);
                updateAllUI();
            }
            
        } catch (error) {
            console.error("âŒ ãƒ‡ãƒ¼ã‚¿å¾©å…ƒã‚¨ãƒ©ãƒ¼:", error);
        }
    }

    // ğŸ–¥ï¸ UIæ›´æ–°ï¼ˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å†æç”»ã‚’å¼·åŒ–ï¼‰
    function updateAllUI() {
        setTimeout(() => {
            try {
                if (window.App && typeof App.renderBookCards === 'function') {
                    App.renderBookCards();
                }
                if (window.Analytics && typeof Analytics.updateHistoryContent === 'function') {
                    Analytics.updateHistoryContent();
                    Analytics.updateHeatmapBookSelect();
                    Analytics.updateRadarBookSelect();
                }
                if (window.UIComponents) {
                    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’å¼·åˆ¶çš„ã«å†æç”»
                    if (typeof UIComponents.renderCalendar === 'function') {
                        UIComponents.renderCalendar();
                        console.log("âœ… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å†æç”»å®Œäº†");
                    }
                    if (typeof UIComponents.updateExamCountdown === 'function') {
                        UIComponents.updateExamCountdown();
                    }
                }
                // KeyPointsModuleã®å†åˆæœŸåŒ–
                if (window.KeyPointsModule && typeof KeyPointsModule.loadKeyPointsData === 'function') {
                    KeyPointsModule.loadKeyPointsData();
                    console.log("âœ… KeyPointsModuleå†èª­ã¿è¾¼ã¿å®Œäº†");
                }
                console.log("âœ… UIæ›´æ–°å®Œäº†");
            } catch (error) {
                console.error("âš ï¸ UIæ›´æ–°ã‚¨ãƒ©ãƒ¼:", error);
            }
        }, 200);
    }

    // ğŸ”” é€šçŸ¥æ©Ÿèƒ½
    function showSuccessNotification(recordCount, syncCount) {
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #4caf50, #66bb6a);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(76, 175, 80, 0.4);
            z-index: 9999;
            font-weight: 600;
            animation: slideInRight 0.3s ease;
        `;
        notification.innerHTML = `
            âœ… ä¿å­˜å®Œäº†ï¼<br>
            è¨˜éŒ²: ${recordCount}ä»¶<br>
            åŒæœŸ: ${syncCount}å›<br>
            ID: ${ULTRA_STABLE_USER_ID?.substring(0, 12)}...
        `;
        document.body.appendChild(notification);
        
        setTimeout(() => notification.remove(), 3000);
    }

    function showRestoreNotification(restoredCount, syncCount) {
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 80px;
            right: 20px;
            background: linear-gradient(135deg, #2196f3, #42a5f5);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(33, 150, 243, 0.4);
            z-index: 9999;
            font-weight: 600;
            animation: slideInRight 0.3s ease;
        `;
        notification.innerHTML = `
            ğŸ”„ ãƒ‡ãƒ¼ã‚¿å¾©å…ƒå®Œäº†ï¼<br>
            å¾©å…ƒ: ${restoredCount}é …ç›®<br>
            åŒæœŸ: ${syncCount}å›<br>
            å›ºå®šIDä½¿ç”¨ä¸­
        `;
        document.body.appendChild(notification);
        
        setTimeout(() => notification.remove(), 4000);
    }

    function showErrorNotification(message) {
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #f44336, #ef5350);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(244, 67, 54, 0.4);
            z-index: 9999;
            font-weight: 600;
            animation: slideInRight 0.3s ease;
        `;
        notification.innerHTML = `âŒ ã‚¨ãƒ©ãƒ¼<br>${message}`;
        document.body.appendChild(notification);
        
        setTimeout(() => notification.remove(), 5000);
    }

    // ğŸ¯ å…¨ä¿å­˜å‡¦ç†ã®Firebaseçµ±åˆæ‹¡å¼µ
    
    // 1. å­¦ç¿’è¨˜éŒ²ä¿å­˜ã®æ‹¡å¼µ
    const originalSaveRecord = App.saveRecord;
    App.saveRecord = function() {
        console.log("ğŸ’¾ å­¦ç¿’è¨˜éŒ²ä¿å­˜ï¼ˆè¶…å®‰å®šIDç‰ˆï¼‰");
        originalSaveRecord.call(this);
        
        if (!ULTRA_STABLE_USER_ID) {
    console.error("âŒ å›ºå®šIDãŒæœªè¨­å®šã®ãŸã‚ä¿å­˜ã‚¹ã‚­ãƒƒãƒ—");
    // â˜…è¿½åŠ : ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®ã¿ã§å‹•ä½œç¶™ç¶š
    try {
        localStorage.setItem('studyHistory', JSON.stringify(DataManager.allRecords || []));
        console.log("ğŸ“ ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜");
    } catch (localError) {
        console.error("ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ã‚‚å¤±æ•—:", localError);
    }
    return;
}
        
        const record = {
            type: "studyRecord",
            bookId: this.currentBook?.id,
            bookName: this.currentBook?.name,
            path: this.currentPath ? [...this.currentPath] : [],
            questionsCount: this.questionStates ? Object.keys(this.questionStates).length : 0,
            stats: {
                total: parseInt(document.getElementById('totalCount')?.textContent || '0'),
                correct: parseInt(document.getElementById('correctCount')?.textContent || '0'),
                wrong: parseInt(document.getElementById('wrongCount')?.textContent || '0'),
                rate: document.getElementById('correctRate')?.textContent || '0%'
            }
        };
        
        DataManager.saveToFirestore(record);
    };

    // 2. ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆå­¦ç¿’è¨ˆç”»ï¼‰ä¿å­˜ã®æ‹¡å¼µ
    const originalSavePlan = UIComponents.savePlan;
    UIComponents.savePlan = function() {
        console.log("ğŸ“… å­¦ç¿’è¨ˆç”»ä¿å­˜ï¼ˆFirebaseçµ±åˆç‰ˆï¼‰");
        originalSavePlan.call(this);
        
        if (ULTRA_STABLE_USER_ID) {
            DataManager.saveToFirestore({
                type: "studyPlan",
                action: "save",
                planCount: DataManager.studyPlans ? DataManager.studyPlans.length : 0,
                message: "å­¦ç¿’è¨ˆç”»ã‚’ä¿å­˜ã—ã¾ã—ãŸ"
            });
        }
    };

    // 3. å•é¡Œé›†ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã®æ‹¡å¼µ
    const originalSaveBooksToStorage = DataManager.saveBooksToStorage;
    DataManager.saveBooksToStorage = function() {
        console.log("ğŸ“š å•é¡Œé›†ãƒ‡ãƒ¼ã‚¿ä¿å­˜ï¼ˆFirebaseçµ±åˆç‰ˆï¼‰");
        originalSaveBooksToStorage.call(this);
        
        if (ULTRA_STABLE_USER_ID) {
            DataManager.saveToFirestore({
                type: "bookData",
                action: "save",
                bookCount: Object.keys(this.books || {}).length,
                message: "å•é¡Œé›†ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸ"
            });
        }
    };

    // 4. ä¸€å•ä¸€ç­”ä¿å­˜ã®æ‹¡å¼µ
    const originalSaveQAQuestions = DataManager.saveQAQuestions;
    DataManager.saveQAQuestions = function() {
        console.log("â“ ä¸€å•ä¸€ç­”ä¿å­˜ï¼ˆFirebaseçµ±åˆç‰ˆï¼‰");
        originalSaveQAQuestions.call(this);
        
        if (ULTRA_STABLE_USER_ID) {
            DataManager.saveToFirestore({
                type: "qaQuestions",
                action: "save",
                setCount: Object.keys(this.qaQuestions || {}).length,
                message: "ä¸€å•ä¸€ç­”ã‚’ä¿å­˜ã—ã¾ã—ãŸ"
            });
        }
    };

    // 6. è©¦é¨“æ—¥è¨­å®šä¿å­˜ã®æ‹¡å¼µ
    const originalSaveExamDate = DataManager.saveExamDate;
    DataManager.saveExamDate = function(date) {
        console.log("ğŸ“… è©¦é¨“æ—¥è¨­å®šä¿å­˜ï¼ˆFirebaseçµ±åˆç‰ˆï¼‰");
        const result = originalSaveExamDate.call(this, date);
        
        if (result && ULTRA_STABLE_USER_ID) {
            DataManager.saveToFirestore({
                type: "examDate",
                action: "save",
                examDate: date ? date.toISOString() : null,
                message: "è©¦é¨“æ—¥ã‚’è¨­å®šã—ã¾ã—ãŸ"
            });
        }
        
        return result;
    };

    // 7. CSVãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¿å­˜ã®æ‹¡å¼µ
    const originalSaveCSVTemplates = DataManager.saveCSVTemplates;
    DataManager.saveCSVTemplates = function() {
        console.log("ğŸ“„ CSVãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¿å­˜ï¼ˆFirebaseçµ±åˆç‰ˆï¼‰");
        originalSaveCSVTemplates.call(this);
        
        if (ULTRA_STABLE_USER_ID) {
            DataManager.saveToFirestore({
                type: "csvTemplates",
                action: "save",
                templateCount: Object.keys(this.csvTemplates || {}).length,
                message: "CSVãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸ"
            });
        }
    };

    // 8. å•é¡ŒçŠ¶æ…‹ä¿å­˜ã®æ‹¡å¼µ
    const originalSaveQuestionStates = DataManager.saveQuestionStates;
    DataManager.saveQuestionStates = function(bookId, path, states) {
        console.log("âœï¸ å•é¡ŒçŠ¶æ…‹ä¿å­˜ï¼ˆFirebaseçµ±åˆç‰ˆï¼‰");
        originalSaveQuestionStates.call(this, bookId, path, states);
        
        if (ULTRA_STABLE_USER_ID) {
            DataManager.saveToFirestore({
                type: "questionStates",
                action: "save",
                bookId: bookId,
                path: path ? path.join('/') : '',
                stateCount: Object.keys(states || {}).length,
                message: "å•é¡ŒçŠ¶æ…‹ã‚’ä¿å­˜ã—ã¾ã—ãŸ"
            });
        }
    };

    // ğŸ›ï¸ ç®¡ç†ãƒœã‚¿ãƒ³è¿½åŠ  + å…¨ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ‹¡å¼µ
    document.addEventListener('DOMContentLoaded', function() {
        console.log("ğŸ›ï¸ ç®¡ç†ãƒœã‚¿ãƒ³è¿½åŠ  + å…¨ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ‹¡å¼µ");
        
        // ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ‹¡å¼µã‚’å°‘ã—é…å»¶ã—ã¦å®Ÿè¡Œï¼ˆå…¨ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«èª­ã¿è¾¼ã¿å¾Œï¼‰
        setTimeout(() => {
            extendQAModule();
            extendAppModule();
            console.log("âœ… å…¨ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«Firebaseçµ±åˆæ‹¡å¼µå®Œäº†");
        }, 500);
        
        setTimeout(() => {
            const header = document.querySelector('.app-header');
            if (header && ULTRA_STABLE_USER_ID) {
                // æ—¢å­˜ãƒœã‚¿ãƒ³å‰Šé™¤
                const existing = header.querySelector('[data-firebase-btn]');
                if (existing) existing.remove();
                
                // ä¿å­˜ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³
                const testBtn = document.createElement('button');
                testBtn.setAttribute('data-firebase-btn', 'true');
                testBtn.textContent = 'ğŸ”’è¶…å®‰å®š';
                testBtn.style.cssText = `
                    position: absolute;
                    top: 20px;
                    left: 20px;
                    background: linear-gradient(135deg, #9c27b0, #673ab7);
                    border: none;
                    border-radius: 8px;
                    color: white;
                    padding: 8px 12px;
                    cursor: pointer;
                    font-size: 12px;
                    font-weight: bold;
                    box-shadow: 0 3px 15px rgba(156, 39, 176, 0.4);
                    z-index: 1000;
                `;
                testBtn.onclick = function() {
                    const testData = {
                        test: "è¶…å®‰å®šIDãƒ†ã‚¹ãƒˆ_" + Date.now(),
                        message: "ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢å¯¾å¿œãƒ†ã‚¹ãƒˆ",
                        stableId: ULTRA_STABLE_USER_ID,
                        randomValue: Math.random(),
                        testTime: new Date().toISOString()
                    };
                    DataManager.saveToFirestore(testData);
                };
                header.appendChild(testBtn);
                
                // IDæƒ…å ±ãƒœã‚¿ãƒ³
                const infoBtn = document.createElement('button');
                infoBtn.textContent = 'â„¹ï¸';
                infoBtn.style.cssText = `
                    position: absolute;
                    top: 20px;
                    left: 85px;
                    background: rgba(156, 39, 176, 0.8);
                    border: none;
                    border-radius: 50%;
                    color: white;
                    width: 28px;
                    height: 28px;
                    cursor: pointer;
                    font-size: 12px;
                    z-index: 1000;
                `;
                infoBtn.onclick = function() {
                    showIdInfo();
                };
                header.appendChild(infoBtn);
                
                // å…¨ä¿å­˜ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³
                const allSaveBtn = document.createElement('button');
                allSaveBtn.textContent = 'ğŸ’¾';
                allSaveBtn.style.cssText = `
                    position: absolute;
                    top: 20px;
                    left: 118px;
                    background: rgba(76, 175, 80, 0.8);
                    border: none;
                    border-radius: 50%;
                    color: white;
                    width: 28px;
                    height: 28px;
                    cursor: pointer;
                    font-size: 12px;
                    z-index: 1000;
                `;
                allSaveBtn.title = "å…¨ãƒ‡ãƒ¼ã‚¿åŒæœŸãƒ†ã‚¹ãƒˆ";
                allSaveBtn.onclick = function() {
                    performFullDataSync();
                };
                header.appendChild(allSaveBtn);
            }
        }, 1000);
    });

    // ğŸ”§ QAModuleæ‹¡å¼µé–¢æ•°
    function extendQAModule() {
        if (window.QAModule && typeof QAModule.addQuestion === 'function') {
            const originalAddQuestion = QAModule.addQuestion;
            QAModule.addQuestion = function(setName, question, answer) {
                console.log("â“ ä¸€å•ä¸€ç­”è¿½åŠ ï¼ˆFirebaseçµ±åˆç‰ˆï¼‰");
                const result = originalAddQuestion.call(this, setName, question, answer);
                
                if (result && ULTRA_STABLE_USER_ID) {
                    DataManager.saveToFirestore({
                        type: "qaQuestion",
                        action: "add",
                        setName: setName,
                        message: "ä¸€å•ä¸€ç­”ã‚’è¿½åŠ ã—ã¾ã—ãŸ"
                    });
                }
                
                return result;
            };

            const originalDeleteQuestion = QAModule.deleteQuestion;
            QAModule.deleteQuestion = function(setName, questionId) {
                console.log("â“ ä¸€å•ä¸€ç­”å‰Šé™¤ï¼ˆFirebaseçµ±åˆç‰ˆï¼‰");
                const result = originalDeleteQuestion.call(this, setName, questionId);
                
                if (result && ULTRA_STABLE_USER_ID) {
                    DataManager.saveToFirestore({
                        type: "qaQuestion",
                        action: "delete",
                        setName: setName,
                        questionId: questionId,
                        message: "ä¸€å•ä¸€ç­”ã‚’å‰Šé™¤ã—ã¾ã—ãŸ"
                    });
                }
                
                return result;
            };
            
            console.log("âœ… QAModule Firebaseçµ±åˆå®Œäº†");
        }
    }

    // ğŸ”§ App.jså†…ã®å„ç¨®ä¿å­˜å‡¦ç†æ‹¡å¼µ
    function extendAppModule() {
        if (window.App) {
            // å•é¡Œé›†ä½œæˆãƒ»ç·¨é›†ã®æ‹¡å¼µ
            const originalShowNewBookDialog = App.showNewBookDialog;
            if (typeof originalShowNewBookDialog === 'function') {
                // æ–°è¦å•é¡Œé›†ä½œæˆæ™‚ã®Firebaseä¿å­˜ã¯æ—¢ã« DataManager.saveBooksToStorage ã§å¯¾å¿œæ¸ˆã¿
                console.log("âœ… Appå•é¡Œé›†ä½œæˆ Firebaseçµ±åˆæ¸ˆã¿");
            }

            // éšå±¤è¿½åŠ ãƒ»ç·¨é›†ã®æ‹¡å¼µ
            const originalAddHierarchy = App.addHierarchy;
            if (typeof originalAddHierarchy === 'function') {
                // éšå±¤è¿½åŠ æ™‚ã®Firebaseä¿å­˜ã¯æ—¢ã« DataManager.saveBooksToStorage ã§å¯¾å¿œæ¸ˆã¿
                console.log("âœ… Appéšå±¤ç®¡ç† Firebaseçµ±åˆæ¸ˆã¿");
            }
            
            console.log("âœ… Appå…¨ä½“ Firebaseçµ±åˆå®Œäº†");
        }
    }

    // ğŸ”„ å…¨ãƒ‡ãƒ¼ã‚¿åŒæœŸãƒ†ã‚¹ãƒˆ
    function performFullDataSync() {
        if (!ULTRA_STABLE_USER_ID) {
            alert("å›ºå®šIDãŒæœªè¨­å®šã§ã™");
            return;
        }

        const syncData = {
            type: "fullDataSync",
            action: "manual",
            timestamp: new Date().toISOString(),
            dataSnapshot: {
                books: Object.keys(DataManager.books || {}).length,
                records: (DataManager.allRecords || []).length,
                plans: (DataManager.studyPlans || []).length,
                qaQuestions: Object.keys(DataManager.qaQuestions || {}).length,
                csvTemplates: Object.keys(DataManager.csvTemplates || {}).length
            },
            message: "æ‰‹å‹•å…¨ãƒ‡ãƒ¼ã‚¿åŒæœŸå®Ÿè¡Œ"
        };

        DataManager.saveToFirestore(syncData);
        
        // æˆåŠŸé€šçŸ¥
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 140px;
            right: 20px;
            background: linear-gradient(135deg, #ff9800, #f57c00);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(255, 152, 0, 0.3);
            z-index: 9999;
            font-weight: 600;
            animation: slideInRight 0.3s ease;
        `;
        notification.innerHTML = `
            ğŸ”„ å…¨ãƒ‡ãƒ¼ã‚¿åŒæœŸå®Ÿè¡Œï¼<br>
            å•é¡Œé›†: ${syncData.dataSnapshot.books}<br>
            è¨˜éŒ²: ${syncData.dataSnapshot.records}<br>
            è¨ˆç”»: ${syncData.dataSnapshot.plans}
        `;
        document.body.appendChild(notification);
        
        setTimeout(() => notification.remove(), 4000);
    }

    // ğŸ“‹ IDæƒ…å ±è¡¨ç¤º
    function showIdInfo() {
        const info = `ğŸ”’ è¶…å®‰å®šå›ºå®šãƒ¦ãƒ¼ã‚¶ãƒ¼ID

    ç¾åœ¨ã®ID: ${ULTRA_STABLE_USER_ID}

    ä¿å­˜çŠ¶æ³:
    â”œ LocalStorage: ${localStorage.getItem('ultraStableUserId') ? 'âœ…' : 'âŒ'}
    â”œ SessionStorage: ${sessionStorage.getItem('ultraStableUserId') ? 'âœ…' : 'âŒ'}
    â”œ Cookie: ${getCookieValue('ultraStableUserId') ? 'âœ…' : 'âŒ'}
    â”” IndexedDB: ä¿å­˜æ¸ˆã¿

    ã“ã®IDã®ç‰¹å¾´:
    â€¢ å®Œå…¨å›ºå®šï¼ˆæ™‚é–“è¦ç´ ãªã—ï¼‰
    â€¢ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢å¯¾å¿œ
    â€¢ è¤‡æ•°ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸è‡ªå‹•å¾©å…ƒ
    â€¢ Firebaseæ—¢å­˜ãƒ‡ãƒ¼ã‚¿æ¤œç´¢

    ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢å¾Œã‚‚å®‰å…¨ã«å¾©å…ƒã•ã‚Œã¾ã™ï¼`;

        alert(info);
    }

    // ğŸ¨ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¿½åŠ 
    const style = document.createElement('style');
    style.textContent = `
    @keyframes slideInRight {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    `;
    document.head.appendChild(style);

    // ğŸ§¹ ãƒªã‚»ãƒƒãƒˆæ©Ÿèƒ½ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
    window.resetUltraStableId = function() {
        if (confirm('è¶…å®‰å®šIDã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ\n\nâš ï¸æ–°ã—ã„IDãŒç”Ÿæˆã•ã‚Œã¾ã™')) {
            localStorage.removeItem('ultraStableUserId');
            sessionStorage.removeItem('ultraStableUserId');
            setCookie('ultraStableUserId', '', -1);
            location.reload();
        }
    };

    // ãƒ‡ãƒãƒƒã‚°ç”¨é–¢æ•°ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«
    window.showIdInfo = showIdInfo;
    window.ULTRA_STABLE_USER_ID = ULTRA_STABLE_USER_ID;

    console.log("ğŸ”’ è¶…å®‰å®šFirebaseçµ±åˆå®Œäº†");
    console.log("ğŸ†” ç¾åœ¨ã®ID:", ULTRA_STABLE_USER_ID);
    console.log("ğŸ› ï¸ ãƒ‡ãƒãƒƒã‚°: showIdInfo(), resetUltraStableId()");
    </script>
</body>
</html>
